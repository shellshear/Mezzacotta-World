// Version of Mezzacotta World
function MW_Config(){this.showServerTransations=!0}function ajax_get(e,t){var n=null;window.XMLHttpRequest?n=new XMLHttpRequest:n=new ActiveXObject("Microsoft.XMLHTTP");if(n!=null){function r(){n.readyState==4&&n.status==200&&t(n.responseXML.documentElement,n.responseXML)}n.open("GET",e,!0),n.onreadystatechange=r,n.send(null)}}function ajax_post(e,t,n){if(window.XMLHttpRequest){var r=new XMLHttpRequest;function i(){r.readyState==4&&r.status==200&&t(r.responseXML.documentElement,r.responseXML)}r.open("POST",e,!0),r.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n!=null&&r.setRequestHeader("Content-length",n.length),r.setRequestHeader("Connection","close"),r.onreadystatechange=i,r.send(n)}}function htmlspecialchars(e){var t="";for(i=0;i<e.length;i++)switch(e[i]){case"<":t+="&lt;";break;case">":t+="&gt;";break;case'"':t+="&quot;";break;case"'":t+="&#039;";break;case"&":t+="&amp;";break;default:t+=e[i]}return t}function htmlspecialchars_decode(e){return e.toString().replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&#0*39;/g,"'").replace(/&quot;/g,'"').replace(/&amp;/g,"&")}function createXMLDoc(e){var t=null;return document.implementation&&document.implementation.createDocument?t=document.implementation.createDocument(null,e,null):(t=new ActiveXObject("MSXML2.DOMDocument"),t.loadXML("<"+e+"/>")),t}function ActionObject(){this.src="ActionObject",this.actionListeners=[],this.resizeListeners=[]}function SVGElement(e,t,n){SVGElement.baseConstructor.call(this),this.src=e,e!=null&&(this.svg=document.createElementNS(svgns,e)),this.showing=!0,this.childNodes=[],this.firstChild=null,this.lastChild=null,this.parentNode=null,this.tnode=null,this.addAttributes(t),n&&(this.tnode=document.createTextNode(n),this.svg.appendChild(this.tnode))}function wrapElementById(e){result=null;var t=document.getElementById(e);return t!=null&&(result=new SVGElement,result.wrapElement(t)),result}function cloneElementById(e,t){result=null;var n=e.getElementById(t);return n!=null&&(result=new SVGElement,result.cloneElement(n)),result}function replaceClipPaths(e){if(e.nodeType!=1)return;for(var t=0;t<e.children.length;t++){var n=e.children[t],r=replaceClipPaths(n);r!=n&&(e.insertBefore(r,n),e.removeChild(n))}if(e.nodeName=="svg"&&e.width!=null&&e.height!=null){var i=document.createElementNS(svgns,"rect");return i.setAttribute("x",e.getAttribute("x")),i.setAttribute("y",e.getAttribute("y")),i.setAttribute("width",e.getAttribute("width")),i.setAttribute("height",e.getAttribute("height")),i.setAttribute("stroke","none"),i}return e}function SVGRoot(e){this.clipBox=e,this.clipBox==null&&(this.clipBox={}),this.clipBox.x==null&&(this.clipBox.x=0),this.clipBox.y==null&&(this.clipBox.y=0),this.clipBox.width==null&&(this.clipBox.width=0),this.clipBox.height==null&&(this.clipBox.height=0),SVGComponent.baseConstructor.call(this,"svg",this.clipBox)}function SVGComponent(e,t){SVGComponent.baseConstructor.call(this,"g"),this.src="SVGComponent",this.hasFocus=!1,this.background=null,this.focusListeners=[],this.focusManager=null,this.auxiliaryComponents=[],this.scale=1,this.setPosition(e,t)}function setLightLevel(e,t,n){adjustAttribute("fill",e,t,n),adjustAttribute("stroke",e,t,n),adjustAttribute("stop-color",e,t,n);if(e.nodeName=="linearGradient"||e.nodeName=="radialGradient"){var r=e.getAttributeNS(xlinkns,"href");if(r!=null&&r!=""){var i=null,s=e.getAttribute(n+"orig_href");if(s==null){e.setAttributeNS(xlinkns,n+"orig_href",r);var o=r.substring(1),u=document.getElementById(o);if(u!=null){cloneEl=u.cloneNode(!0);var a=n+"copy_"+o;cloneEl.setAttribute("id",a),e.setAttributeNS(xlinkns,"href","#"+a),i=cloneEl,u.parentElement.insertBefore(cloneEl,u)}}else i=document.getElementById(r.substring(1));setLightLevel(i,t,n)}}var f=e.getAttribute("style");if(f!=null){var l=e.getAttribute(n+"orig_style");l!=null&&(f=l);var c=f.split(";"),h=!1;for(var p=0;p<c.length;++p){var d=c[p].split(":"),v=d[0].replace(/\s+/g,"").toLowerCase();if(v=="fill"||v=="stroke"||v=="stop-color")currStyleElValue=adjustLightLevel(d[1],t,n),c[p]=v+":"+currStyleElValue,h=!0}if(h){e.setAttribute(n+"orig_style",f);var m="";for(var p=0;p<c.length;++p)m+=c[p]+";";e.setAttribute("style",m)}}for(var p=0;p<e.children.length;++p)setLightLevel(e.children[p],t,n)}function adjustAttribute(e,t,n,r){var i=t.getAttribute(e);if(i!=null&&i!="none"){var s=t.getAttribute(r+"orig_"+e);s==null?t.setAttribute(r+"orig_"+e,i):i=s,i=adjustLightLevel(i,n,r),t.setAttribute(e,i)}}function adjustLightLevel(e,t,n){e=e.replace(/\s+/g,"");if(e=="none")return e;var r=0,i=0,s=0;if(e[0]=="#")e.length==4?(r=parseInt(e[1],16)*17,i=parseInt(e[2],16)*17,s=parseInt(e[3],16)*17):e.length==7&&(r=parseInt(e.substr(1,2),16),i=parseInt(e.substr(3,2),16),s=parseInt(e.substr(5,2),16));else if(e.toLowerCase().indexOf("rgb(")==0){var o=e.split(",");r=parseInt(o[0].substr(4)),i=parseInt(o[1]),s=parseInt(o[2])}else{if(e.toLowerCase().indexOf("url(#")==0){var u=e.substring(5,e.length-1),a=document.getElementById(u),f=n+"copy_"+u,l=document.getElementById(f);return l==null&&(l=a.cloneNode(!0),l.setAttribute("id",f),a.parentElement.insertBefore(l,a)),setLightLevel(l,t,n),"url(#"+f+")"}result=gNamedColorList[e.toLowerCase()],result!=null&&(r=result[0],i=result[1],s=result[2])}return t.r!=null&&t.r>=0&&t.r<=2&&(t.r<=1?r=Math.floor(r*t.r):r=Math.floor(r+(255-r)*(t.r-1))),t.g!=null&&t.g>=0&&t.g<=2&&(t.g<=1?i=Math.floor(i*t.g):i=Math.floor(i+(255-i)*(t.g-1))),t.b!=null&&t.b>=0&&t.b<=2&&(t.b<=1?s=Math.floor(s*t.b):s=Math.floor(s+(255-s)*(t.b-1))),"rgb("+r+","+i+","+s+")"}function SimpleButton(e,t,n,r,i,s){SimpleButton.baseConstructor.call(this,r,i),this.src=e,this.states=s,this.states==null&&(this.states={}),this.states.focus==null&&(this.states.focus=this.states.normal),this.states.over==null&&(this.states.over=this.states.normal),this.states.select==null&&(this.states.select=this.states.normal),this.states.disable==null&&(this.states.disable=this.states.normal),this.svg_border=new SVGElement(t,n),this.svg_border.addAttributes(this.states.normal),this.appendChild(this.svg_border),this.svg_buttonCover=new SVGElement(t,n),this.svg_buttonCover.addAttributes({fill:"white","fill-opacity":0,stroke:"none"}),this.svg_buttonCover.addEventListener("click",this,!1),this.svg_buttonCover.addEventListener("mouseover",this,!1),this.svg_buttonCover.addEventListener("mouseout",this,!1),this.svg_buttonCover.addEventListener("mouseup",this,!1),this.svg_buttonCover.addEventListener("mousedown",this,!1),this.appendChild(this.svg_buttonCover),this.isAble=!0,this.doToggle=!1,this.toggleState=!1,this.addActionListener(this)}function ParamButton(e,t,n,r,i,s,o,u){ParamButton.baseConstructor.call(this,t,n),this.src=e,this.svg_bg=r,this.appendChild(this.svg_bg),this.svg_contents=null,this.svg_mouseover=i,this.svg_mouseover.hide(),this.appendChild(this.svg_mouseover),this.svg_select=s,this.svg_select.hide(),this.appendChild(this.svg_select),this.doSeparateCoverLayer=u,this.svg_cover=o,this.svg_cover.addEventListener("click",this,!1),this.svg_cover.addEventListener("mouseover",this,!1),this.svg_cover.addEventListener("mouseout",this,!1),this.svg_cover.addEventListener("mouseup",this,!1),this.svg_cover.addEventListener("mousedown",this,!1);if(this.doSeparateCoverLayer){var a=new SVGComponent(t,n);a.appendChild(this.svg_cover),this.addAuxiliaryComponent(a)}else this.appendChild(this.svg_cover);this.isAble=!0,this.doToggle=!1,this.toggleState=!1,this.addActionListener(this)}function ParamButton2(e,t){this.params=t;var n=0,r=0;t.x&&(n=t.x),t.y&&(r=t.y),ParamButton.baseConstructor.call(this,n,r),this.params.normalElements==null&&(this.params.normalElements={},this.params.normalElements.normal=new SVGElement("rect",{width:10,height:10,rx:2,stroke:"black",fill:"none"})),this.params.selectedElements==null&&(this.params.selectedElements={});if(t.width!=null||t.height!=null){for(var i in this.params.normalElements)this.params.normalElements[i]!=null&&(this.params.normalElements[i]=new ScaledComponent(0,0,this.params.normalElements[i],this.params.width,this.params.height));for(var i in this.params.selectedElements)this.params.selectedElements[i]!=null&&(this.params.selectedElements[i]=new ScaledComponent(0,0,this.params.selectedElements[i],this.params.width,this.params.height))}this.src=e,this.isSelected=!1,this.isDisabled=!1,this.doToggle=!1,this.appearance=null,this.updateAppearance(),this.cover=null,this.updateCover(),this.addActionListener(this),this.params.normalElements&&this.params.normalElements.cover&&(this.params.normalElements.cover.svg.addEventListener("click",this,!1),this.params.normalElements.cover.svg.addEventListener("mouseover",this,!1),this.params.normalElements.cover.svg.addEventListener("mouseout",this,!1),this.params.normalElements.cover.svg.addEventListener("mouseup",this,!1),this.params.normalElements.cover.svg.addEventListener("mousedown",this,!1)),this.params.selectedElements&&this.params.selectedElements.cover&&(this.params.selectedElements.cover.svg.addEventListener("click",this,!1),this.params.selectedElements.cover.svg.addEventListener("mouseover",this,!1),this.params.selectedElements.cover.svg.addEventListener("mouseout",this,!1),this.params.selectedElements.cover.svg.addEventListener("mouseup",this,!1),this.params.selectedElements.cover.svg.addEventListener("mousedown",this,!1))}function getParamButtonIdSet(e){return{x:0,y:0,normalElements:{normal:cloneElementById(document,e+"Normal"),mouseover:cloneElementById(document,e+"NormalOver"),cover:cloneElementById(document,e+"Cover")},selectedElements:{normal:cloneElementById(document,e+"Selected"),mouseover:cloneElementById(document,e+"SelectedOver"),cover:cloneElementById(document,e+"Cover")}}}function makeSimpleCheckboxParamButtonIdSet(){var e=new SVGElement("rect",{width:10,height:10,rx:2,stroke:"black",fill:"none"}),t=new SVGElement("rect",{width:10,height:10,rx:2,stroke:"red",fill:"none"}),n=new SVGElement("rect",{width:10,height:10,rx:2,stroke:"none",fill:"white",opacity:0}),r=new SVGElement("g");r.appendChild(new SVGElement("rect",{width:10,height:10,rx:2,stroke:"black",fill:"none"})),r.appendChild(new SVGElement("path",{d:"M2,2L8,8M8,2L2,8",stroke:"black",fill:"black"}));var i=new SVGElement("g");i.appendChild(new SVGElement("rect",{width:10,height:10,rx:2,stroke:"red",fill:"none"})),i.appendChild(new SVGElement("path",{d:"M2,2L8,8M8,2L2,8",stroke:"red",fill:"none"}));var s=new SVGElement("rect",{width:10,height:10,rx:2,stroke:"none",fill:"white",opacity:0});return{x:0,y:0,normalElements:{normal:e,mouseover:t,cover:n},selectedElements:{normal:r,mouseover:i,cover:s}}}function RadioButtonGroup(){this.buttons=[],this.currentSelection=null}function ScaledComponent(e,t,n,r,i){ScaledComponent.baseConstructor.call(this,e,t),this.width=r,this.height=i,this.contentElement=new SVGComponent(0,0),this.appendChild(this.contentElement),this.setContents(n)}function RectLabel(e,t,n,r,i){RectLabel.baseConstructor.call(this,e,t),this.rectAttributes=r,this.borderWidth=i,this.borderWidth==null&&(this.borderWidth=0),this.contentElement=new SVGComponent(0,0),this.contentHolder=new SVGComponent(i,i),this.contentHolder.appendChild(this.contentElement),this.isWidthSpecified=this.rectAttributes.width!=null,this.isHeightSpecified=this.rectAttributes.height!=null,this.bgRect=new SVGElement("rect",this.rectAttributes),this.appendChild(this.bgRect),this.appendChild(this.contentHolder),this.setContents(n)}function RectButton(e,t,n,r,i,s,o,u,a){this.mouseoverAttributes=s,this.selectAttributes=o,this.bgElement=new RectLabel(0,0,r,i,u),this.mouseoverElement=new SVGElement("rect"),this.selectElement=new SVGElement("rect"),this.coverElement=new SVGElement("rect"),this.setContents(r),RectButton.baseConstructor.call(this,e,t,n,this.bgElement,this.mouseoverElement,this.selectElement,this.coverElement,a)}function Background(){Background.baseConstructor.call(this),this.src="Background",this.focus=null}function TextArea(e,t,n,r,i,s,o){TextArea.baseConstructor.call(this,e,"rect",n,i,s,o),this.src=e,this.setBackground(t),this.textVal="",this.secretVal="";var u={x:0,y:0};n.width!=null&&(u.width=n.width,this.textBoxWidth=u.width),n.height!=null&&(u.height=n.height),this.textBox=new SVGElement("svg",u),this.appendChild(this.textBox),this.textNodeHolder=new SVGElement("g"),this.textBox.appendChild(this.textNodeHolder),this.textNode=new SVGElement("text",r," "),this.textNode.setAttributeNS(xmlns,"space","preserve"),this.textNodeHolder.appendChild(this.textNode),this.cursor=new SVGElement("rect",{x:5,y:3,width:2,height:20,stroke:"none",fill:"red"});var a=new SVGElement("set",{id:"textCursorBlink2",attributeName:"visibility",attributeType:"CSS",to:"hidden",begin:"0.5s;textCursorBlink2.end + 0.5s",dur:"0.5s"});this.cursor.appendChild(a),this.cursor.hide(),this.textNodeHolder.appendChild(this.cursor)}function MultilineText(e,t,n,r,i){MultilineText.baseConstructor.call(this,e,t);var s=n.split(" ");if(i==null||i.maxWidth==null)return null;var o=[],u=0;while(u<s.length){var a=s[u],f=a,l=new SVGElement("text",r,f);o.push(l);while(l.getBBox().width<=i.maxWidth){a=f,u++;if(u>=s.length)break;f=a+" "+s[u],l.setValue(f)}u<s.length&&(l.setValue(a),a==f&&u++)}var c=parseInt(r["font-size"]),h=o.length*c+(o.length-1)*c*i.lineSpacing;for(var u=0;u<o.length;u++){var p=o[u].getBBox().width;o[u].setAttribute("x",-p/2),o[u].setAttribute("y",-h/2+u*(c+c*i.lineSpacing)+c/2),this.appendChild(o[u])}}function FlowLayout(e,t,n){this.layoutParams=n,this.layoutParams==null&&(this.layoutParams={}),this.layoutParams.direction==null&&(this.layoutParams.direction="right"),this.layoutParams.minSpacing==null&&(this.layoutParams.minSpacing=0),this.layoutParams.spacing=this.layoutParams.minSpacing,this.layoutParams.minWidth==null&&(this.layoutParams.minWidth=0),this.layoutParams.flowAlignment==null&&(this.layoutParams.flowAlignment="left"),this.layoutParams.orthogonalAlignment==null&&(this.layoutParams.orthogonalAlignment="top"),FlowLayout.baseConstructor.call(this,e,t),this.currentX=0,this.currentY=0,this.childLengthSum=0,this.maxOrthogonal=0}function TextLabel(e,t,n){this.layoutParams=n,n==null&&(n={}),n.direction==null&&(n.direction="down");var r=0;t!=null&&t["font-size"]!=null&&(r=t["font-size"]),TextLabel.baseConstructor.call(this,0,r,n),this.textAttributes=t,this.setValue(e)}function DragNDropHandler(){this.dragObject=null,this.offsetX=0,this.offsetY=0}function dragndrop_Start(e,t,n,r){g_dragndrop&&g_dragndrop.dragstart(e,t,n,r)}function dragndrop_Move(e){g_dragndrop&&g_dragndrop.dragmove(e)}function dragndrop_End(e){g_dragndrop&&g_dragndrop.dragend(e)}function Slider(e){this.params=e,this.params||(this.params=[]),this.params.orientation||(this.params.orientation="h");if(!this.params.sliderWidth||isNaN(this.params.sliderWidth))this.params.sliderWidth=10;if(!this.params.sliderLength||isNaN(this.params.sliderLength))this.params.sliderLength=200;if(!this.params.draggerWidth||isNaN(this.params.draggerWidth))this.params.draggerWidth=10;if(!this.params.draggerHeight||isNaN(this.params.draggerHeight))this.params.draggerHeight=20;this.params.sliderColor||(this.params.sliderColor="gray"),this.params.draggerColor||(this.params.draggerColor="white"),!this.params.startPosition||isNaN(this.params.startPosition)?this.params.startPosition=0:this.params.startPosition>1?this.params.startPosition=1:this.params.startPosition<0&&(this.params.startPosition=0);var t,n,r,i=0,s=0,o=0,u=0,a=0,f=0;e.orientation=="h"?(t="right",s=this.params.sliderWidth,i=this.params.sliderLength,u=this.params.draggerHeight,o=this.params.draggerWidth,f=this.params.sliderWidth<this.params.draggerHeight?(this.params.draggerHeight-this.params.sliderWidth)/2:0):(t="down",i=this.params.sliderWidth,s=this.params.sliderLength,o=this.params.draggerHeight,u=this.params.draggerWidth,a=this.params.sliderWidth<this.params.draggerHeight?(this.params.draggerHeight-this.params.sliderWidth)/2:0),Slider.baseConstructor.call(this,0,0),this.slider=new SVGComponent(0,0),this.scrollBg=new RectButton("scrollBG",a,f,null,{fill:this.params.sliderColor,stroke:"black",width:i,height:s},{opacity:0},{opacity:0},4,!1),this.scrollBg.addActionListener(this),this.scrollTop=new RectButton("scrollDragger",0,0,null,{fill:this.params.draggerColor,stroke:"black",width:o,height:u},{fill:"blue"},{fill:"blue"},4,!1),this.scrollTop.addActionListener(this),this.slider.appendChild(this.scrollBg),this.slider.appendChild(this.scrollTop),this.appendChild(this.slider),this.setSliderPosition(this.params.startPosition)}function Scrollbar(e){this.params=e,this.params||(this.params=[]);var t,n,r,i=0,s=0;e.orientation=="h"?(t="right",n=new SVGElement("path",{d:"M0,0L0,20L-14,10z",fill:"blue"}),r=new SVGElement("path",{d:"M0,0L0,20L14,10z",fill:"blue"}),s=e.width):(t="down",n=new SVGElement("path",{d:"M0,0L20,0L10,-14z",fill:"blue"}),r=new SVGElement("path",{d:"M0,0L20,0L10,14z",fill:"blue"}),i=e.width),Scrollbar.baseConstructor.call(this,0,0,{direction:t}),this.backButton=new RectButton("backButton",0,0,n,{fill:"white",stroke:"black",rx:2,width:e.width,height:e.width},{fill:"blue"},{fill:"blue"},4,!1),this.backButton.addActionListener(this),this.appendChild(this.backButton),this.scrollbar=new SVGComponent(0,0),this.scrollBg=new SVGElement("rect",{x:0,y:0,width:i,height:s,fill:"gray",stroke:"black"}),this.scrollTop=new RectButton("scrollDragger",0,0,null,{fill:"white",stroke:"black",width:i,height:s},{fill:"blue"},{fill:"blue"},4,!1),this.scrollTop.addActionListener(this),this.scrollbar.appendChild(this.scrollBg),this.scrollbar.appendChild(this.scrollTop),this.appendChild(this.scrollbar),this.fwdButton=new RectButton("fwdButton",0,0,r,{fill:"white",stroke:"black",rx:2,width:e.width,height:e.width},{fill:"blue"},{fill:"blue"},4,!1),this.fwdButton.addActionListener(this),this.appendChild(this.fwdButton),this.position=0,this.scrollbarLength=0,this.dragbarLength=0}function ScrollbarRegion(e,t){ScrollbarRegion.baseConstructor.call(this,0,0),this.params=e,this.params.scrollbarWidth==null&&(this.params.scrollbarWidth=10),this.params.scrollbarGap==null&&(this.params.scrollbarGap=3),this.params.width==null&&(this.params.width=100),this.params.height==null&&(this.params.height=100),this.scroll_x=0,this.scroll_y=0,this.params.rectBorder!=null&&(this.rectBorder=new SVGElement("rect",this.params.rectBorder),this.appendChild(this.rectBorder)),this.mask=new SVGRoot({width:e.width,height:e.height}),this.contents=new SVGComponent(0,0),this.contents.appendChild(t),this.mask.appendChild(this.contents),this.appendChild(this.mask),this.hBar=new Scrollbar({orientation:"h",width:this.params.scrollbarWidth}),this.appendChild(this.hBar),this.hBar.addActionListener(this),this.vBar=new Scrollbar({orientation:"v",width:this.params.scrollbarWidth}),this.appendChild(this.vBar),this.vBar.addActionListener(this),this.refreshLayout()}function SVGWindow(e,t,n,r){this.windowName=e,this.windowParams=r,this.borderWidth=t,this.windowParams==null&&(this.windowParams=[]),this.windowParams.width==null&&(this.windowParams.width=200),this.windowParams.height==null&&(this.windowParams.height=200),this.windowParams.titleBarHeight==null&&(this.windowParams.titleBarHeight=16),this.windowParams.statusBarHeight==null&&(this.windowParams.statusBarHeight=10),this.windowParams.titleBarGap==null&&(this.windowParams.titleBarGap=2),this.windowParams.scrollbarWidth==null&&(this.windowParams.scrollbarWidth=20),this.windowParams.contentsSpacing==null&&(this.windowParams.contentsSpacing=0),this.windowParams.allowUserResize==null&&(this.windowParams.allowUserResize=!1);var i=0,s=0;if(this.windowParams.storePrefix&&window.localStorage){i=localStorage.getItem(this.windowParams.storePrefix+"_x");if(i==null||i<0)i=0;s=localStorage.getItem(this.windowParams.storePrefix+"_y");if(s==null||s<0)s=0}SVGWindow.baseConstructor.call(this,i,s),this.resizeHandler=new Object,this.resizeHandler.owner=this,this.resizeHandler.startX=this.x,this.resizeHandler.startY=this.y,this.resizeHandler.startWidth=0,this.resizeHandler.startHeight=0,this.resizeHandler.setDragPosition=function(e,t){this.owner.isDragging=!0,this.owner.windowParams.width=this.startWidth+(e-this.startX),this.owner.windowParams.height=this.startHeight+(t-this.startY);var n=this.owner.windowParams.scrollbarWidth*3+this.owner.windowParams.titleBarHeight+this.owner.windowParams.statusBarHeight;this.owner.windowParams.height<n&&(this.owner.windowParams.height=n);var r=this.owner.windowParams.scrollbarWidth*3;this.owner.windowParams.width<r&&(this.owner.windowParams.width=r),this.owner.refreshLayout()},this.resizeHandler.setDragEnd=function(e,t){this.owner.isDragging=!1,this.owner.windowStatusText.setValue("")},this.bgRect=new SVGElement("rect",n),this.appendChild(this.bgRect),this.bgRect.addEventListener("mousedown",this.bgRect,!1),this.bgRect.addActionListener(this),this.titleBar=new FlowLayout(0,0,{flowAlignment:"justify"});var o=this.windowParams.titleBarHeight-2*this.windowParams.titleBarGap;this.windowTitle=new RectButton("dragWindow",0,0,new SVGElement("text",{y:o,"font-size":o},this.windowName),{fill:"white",stroke:"none",rx:2,width:20,height:this.windowParams.titleBarHeight},{fill:"orange"},{fill:"red"},this.windowParams.titleBarGap,!1),this.titleBar.appendChild(this.windowTitle),this.windowTitle.svg_cover.addEventListener("mousemove",this.windowTitle,!1),this.windowTitle.addActionListener(this);var u="M0,0 L"+o+","+o+" M0,"+o+" L"+o+",0";this.closeButton=new RectButton("closeWindow",0,0,new SVGElement("path",{d:u,stroke:"black",x:0,y:10}),{fill:"white",stroke:"red",rx:2},{fill:"orange"},{fill:"red"},this.windowParams.titleBarGap,!1),this.titleBar.appendChild(this.closeButton),this.closeButton.addActionListener(this),this.statusBar=new FlowLayout(0,0,{}),this.windowStatusText=new SVGElement("text",{y:o,fill:"black","font-size":o},""),this.windowStatus=new RectLabel(0,0,this.windowStatusText,{fill:"white",stroke:"none",opacity:"0",width:"100",height:this.windowParams.statusBarHeight},0),this.statusBar.appendChild(this.windowStatus);var a=new SVGElement("path",{d:"M9,3.5 L3.5,9 M9,6 L6,9 M9,8 L8,9",fill:"gray",stroke:"black","stroke-width":"0.6"}),f=new SVGElement("path",{d:"M10,0 L10,10 0,10 0,0z",fill:"white",opacity:"0"});this.resizeButton=new ParamButton2("resizeWindow",{x:0,y:0,width:10,height:10,normalElements:{normal:a,cover:f}}),this.resizeButton.addActionListener(this),this.statusBar.appendChild(this.resizeButton),this.contents=new FlowLayout(0,0,{direction:"down",minSpacing:this.windowParams.contentsSpacing}),this.scrollbarRegion=new ScrollbarRegion({width:100,height:100,scrollbarWidth:this.windowParams.scrollbarWidth},this.contents),this.windowContents=new FlowLayout(0,0,{direction:"down",flowAlignment:"justify",minSpacing:3}),this.windowContents.appendChild(this.titleBar),this.windowContents.appendChild(this.scrollbarRegion),this.appendChild(this.windowContents),this.appendChild(this.statusBar),this.fgRect=new SVGElement("rect",n),this.fgRect.setAttribute("opacity","0.3"),this.fgRect.setAttribute("fill","black"),this.fgRect.hide(),this.appendChild(this.fgRect),this.refreshLayout()}function SVGWindowManager(){SVGWindowManager.baseConstructor.call(this,0,0)}function ItemContainer(){ItemContainer.baseConstructor.call(this),this.myItems=[],this.owner=null}function ViewItemContainer(e,t,n,r){ViewItemContainer.baseConstructor.call(this,e,t),this.rootContainer=this,this.parentContainer=null,this.modelItem=n,this.viewItemFactory=r,this.containedItems=new SVGElement("g"),this.appendChild(this.containedItems),this.auxGroup=new SVGElement("g")}function GridModel(e){GridModel.baseConstructor.call(this),this.src="GridModel",this.xmlDoc=createXMLDoc("m"),this.xmlModel=this.xmlDoc.firstChild,this.gridData={},this.moveableItems=[],this.itemIdIndex=0,this.itemIdList=[],this.itemFactory=e,this.quadList=[{x:1,y:1},{x:-1,y:1},{x:-1,y:-1},{x:1,y:-1}],this.adjList=[{x:1,y:0,inFront:!1,side:0},{x:0,y:1,inFront:!0,side:1},{x:-1,y:0,inFront:!0,side:0},{x:0,y:-1,inFront:!1,side:1}],this.showInvisible=!1}function GridContents(e,t,n){GridContents.baseConstructor.call(this),this.src="GridContents",this.model=e,this.x=t,this.y=n,this.seenBy=[],this.tempParams={}}function GridItem(e){GridItem.baseConstructor.call(this),this.src="GridItem",this.params=e==null?{}:e,this.params.saveVals={},this.params.ht==null&&(this.params.ht=0),this.params.elev==null&&(this.params.elev=0),this.params.blockView==null&&(this.params.blockView=!1),this.params.povRange==null&&(this.params.povRange=0),this.params.isTemporary==null&&(this.params.isTemporary=!1),this.params.canStandOn==null&&(this.params.canStandOn=!1),this.params.isInvisible==null&&(this.params.isInvisible=!1),this.params.isHighlighted==null&&(this.params.isHighlighted=!1),this.params.itemTags==null&&(this.params.itemTags=[]),this.cellContents=null,this.canSee={},this.dirns=["r","b","l","f"];for(var t=0;t<this.params.itemTags.length;++t)this.setItemTagParam(this.params.itemTags[t])}function GridViewItem(e,t,n){GridViewItem.baseConstructor.call(this,0,0,e,t),this.itemGraphics=new SVGElement("g"),this.insertBefore(this.itemGraphics,this.containedItems),this.appendItemContents(n),e.params.speech!=null&&this.doSpeech(e.params.speech)}function GridViewContents(e,t,n,r,i,s,o){this.view=e,this.modelContents=s,this.x_index=r,this.y_index=i,GridViewContents.baseConstructor.call(this,"gridCell",t,n,this.button_bg,this.button_mouseover,this.button_select,this.button_cover,o),this.viewItems=new ViewItemContainer(0,0,s,this.view.itemFactory),this.viewItems.rootContainer=this,this.setContents(this.viewItems);if(o){var u=new SVGComponent(t,n);u.appendChild(this.viewItems.auxGroup),this.addAuxiliaryComponent(u)}this.viewItems.updateChildrenFromModel(),this.modelContents.addActionListener(this.viewItems),this.modelContents.addActionListener(this)}function GridView(e,t,n,r,i,s,o,u){this.cellWidth=o,this.cellHeight=u,this.setCellCentre(i,s),this.setViewCentre(187,165),this.setViewSize(375,330),GridView.baseConstructor.call(this,{width:375,height:330}),this.itemFactory=t,this.transformLayer=new SVGElement("g"),this.appendChild(this.transformLayer),this.objectLayer=new SVGElement("g"),this.transformLayer.appendChild(this.objectLayer),this.coverLayer=new SVGElement("g"),this.transformLayer.appendChild(this.coverLayer),this.coverLayer2=new SVGElement("g"),this.transformLayer.appendChild(this.coverLayer2),this.view=[],this.z_list=[],this.gridModel=e,this.setFixedCellCount(8),this.updateView()}function ContentFactory(){}function LitGridModel(e){LitGridModel.baseConstructor.call(this,e)}function LitGridContents(e,t,n,r){LitGridContents.baseConstructor.call(this,e,t,n),this.ambientLight=r}function LitGridItem(e){LitGridItem.baseConstructor.call(this,e)}function LitGridViewItem(e,t,n){LitGridViewItem.baseConstructor.call(this,e,t,n),this.setLighting()}function LitGridViewContents(e,t,n,r,i,s,o){LitGridViewContents.baseConstructor.call(this,e,t,n,r,i,s,o)}function LitGridView(e,t,n,r,i,s,o,u){LitGridView.baseConstructor.call(this,e,t,n,r,i,s,o,u)}function LitContentFactory(e){LitContentFactory.baseConstructor.call(this),this.ambientLight=e}function ShadowElement(e,t,n){ShadowElement.baseConstructor.call(this,"g"),this.setBaseElement(e),this.showInvisible=t,this.showInvisible||this.hide(),this.showInvisibleHidden=n,this.shadowID=gShadowElementIdIndex++,this.isVisible=!0}function HexGridModel(e,t){HexGridModel.baseConstructor.call(this,e,t)}function HexGridView(e,t,n,r,i,s,o,u){HexGridView.baseConstructor.call(this,e,t,n,r,i,s,o,u)}function RectGridModel(e,t){RectGridModel.baseConstructor.call(this,e,t)}function RectGridView(e,t,n,r,i,s,o,u){RectGridView.baseConstructor.call(this,e,t,n,r,i,s,o,u)}function getTopBlockItem(e){var t=null,n=e;while(n.myItems.length>0){for(var r in n.myItems)if(n.myItems[r].params.isBlock)break;if(!n.myItems[r].params.isBlock)break;n=n.myItems[r]}return n.params!=null&&n.params.isBlock&&(t=n),t}function PerspectiveGridModel(e){PerspectiveGridModel.baseConstructor.call(this,e),this.itemsInTheWay=[]}function PerspectiveGridContents(e,t,n,r){PerspectiveGridContents.baseConstructor.call(this,e,t,n,r)}function PerspectiveGridItem(e){PerspectiveGridItem.baseConstructor.call(this,e)}function PerspectiveGridView(e,t,n,r,i,s,o,u){PerspectiveGridView.baseConstructor.call(this,e,t,n,r,i,s,o,u),this.extraBottomRows=4,this.adjustCellBounds()}function PerspectiveGridViewContents(e,t,n,r,i,s,o){this.button_bg=new SVGElement("path",{d:"M -25,0 0,-15 25,0 0,15 -25,0 z",fill:"none",stroke:"black"}),this.button_mouseover=new SVGComponent(0,0);var u=new SVGElement("path",{d:"m 16.424175,0 a 16.424175,9.4351654 0 1 1 -32.84835,0 16.424175,9.4351654 0 1 1 32.84835,0 z",opacity:"0.6",fill:"#ff2a2a",stroke:"none"});this.button_mouseover.appendChild(u),this.button_select=new SVGElement("path",{d:"M -25,0 0,-15 25,0 0,15 -25,0 z",fill:"#ff2a2a","fill-opacity":"0.56",stroke:"black"}),this.button_cover=new SVGElement("path",{d:"M -25,0 0,-15 25,0 0,15 -25,0 z",fill:"white",opacity:"0",stroke:"none"}),PerspectiveGridViewContents.baseConstructor.call(this,e,t,n,r,i,s,o)}function PerspectiveGridViewItem(e,t,n){this.elements=n,PerspectiveGridViewItem.baseConstructor.call(this,e,t,this.elements.bottom),this.appendItemContents(this.elements.top),this.appendItemContents(this.elements.left),this.appendItemContents(this.elements.front),this.elements.highlight&&(this.elements.highlight.hide(),this.appendItemContents(this.elements.highlight))}function BlockGridViewItem(e,t,n){BlockGridViewItem.baseConstructor.call(this,e,t,n)}function SimpleBlockGridViewItem(e,t,n){SimpleBlockGridViewItem.baseConstructor.call(this,0,0),this.itemViewFactory=e,this.topRect=new SVGElement("path",{d:this.itemViewFactory.baseRect,fill:this.itemViewFactory.baseSummary[t][1],stroke:"none"}),this.appendChild(this.topRect),this.leftRect=new SVGElement("path",{fill:this.itemViewFactory.baseSummary[t][2],stroke:"none"}),this.appendChild(this.leftRect),this.frontRect=new SVGElement("path",{fill:this.itemViewFactory.baseSummary[t][3],stroke:"none"}),this.appendChild(this.frontRect),this.setHeight(n)}function StateDirectionShadowElement(e,t,n){StateDirectionShadowElement.baseConstructor.call(this,e,t,n),this.itemStates=[],this.itemState=null,this.itemStateDirection=null,this.directionName=null;for(var r=0;r<this.base.childNodes.length;++r){var i=this.base.childNodes[r];i.removeAttribute("style"),i.hide();var s={};s.state=i,i.hasAttribute("parentTag")&&(s.parentTag=i.getAttribute("parentTag")),i.hasAttribute("myTag")&&(s.myTag=i.getAttribute("myTag"));var o={};for(var u=0;u<i.childNodes.length;++u){var a=i.childNodes[u];if(a.hasAttribute("direction")){var f=a.getAttribute("direction");a.removeAttribute("style"),a.hide();for(var l=0;l<f.length;++l)o[f[l]]=a}}s.directions=o,this.itemStates.push(s)}}function StateGridViewItem(e,t,n){this.stateItem=n,StateGridViewItem.baseConstructor.call(this,e,t,this.stateItem),this.updateElevation(),this.updateState()}function SelectableViewItem(e,t){this.view=e,this.item=t;var n=null,r=null,i=null,s=null,o=e.itemFactory.itemTemplates[t.params.itemCode];if(o!=null){n=new SVGElement,n.cloneElement(e.itemFactory.artwork.getElementById(o.itemName+"_def_def")),n.removeAttribute("style"),n.removeAttribute("display");var u="M0,0 L10,0 10,10 0,10z";r=new SVGElement("path",{d:u,fill:"red",stroke:"black",opacity:.5}),i=new SVGElement("path",{d:u,fill:"red",stroke:"black"}),s=new SVGElement("path",{d:u,fill:"white",opacity:0})}else b=e.itemFactory.baseSummary[t.params.itemCode],n=new SVGElement("path",{d:e.itemFactory.baseRect,stroke:"none",fill:b[1]}),r=new SVGElement("path",{d:e.itemFactory.baseRect,stroke:"red",fill:"red",opacity:.5}),i=new SVGElement("path",{d:e.itemFactory.baseRect,stroke:"red",fill:"red"}),s=new SVGElement("path",{d:e.itemFactory.baseRect,stroke:"none",fill:"white",opacity:"0"});SelectableViewItem.baseConstructor.call(this,t,0,0,n,r,i,s,null)}function PerspectiveItemFactory(e,t,n,r,i){PerspectiveItemFactory.baseConstructor.call(this,e),this.delta=.5,this.slope=n/t,this.x=t,this.y=n,this.baseRectTemplate="M -x,0 L 0,-y x,0 x,f 0,g -x,f -x,0 z",this.verticalTemplate=["M -x,0 0,y g,h g,j 0,f -x,d z","M x,0 x,d 0,f p,q p,r 0,y z","M -x,0 L-x,-d 0,-f 0,-y z","M x,0 0,-y 0,-f x,-d z"],this.baseRect=this.baseRectTemplate.replace(/x/gi,t).replace(/y/gi,n).replace(/f/gi,this.delta).replace(/g/gi,this.delta+n),this.baseSummary=i,this.itemTemplates=r}function ACItemHandler(e,t,n){ACItemHandler.baseConstructor.call(this),this.model=e,this.itemName=n,this.matchCriterion="id",this.setItem(t)}function MyActionFactory(e,t){this.model=e,this.controller=t}function GameAction(e,t){GameAction.baseConstructor.call(this),this.type="Default",this.model=e,this.occuranceCount=0,this.conditions=
[],this.controller=t}function SpeechAction(e,t,n,r){SpeechAction.baseConstructor.call(this,e,t),this.setSpeechArray(r),this.currentIndex=0,this.type="Speech",this.speechItem=new ACItemHandler(this.model,n,this.type),this.speechItem.addActionListener(this)}function HeightAction(e,t,n,r){HeightAction.baseConstructor.call(this,e,t),this.setHeight(r),this.type="Height",this.heightItem=new ACItemHandler(this.model,n,this.type),this.heightItem.addActionListener(this)}function TeleportAction(e,t,n){TeleportAction.baseConstructor.call(this,e,t),this.setDestination(n),this.type="Teleport"}function MoveAction(e,t,n,r){MoveAction.baseConstructor.call(this,e,t),this.type="Move",this.targetItem=new ACItemHandler(this.model,n,"src"),this.targetItem.addActionListener(this),this.destItem=new ACItemHandler(this.model,r,"dest"),this.destItem.addActionListener(this)}function ActionController(e,t,n){ActionController.baseConstructor.call(this),this.model=e,this.parentController=t,this.turnClock=n,this.actionFactory=new MyActionFactory(this.model,this),this.conditionFactory=new MyConditionFactory(this.model,this,this.turnClock),this.itemActionList=[],this.conditionIdIndex=0,this.condIdList={},this.speakingItems=[]}function ActionSummary(e,t,n,r){this.controller=e,this.myAction=t,this.colour1=n,this.colour2=r,this.myAction.addActionListener(this),this.conditionSummaries=new FlowLayout(0,0,{direction:"down",minSpacing:3}),this.presentationLayout=new FlowLayout(0,0,{minSpacing:3}),this.editButton=new RectButton("editAction",0,0,new SVGElement("text",{"font-size":12,fill:"black",x:5,y:12},"Edit"),{fill:"white",stroke:"green",rx:2},{fill:"green"},{fill:"blue"},2,!1),this.editButton.addActionListener(this),this.presentationLayout.appendChild(this.editButton),this.updateConditionSummaries(this.myAction.conditions),ActionSummary.baseConstructor.call(this,0,0,this.presentationLayout,{fill:this.colour2,stroke:this.colour1,rx:4},3)}function HeightActionSummary(e,t,n,r){HeightActionSummary.baseConstructor.call(this,e,t,n,r);var i=new FlowLayout(0,0,{minSpacing:3}),s=new SVGElement;s.cloneElement(this.controller.artwork.getElementById("iconActionRaiseLower"));var o=new RectLabel(0,0,s,{fill:n,stroke:"none",rx:2,width:30,height:30},2);i.appendChild(o),this.itemPresentationLabel=new SummaryItemDisplay(this.controller,{fill:"white",stroke:"none",rx:2,width:30,height:30},2),i.appendChild(this.itemPresentationLabel),rightArrow=new SVGElement,rightArrow.cloneElement(this.controller.artwork.getElementById("iconRightArrow")),this.rightArrowLabelPres=new RectLabel(0,0,rightArrow,{fill:"none",stroke:"none",width:30,height:30}),i.appendChild(this.rightArrowLabelPres),this.finalItemAppearancePres=new RectLabel(0,0,null,{fill:"white",stroke:"none",rx:2,width:30,height:30},2),i.appendChild(this.finalItemAppearancePres),this.presentationLayout.prependChild(i),this.initFromAction()}function SpeechActionSummary(e,t,n,r){SpeechActionSummary.baseConstructor.call(this,e,t,n,r);var i=new FlowLayout(0,0,{minSpacing:3}),s=new SVGElement;s.cloneElement(this.controller.artwork.getElementById("iconActionSpeech"));var o=new RectLabel(0,0,s,{fill:n,stroke:"none",rx:2,width:30,height:30},2);i.appendChild(o),this.itemPresentationLabel=new SummaryItemDisplay(this.controller,{fill:"white",stroke:"none",rx:2,width:30,height:30},2),i.appendChild(this.itemPresentationLabel),this.speechPresentationElement=new SVGElement("text",{"font-size":12,fill:"black",x:5,y:14},null),i.appendChild(this.speechPresentationElement),this.presentationLayout.prependChild(i),this.initFromAction()}function TeleportActionSummary(e,t,n,r){TeleportActionSummary.baseConstructor.call(this,e,t,n,r);var i=new FlowLayout(0,0,{minSpacing:3}),s=new SVGElement;s.cloneElement(this.controller.artwork.getElementById("iconActionTeleport"));var o=new RectLabel(0,0,s,{fill:n,stroke:"none",rx:2,width:30,height:30},2);i.appendChild(o),this.destinationPresentationElement=new SVGElement("text",{"font-size":12,fill:"black",x:5,y:14},null),i.appendChild(this.destinationPresentationElement),this.presentationLayout.prependChild(i),this.initFromAction()}function MoveActionSummary(e,t,n,r){MoveActionSummary.baseConstructor.call(this,e,t,n,r);var i=new FlowLayout(0,0,{minSpacing:3,orthogonalAlignment:"centre"}),s=new SVGElement;s.cloneElement(this.controller.artwork.getElementById("iconActionMove"));var o=new RectLabel(0,0,s,{fill:n,stroke:"none",rx:2,width:30,height:30},2);i.appendChild(o);var u=new SVGElement("text",{y:12,"font-size":12},"Move");i.appendChild(u),this.targetLabel=new SummaryItemDisplay(this.controller,{fill:"white",stroke:"none",rx:2,width:30,height:30},2),i.appendChild(this.targetLabel);var a=new SVGElement("text",{y:12,"font-size":12},"to");i.appendChild(a),this.destinationLabel=new SummaryItemDisplay(this.controller,{fill:"white",stroke:"none",rx:2,width:30,height:30},2),i.appendChild(this.destinationLabel),this.presentationLayout.prependChild(i),this.initFromAction()}function ItemViewSelector(e,t,n,r){ItemViewSelector.baseConstructor.call(this,"itemButton",0,0,null,{fill:"white",stroke:t,rx:2,width:40,height:40},{fill:"yellow"},{fill:"orange"},2,!1),this.controller=e,this.selectedItem=null,this.tag=n,this.itemChoiceSet=r}function ActionEditor(e,t,n,r){this.controller=e,this.myAction=t,this.colour1=n,this.colour2=r,ActionEditor.baseConstructor.call(this,"Action Editor",5,{fill:this.colour2,stroke:this.colour1,rx:4},{width:250,height:300,storePrefix:"MW_ActionEditor",contentsSpacing:3});var i=new FlowLayout(0,0,{minSpacing:20});this.newConditionButtons=new FlowLayout(0,0,{minSpacing:3}),this.conditionButtonParams=["iconConditionTime","iconConditionWeight","iconConditionHasItem"];for(var s in this.conditionButtonParams){var o=new SVGElement;o.cloneElement(this.controller.artwork.getElementById(this.conditionButtonParams[s]));var u=new RectButton(this.conditionButtonParams[s],0,0,o,{fill:"white",stroke:"orange",rx:2,width:30,height:30},{fill:"yellow"},{fill:"orange"},5,!1);u.addActionListener(this),this.newConditionButtons.appendChild(u)}this.contents.appendChild(this.newConditionButtons),this.conditionSummaries=new FlowLayout(0,0,{direction:"down",minSpacing:3}),this.conditionScrollbarRegion=new ScrollbarRegion({width:240,height:200,scrollbarWidth:20},this.conditionSummaries),this.conditionSummaries.addResizeListener(this.conditionScrollbarRegion),this.contents.appendChild(this.conditionScrollbarRegion),this.updateConditionSummaries(this.myAction.conditions),this.contents.appendChild(this.conditionSummaries),this.updateButton=new RectButton("updateAction",0,0,new SVGElement("text",{"font-size":12,fill:"black",x:5,y:12},"Update"),{fill:"white",stroke:"green",rx:2},{fill:"green"},{fill:"blue"},2,!1),this.updateButton.addActionListener(this),i.appendChild(this.updateButton),this.deleteButton=new RectButton("deleteAction",0,0,new SVGElement("text",{"font-size":12,fill:"black",x:5,y:12},"Delete"),{fill:"white",stroke:"red",rx:2},{fill:"orange"},{fill:"red"},2,!1),this.deleteButton.addActionListener(this),i.appendChild(this.deleteButton),this.cancelButton=new RectButton("cancelAction",0,0,new SVGElement("text",{"font-size":12,fill:"black",x:5,y:12},"Cancel"),{fill:"white",stroke:"red",rx:2},{fill:"orange"},{fill:"red"},2,!1),this.cancelButton.addActionListener(this),i.appendChild(this.cancelButton),this.contents.appendChild(i),this.addResizeListener(this)}function makeConditionSummary(e,t){var n=null;switch(t.type){case"Timestamp":n=new TimestampConditionSummary(e,t);break;case"Weight":n=new WeightConditionSummary(e,t);break;case"HasItem":n=new HasItemConditionSummary(e,t)}return n}function makeConditionEditor(e,t){var n=null;switch(t.type){case"Timestamp":n=new TimestampConditionEditor(e,t);break;case"Weight":n=new WeightConditionEditor(e,t);break;case"HasItem":n=new HasItemConditionEditor(e,t)}return n}function SpeechActionEditor(e,t,n,r){SpeechActionEditor.baseConstructor.call(this,e,t,n,r),this.myTag="SpeakingItem",this.selectedItem=null;var i=new FlowLayout(0,0,{minSpacing:3}),s=new SVGElement;s.cloneElement(this.controller.artwork.getElementById("iconActionSpeech"));var o=new RectLabel(0,0,s,{fill:n,stroke:"none",rx:2,width:30,height:30},2);i.appendChild(o),this.speechItemButton=new ItemViewSelector(this.controller,n,"speechItem","topItem"),i.appendChild(this.speechItemButton),this.speechEditTextbox=new TextArea("speechText",e.background,{width:100,height:40,fill:"white",stroke:n,rx:5},{"font-size":14,fill:"black",x:3,y:14},0,0,{normal:{stroke:"blue"},focus:{stroke:"red"}}),i.appendChild(this.speechEditTextbox),this.contents.prependChild(i),this.initFromAction()}function MoveActionEditor(e,t,n,r){MoveActionEditor.baseConstructor.call(this,e,t,n,r);var i=new FlowLayout(0,0,{minSpacing:3,orthogonalAlignment:"centre"}),s=new SVGElement;s.cloneElement(this.controller.artwork.getElementById("iconActionMove"));var o=new RectLabel(0,0,s,{fill:n,stroke:"none",rx:2,width:30,height:30},2);i.appendChild(o);var u=new SVGElement("text",{y:12,"font-size":12},"Move");i.appendChild(u),this.targetItemButton=new ItemViewSelector(e,n,"targetItem","topItem"),i.appendChild(this.targetItemButton);var a=new SVGElement("text",{y:12,"font-size":12},"to");i.appendChild(a),this.destinationItemButton=new ItemViewSelector(e,n,"destItem","topItem"),i.appendChild(this.destinationItemButton),this.contents.prependChild(i),this.initFromAction()}function HeightActionEditor(e,t,n,r){HeightActionEditor.baseConstructor.call(this,e,t,n,r),this.myTag="HeightChangeBlock";var i=new FlowLayout(0,0,{minSpacing:3}),s=new SVGElement;s.cloneElement(this.controller.artwork.getElementById("iconActionRaiseLower"));var o=new RectLabel(0,0,s,{fill:n,stroke:"none",rx:2,width:30,height:30},2);i.appendChild(o),this.heightItemButton=new ItemViewSelector(e,n,"heightItem","topBlock"),i.appendChild(this.heightItemButton),this.heightItemButton.addActionListener(this);var u=new SVGElement;u.cloneElement(this.controller.artwork.getElementById("iconRightArrow")),this.rightArrowLabelEdit=new RectLabel(0,0,u,{fill:"none",stroke:"none",width:30,height:40}),i.appendChild(this.rightArrowLabelEdit),this.finalItemAppearanceEdit=new RectLabel(0,0,null,{fill:"white",stroke:"none",width:40,height:40},2),i.appendChild(this.finalItemAppearanceEdit),this.heightButtons=new FlowLayout(0,0,{direction:"down",minSpacing:5});var a=new SVGElement;a.cloneElement(this.controller.artwork.getElementById("iconUpArrow")),this.upArrowButton=new RectButton("upArrowButton",0,0,a,{fill:"white",stroke:n,rx:2,width:30,height:13},{fill:"yellow"},{fill:"orange"},2,!1),this.heightButtons.appendChild(this.upArrowButton),this.upArrowButton.addActionListener(this);var f=new SVGElement;f.cloneElement(this.controller.artwork.getElementById("iconDownArrow")),this.downArrowButton=new RectButton("downArrowButton",0,0,f,{fill:"white",stroke:n,rx:2,width:30,height:13},{fill:"yellow"},{fill:"orange"},2,!1),this.heightButtons.appendChild(this.downArrowButton),this.downArrowButton.addActionListener(this),i.appendChild(this.heightButtons),this.contents.prependChild(i),this.initFromAction()}function TeleportActionEditor(e,t,n,r){TeleportActionEditor.baseConstructor.call(this,e,t,n,r),this.destinationId=null;var i=new FlowLayout(0,0,{minSpacing:3}),s=new SVGElement;s.cloneElement(this.controller.artwork.getElementById("iconActionTeleport"));var o=new RectLabel(0,0,s,{fill:n,stroke:"none",rx:2,width:30,height:30},2);i.appendChild(o);var u=new SVGElement("text",{"font-size":12,y:12,fill:"black"},"Destination:");i.appendChild(u),this.teleportToText=new SVGElement("text",{"font-size":12,y:12,fill:"black"},"Select Destination"),this.selectTeleportButton=new RectButton("selectTeleportButton",0,0,this.teleportToText,{fill:"white",stroke:"none"},{fill:"yellow"},{fill:"orange"},2,!1),this.selectTeleportButton.addActionListener(this),i.appendChild(this.selectTeleportButton),this.teleportWindow=new WorldChooserWindow(this.controller,{windowName:"Teleport Destination",showAccessOnly:!0,closeOnSelect:!0}),this.teleportWindow.addActionListener(this),this.teleportWindow.hide(),this.appendChild(this.teleportWindow),this.controller.visitedWorldNotifier.addActionListener(this.teleportWindow),this.contents.prependChild(i),this.initFromAction()}function ActionViewWindow(e){this.controller=e,ActionViewWindow.baseConstructor.call(this,"Actions",5,{fill:"lightGreen",stroke:"green",rx:4},{width:240,height:280,storePrefix:"MW_ActionViewWindow",contentsSpacing:3}),this.newActionButtons=new FlowLayout(0,0,{minSpacing:3});var t=["iconActionSpeech","iconActionRaiseLower","iconActionTeleport","iconActionMove"];for(var n in t){var r=new SVGElement;r.cloneElement(this.controller.artwork.getElementById(t[n]));var i=new RectButton(t[n],0,0,r,{fill:"white",stroke:"green",rx:2,width:40,height:40},{fill:"yellow"},{fill:"orange"},5,!1);i.addActionListener(this),this.newActionButtons.appendChild(i)}this.contents.appendChild(this.newActionButtons),this.actionSummaries=new FlowLayout(0,0,{direction:"down",minSpacing:3}),this.actionScrollbarRegion=new ScrollbarRegion({width:240,height:200,scrollbarWidth:20,rectBorder:{stroke:"black","stroke-width":"2",fill:"none"}},this.actionSummaries),this.actionSummaries.addResizeListener(this.actionScrollbarRegion),this.contents.appendChild(this.actionScrollbarRegion);for(var n in this.controller.actionController.itemActionList)this.addActionSummary(this.controller.actionController.itemActionList[n]);this.controller.actionController.addActionListener(this)}function makeActionSummary(e,t){var n=null;switch(t.type){case"Speech":n=new SpeechActionSummary(e,t,"blue","lightBlue");break;case"Height":n=new HeightActionSummary(e,t,"purple","plum");break;case"Teleport":n=new TeleportActionSummary(e,t,"darkGreen","green");break;case"Move":n=new MoveActionSummary(e,t,"khaki","darkkhaki")}return n}function makeActionEditor(e,t){var n=null;switch(t.type){case"Speech":n=new SpeechActionEditor(e,t,"blue","lightBlue");break;case"Height":n=new HeightActionEditor(e,t,"purple","plum");break;case"Teleport":n=new TeleportActionEditor(e,t,"darkGreen","green");break;case"Move":n=new MoveActionEditor(e,t,"khaki","darkkhaki")}return n}function MyConditionFactory(e,t,n){this.model=e,this.controller=t,this.turnClock=n}function GameCondition(e,t){GameCondition.baseConstructor.call(this),this.model=e,this.controller=t,this.type="Default"}function TimestampCondition(e,t,n,r){this.turnClock=n,this.timestamp=r,TimestampCondition.baseConstructor.call(this,e,t),this.type="Timestamp"}function WeightCondition(e,t,n,r){WeightCondition.baseConstructor.call(this,e,t),this.type="Weight",this.weightItem=new ACItemHandler(this.model,n,this.type),this.weightItem.addActionListener(this),this.setMinWeight(r)}function HasItemCondition(e,t,n,r,i,s){HasItemCondition.baseConstructor.call(this,e,t),this.type="HasItem",this.heldItem=new ACItemHandler(this.model,n,"held"),this.heldItem.setItemMatchCriterion(r,s),this.heldItem.addActionListener(this),this.containerItem=new ACItemHandler(this.model,i,"container"),this.containerItem.addActionListener(this)}function ConditionSummary(e,t){this.controller=e,this.myCondition=t,this.myCondition.addActionListener(this),this.presentationLayout=new FlowLayout(0,0,{minSpacing:3}),this.editButton=new RectButton("editCondition",0,0,new SVGElement("text",{"font-size":12,fill:"black",x:5,y:12},"Edit"),{fill:"white",stroke:"green",rx:2},{fill:"green"},{fill:"blue"},2,!1),this.editButton.addActionListener(this),this.presentationLayout.appendChild(this.editButton),ConditionSummary.baseConstructor.call(this,0,0,this.presentationLayout,{fill:"lightyellow",stroke:"orange",rx:4},3)}function TimestampConditionSummary(e,t){TimestampConditionSummary.baseConstructor.call(this,e,t);var n=new FlowLayout(0,0,{minSpacing:3}),r=new SVGElement;r.cloneElement(this.controller.artwork.getElementById("iconConditionTime")),conditionTypeLabel=new RectLabel(0,0,r,{fill:"orange",stroke:"none",rx:2,width:20,height:20},2),n.appendChild(conditionTypeLabel),this.timestampPresentationElement=new SVGElement("text",{"font-size":12,fill:"black",x:5,y:14},"time: 0"),n.appendChild(this.timestampPresentationElement),this.presentationLayout.prependChild(n),this.initFromCondition()}function WeightConditionSummary(e,t){WeightConditionSummary.baseConstructor.call(this,e,t);var n=new FlowLayout(0,0,{minSpacing:3}),r=new SVGElement;r.cloneElement(this.controller.artwork.getElementById("iconConditionWeight")),conditionTypeLabel=new RectLabel(0,0,r,{fill:"orange",stroke:"none",rx:2,width:20,height:20},2),n.appendChild(conditionTypeLabel),this.itemPresentationLabel=new SummaryItemDisplay(this.controller,{fill:"white",stroke:"none",rx:2,width:30,height:30},2),n.appendChild(this.itemPresentationLabel),this.weightPresentationElement=new SVGElement("text",{"font-size":12,fill:"black",x:5,y:14},"weight: 0"),n.appendChild(this.weightPresentationElement),this.presentationLayout.prependChild(n),this.initFromCondition()}function HasItemConditionSummary(e,t){HasItemConditionSummary.baseConstructor.call(this,e,t),this.selectedItem=null,this.selectedContainer=null;var n=new FlowLayout(0,0,{minSpacing:3}),r=new SVGElement;r.cloneElement(this.controller.artwork.getElementById("iconConditionHasItem")),conditionTypeLabel=new RectLabel(0,0,r,{fill:"orange",stroke:"none",rx:2,width:20,height:20},2),n.appendChild(conditionTypeLabel),this.containerLabel=new SummaryItemDisplay(this.controller,{fill:"white",stroke:"none",rx:2,width:30,height:30},2),n.appendChild(this.containerLabel);var i=new SVGElement("text",{"font-size":12,fill:"black",x:5,y:14},"contains");n.appendChild(i),this.thisOrAnyElement=new SVGElement("text",{"font-size":12,fill:"black",x:5,y:14},"this"),n.appendChild(this.thisOrAnyElement),this.heldLabel=new SummaryItemDisplay(this.controller,{fill:"white",stroke:"none",rx:2,width:30,height:30},2),n.appendChild(this.heldLabel),this.presentationLayout.prependChild(n),this.initFromCondition()}function ConditionEditor(e,t,n,r){this.controller=e,this.myCondition=t,ConditionEditor.baseConstructor.call(this,"Condition Editor",5,{fill:"yellow",stroke:"black",rx:4},{width:n,height:r,storePrefix:"MW_ConditionEditor",contentsSpacing:3});var i=new FlowLayout(0,0,{minSpacing:20});this.updateButton=new RectButton("updateCondition",0,0,new SVGElement("text",{"font-size":12,fill:"black",x:5,y:12},"Update"),{fill:"white",stroke:"green",rx:2},{fill:"green"},{fill:"blue"},2,!1),this.updateButton.addActionListener(this),i.appendChild(this.updateButton),this.deleteButton=new RectButton("deleteCondition",0,0,new SVGElement("text",{"font-size":12,fill:"black",x:5,y:12},"Delete"),{fill:"white",stroke:"red",rx:2},{fill:"orange"},{fill:"red"},2,!1),this.deleteButton.addActionListener(this),i.appendChild(this.deleteButton),this.cancelButton=new RectButton("cancelCondition",0,0,new SVGElement("text",{"font-size":12,fill:"black",x:5,y:12},"Cancel"),{fill:"white",stroke:"red",rx:2},{fill:"orange"},{fill:"red"},2,!1),this.cancelButton.addActionListener(this),i.appendChild(this.cancelButton),this.contents.appendChild(i)}function TimestampConditionEditor(e,t){TimestampConditionEditor.baseConstructor.call(this,e,t,173,86);var n=new FlowLayout(0,0,{minSpacing:3}),r=new SVGElement;r.cloneElement(this.controller.artwork.getElementById("iconConditionTime"));var i=new RectLabel(0,0,r,{fill:"orange",stroke:"none",rx:2,width:20,height:20},2);n.appendChild(i),this.timestampEditTextbox=new TextArea("timestampText",e.background,{width:40,height:20,fill:"white",stroke:"orange",rx:5},{"font-size":14,fill:"black",x:3,y:14},0,0,{normal:{stroke:"orange"},focus:{stroke:"red"}}),n.appendChild(this.timestampEditTextbox),this.contents.prependChild(n),this.initFromCondition()}function WeightConditionEditor(e,t){WeightConditionEditor.baseConstructor.call(this,e,t,168,90),this.myTag="holdingItem";var n=new FlowLayout(0,0,{minSpacing:3}),r=new SVGElement;r.cloneElement(this.controller.artwork.getElementById("iconConditionWeight"));var i=new RectLabel(0,0,r,{fill:"orange",stroke:"none",rx:2,width:20,height:20},2);n.appendChild(i),this.weightItemButton=new ItemViewSelector(e,"orange","weightItem","topBlock"),n.appendChild(this.weightItemButton),this.weightEditTextbox=new TextArea("weightText",e.background,{width:40,height:20,fill:"white",stroke:"orange",rx:5},{"font-size":14,fill:"black",x:3,y:14},0,0,{normal:{stroke:"orange"},focus:{stroke:"red"}}),n.appendChild(this.weightEditTextbox),this.contents.prependChild(n),this.initFromCondition()}function HasItemConditionEditor(e,t){HasItemConditionEditor.baseConstructor.call(this,e,t,218,149),this.itemTag="HeldItem",this.containerTag="ContainerItem";var n=new FlowLayout(0,0,{direction:"down",minSpacing:3}),r=new FlowLayout(0,0,{minSpacing:3});n.appendChild(r);var i=new SVGElement;i.cloneElement(this.controller.artwork.getElementById("iconConditionHasItem"));var s=new RectLabel(0,0,i,{fill:"orange",stroke:"none",rx:2,width:20,height:20},2);r.appendChild(s),this.containerEditButton=new ItemViewSelector(e,"orange","containerItem","topItem"),r.appendChild(this.containerEditButton);var o=new SVGElement("text",{"font-size":12,fill:"black",x:5,y:14},"contains");r.appendChild(o),this.itemEditButton=new ItemViewSelector(e,"orange","heldItem","topItem"),r.appendChild(this.itemEditButton),this.heldItemTypeRadioGroup=new RadioButtonGroup;var u=new FlowLayout(0,0,{minSpacing:3});n.appendChild(u);var a=makeSimpleCheckboxParamButtonIdSet();a.width=10,a.height=10,this.matchHeldByCodeCheckbox=new ParamButton2("matchHeldByCodeCheckbox",a),this.matchHeldByCodeCheckbox.setToggle(!0),this.heldItemTypeRadioGroup.addButton(this.matchHeldByCodeCheckbox),u.appendChild(this.matchHeldByCodeCheckbox),u.appendChild(new SVGElement("text",{"font-size":12,fill:"black",x:5,y:12},"Match any held item that looks the same")),this.matchHeldByCodeCheckbox.addActionListener(this);var f=new FlowLayout(0,0,{minSpacing:3});n.appendChild(f);var l=makeSimpleCheckboxParamButtonIdSet();l.width=10,l.height=10,this.matchHeldByIdCheckbox=new ParamButton2("matchHeldByIdCheckbox",l),this.matchHeldByIdCheckbox.setToggle(!0),this.heldItemTypeRadioGroup.addButton(this.matchHeldByIdCheckbox),f.appendChild(this.matchHeldByIdCheckbox),f.appendChild(new SVGElement("text",{"font-size":12,fill:"black",x:5,y:12},"Match only this held item")),this.matchHeldByIdCheckbox.addActionListener(this);var c=new FlowLayout(0,0,{minSpacing:3});n.appendChild(c);var h=makeSimpleCheckboxParamButtonIdSet();h.width=10,h.height=10,this.matchHeldByTagCheckbox=new ParamButton2("matchHeldByTagCheckbox",h),this.matchHeldByTagCheckbox.setToggle(!0),this.heldItemTypeRadioGroup.addButton(this.matchHeldByTagCheckbox),c.appendChild(this.matchHeldByTagCheckbox),c.appendChild(new SVGElement("text",{"font-size":12,fill:"black",x:5,y:12},'Match any held item with the tag "avatar"')),this.matchHeldByTagCheckbox.addActionListener(this),this.contents.prependChild(n),this.initFromCondition()}function ContentLayoutView(e){ContentLayoutView.baseConstructor.call(this,0,0),this.bgRect=new SVGElement("rect",{x:-5,y:-5,width:0,height:0,fill:"white",stroke:"black"}),this.tree=new FlowLayout(0,0),this.appendChild(this.bgRect),this.appendChild(this.tree),this.hide(),this.view=e}function makeItemLayout(e,t){var n=null,r=new SelectableViewItem(e,t);if(t.myItems.length>1){n=new FlowLayout(0,0,{direction:"up"}),n.appendChild(r);var i=new FlowLayout(0,0);n.appendChild(i);for(var s in t.myItems){var o=makeItemLayout(e,t.myItems[s]);i.appendChild(o)}}else t.myItems.length==1?(n=makeItemLayout(e,t.myItems[0]),n.prependChild(r)):(n=new FlowLayout(0,0,{direction:"up"}),n.appendChild(r));return n}function LoginController(e,t,n,r){LoginController.baseConstructor.call(this),this.background=e,this.listeningForResponse=!1,this.loggedIn=!1,this.loginArea=t,this.loginGroup=new SVGComponent(50,50);var i=new SVGElement("text",{"font-size":20,fill:"white",y:20},"username");this.loginGroup.appendChild(i),this.loginTextbox=new TextArea("login",this.background,{width:200,height:30,fill:"black","stroke-width":3},{"font-size":20,fill:"red",x:5,y:20},90,0,{normal:{stroke:"white"},focus:{stroke:"red"}}),this.loginGroup.appendChild(this.loginTextbox);var s=new SVGElement("text",{"font-size":20,fill:"white",y:70},"password");this.loginGroup.appendChild(s),this.passwordTextbox=new TextArea("password",this.background,{width:200,height:30,fill:"black","stroke-width":3},{"font-size":20,fill:"red",x:5,y:20},90,50,{normal:{stroke:"white"},focus:{stroke:"red"}}),this.passwordTextbox.setSecret(),this.loginGroup.appendChild(this.passwordTextbox),this.loginButton=new SimpleButton("login","rect",{width:70,height:30,rx:10,fill:"black","stroke-width":3},30,100,{normal:{stroke:"white"},over:{stroke:"red"},focus:{stroke:"red"}}),this.loginButton.addSVG("text",{"font-size":20,fill:"white",x:15,y:20},"login"),this.loginButton.addActionListener(this),this.loginButton.setBackground(this.background),this.loginGroup.appendChild(this.loginButton);var o=new SVGElement("text",{"font-size":20,fill:"white",x:115,y:120},"or");this.loginGroup.appendChild(o),this.guestLoginButton=new SimpleButton("guestLogin","rect",{width:140,height:30,rx:10,fill:"black","stroke-width":3},150,100,{normal:{stroke:"white"},over:{stroke:"red"},focus:{stroke:"red"}}),this.guestLoginButton.addSVG("text",{"font-size":20,fill:"white",x:15,y:20},"login as guest"),this.guestLoginButton.addActionListener(this),this.guestLoginButton.setBackground(this.background),this.loginGroup.appendChild(this.guestLoginButton),this.statusLabel=new SVGElement("text",{"font-size":20,fill:"white",x:20,y:160},""),this.loginGroup.appendChild(this.statusLabel),this.loginTextbox.addFocusListener(this.passwordTextbox),this.passwordTextbox.addFocusListener(this.loginTextbox),this.passwordTextbox.addFocusListener(this.loginButton),this.loginButton.addFocusListener(this.passwordTextbox),this.loginTextbox.setNextFocus(this.passwordTextbox),this.passwordTextbox.setPreviousFocus(this.loginTextbox),this.passwordTextbox.setNextFocus(this.loginButton),this.loginButton.setPreviousFocus(this.passwordTextbox),this.loginArea.appendChild(this.loginGroup),this.logoutGroup=new FlowLayout(0,0,{minSpacing:5}),this.logoutGroup.appendChild(new SVGElement("text",{y:12,"font-size":12,fill:"black"},"Logged in as:")),this.usernameLabel=new SVGElement("text",{y:12,"font-size":12,fill:"black"},""),this.logoutGroup.appendChild(this.usernameLabel),this.logoutButton=new RectButton("logout",0,0,new SVGElement("text",{y:12,"font-size":12},"Logout"),{fill:"lightblue",stroke:"black",rx:2},{fill:"orange"},{fill:"red"},2,!1),this.logoutButton.addActionListener(this),this.logoutButton.setBackground(this.background),this.logoutGroup.appendChild(this.logoutButton),this.login=null,this.password=null,window.localStorage&&(this.login=localStorage.getItem("MW_Login"),this.password=localStorage.getItem("MW_Password"))}function SummaryItemDisplay(e,t,n){this.controller=e,this.selectedItem=null,SummaryItemDisplay.baseConstructor.call(this,0,0,null,t,n)}function ItemSelectorWindow(e){this.selectedItem=null,this.itemType=null,this.client=null,this.controller=e,ItemSelectorWindow.baseConstructor.call(this,"Item Selection",5,{fill:"lightGreen",stroke:"green",rx:4},{storePrefix:"MW_ItemSelectorWindow"});var t=new MultilineText(0,0,"Nothing selected yet",{"font-size":15,fill:"black"},{maxWidth:70,lineSpacing:0});this.defaultSelection=new RectLabel(0,0,t,{fill:"white",stroke:"green",rx:2},2),this.selectionArea=new SVGElement("g"),this.selectionArea.appendChild(this.defaultSelection);var n=new FlowLayout(0,0,{minSpacing:3}),r=new TextLabel("Current Item: ",{"font-size":15,fill:"black"},{maxWidth:160,lineSpacing:0});n.appendChild(r),n.appendChild(this.selectionArea),this.contents.appendChild(n),this.explanationText=new TextLabel("Select an item in the grid",{"font-size":15,fill:"black"},{maxWidth:160,lineSpacing:0}),this.contents.appendChild(this.explanationText);for(var i=0;i<this.controller.avatarGroupController.avatarList.length;++i){var s=this.controller.avatarGroupController.avatarList[i].copyItem();this.avatarButton=new RectButton("avatarButton",0,0,s,{fill:"white",stroke:"green",rx:2,width:40,height:40},{fill:"yellow"},{fill:"orange"},5,!1),this.contents.appendChild(this.avatarButton),this.avatarButton.addActionListener(this)}var o=new FlowLayout(0,0,{minSpacing:3});this.contents.appendChild(o),this.okButton=new RectButton("ItemSelectionOK",0,0,new SVGElement("text",{"font-size":15,fill:"black",x:0,y:15},"OK"),{fill:"white",stroke:"green",rx:2},{fill:"yellow"},{fill:"orange"},2,!1),o.appendChild(this.okButton),this.okButton.addActionListener(this),this.cancelButton=new RectButton("ItemSelectionCancel",0,0,new SVGElement("text",{"font-size":15,fill:"black",x:30,y:15},"Cancel"),{fill:"white",stroke:"green",rx:2},{fill:"yellow"},{fill:"orange"},2,!1),o.appendChild(this.cancelButton),this.cancelButton.addActionListener(this)}function BlockItemWindow(e){BlockItemWindow.baseConstructor.call(this,"Create Block",5,{fill:"lightGreen",stroke:"green",rx:4},{width:88,height:160,storePrefix:"MW_BlockItemWindow",contentsSpacing:3}),this.controller=e,this.itemBar=new FlowLayout(0,0,{minSpacing:5}),this.contents.appendChild(this.itemBar),this.itemAppearanceLabel=new RectLabel(0,0,null,{fill:"white",stroke:"none",width:30,height:40},2),this.itemAppearanceButton=new RectButton("blockItemButton",0,0,null,{fill:"white",stroke:"none",width:30,height:30},{fill:"yellow"},{fill:"orange"},2,!1),this.setItem("d"),this.itemBar.appendChild(this.itemAppearanceLabel),this.heightButtons=new FlowLayout(0,0,{direction:"down",minSpacing:5});var t=new SVGElement;t.cloneElement(this.controller.artwork.getElementById("iconUpArrow")),this.upArrowButton=new RectButton("upArrowButton",0,0,t,{fill:"white",stroke:"blue",rx:2,width:30,height:16},{fill:"yellow"},{fill:"orange"},2,!1),this.heightButtons.appendChild(this.upArrowButton),this.upArrowButton.addActionListener(this);var n=new SVGElement;n.cloneElement(this.controller.artwork.getElementById("iconDownArrow")),this.downArrowButton=new RectButton("downArrowButton",0,0,n,{fill:"white",stroke:"blue",rx:2,width:30,height:16},{fill:"yellow"},{fill:"orange"},2,!1),this.heightButtons.appendChild(this.downArrowButton),this.downArrowButton.addActionListener(this),this.itemBar.appendChild(this.heightButtons),this.colourButtons=[];var r=0,i=3;for(var s in this.controller.itemFactory.baseSummary){var o=Math.floor(r/i);this.colourButtons[o]==null&&(this.colourButtons[o]=new FlowLayout(0,0,{minSpacing:3}),this.contents.appendChild(this.colourButtons[o]));var u=this.controller.itemFactory.baseSummary[s],a=new RectButton("i_"+s,0,0,new SVGElement("rect",{width:"5",height:"5",fill:u[1]}),{stroke:"black",fill:u[1]},{stroke:"red"},{stroke:"red"},7,!1);this.colourButtons[o].appendChild(a),a.addActionListener(this),r++}}function ItemWindow(e){ItemWindow.baseConstructor.call(this,"Create Item",5,{fill:"lightGreen",stroke:"green",rx:4},{width:170,height:170,storePrefix:"MW_ItemWindow",contentsSpacing:3}),this.controller=e,this.itemBar=new FlowLayout(0,0,{minSpacing:5}),this.contents.appendChild(this.itemBar),this.teleportToText=new SVGElement("text",{"font-size":12,y:12,fill:"black"},"Select Destination"),this.selectTeleportButton=new RectButton("selectTeleportButton",0,0,this.teleportToText,{fill:"white",stroke:"none"},{fill:"yellow"},{fill:"orange"},2,!1),this.selectTeleportButton.addActionListener(this),this.teleportWindow=new WorldChooserWindow(this.controller,{windowName:"Teleport Destination",showAccessOnly:!0,closeOnSelect:!0}),this.teleportWindow.addActionListener(this),this.teleportWindow.hide(),this.controller.visitedWorldNotifier.addActionListener(this.teleportWindow),this.itemAppearanceLabel=new RectLabel(0,0,null,{fill:"white",stroke:"none",width:40,height:40},2),this.itemAppearanceButton=new RectButton("itemButton",0,0,null,{fill:"white",stroke:"none",width:30,height:30},{fill:"yellow"},{fill:"orange"},2,!1),this.itemBar.appendChild(this.itemAppearanceLabel),this.extrasArea=new FlowLayout(0,0,{minSpacing:3}),this.itemBar.appendChild(this.extrasArea),this.setItem("x"),this.itemButtons=[];var t=0,n=5;for(var r in this.controller.itemFactory.itemTemplates){var i=Math.floor(t/n);this.itemButtons[i]==null&&(this.itemButtons[i]=new FlowLayout(0,0,{minSpacing:3}),this.contents.appendChild(this.itemButtons[i]));var s=this.controller.itemFactory.itemTemplates[r];if(s==null||s.noEdit)continue;var o=this.controller.itemFactory.artwork.getElementById(s.itemName+"_def_def");if(o==null)continue;var u=new SVGElement;u.cloneElement(o),u.removeAttribute("style"),u.removeAttribute("display");if(u.hasAttribute("transform")){var a=new SVGElement("g");a.appendChild(u),u=a}var f=new RectButton("i_"+
r,0,0,u,{stroke:"black",fill:"white",rx:2,width:30,height:30},{stroke:"red"},{stroke:"red"},3,!1);this.itemButtons[i].appendChild(f),f.addActionListener(this),t++}}function LightLevelWindow(e){LightLevelWindow.baseConstructor.call(this,"Ambient Light Level",5,{fill:"lightGreen",stroke:"green",rx:4},{width:260,height:60,storePrefix:"MW_LightLevelWindow"}),this.controller=e,this.lightBar=new FlowLayout(0,0,{minSpacing:5}),this.contents.appendChild(this.lightBar),this.labelIcon=new SVGElement,this.labelIcon.cloneElement(this.controller.artwork.getElementById("iconLightbulb")),this.lightAppearanceLabel=new RectLabel(0,0,this.labelIcon,{fill:"white",stroke:"none",width:40,height:40},2),this.buttonIcon=new SVGElement,this.buttonIcon.cloneElement(this.controller.artwork.getElementById("iconLightbulb")),this.lightAppearanceButton=new RectButton("lightButton",0,0,this.buttonIcon,{fill:"white",stroke:"none",width:30,height:30},{fill:"yellow"},{fill:"orange"},2,!1),this.setLightLevel(0),this.lightBar.appendChild(this.lightAppearanceLabel);for(var t=0;t<=5;t++){var n=new SVGElement;n.cloneElement(this.controller.artwork.getElementById("iconLightbulb")),n.firstChild.setAttribute("style","fill:'black';opacity:"+t*.2);var r=new RectButton("l_"+t,0,0,n,{stroke:"black",fill:"white",rx:2,width:30,height:30},{stroke:"red"},{stroke:"red"},2,!1);this.lightBar.appendChild(r),r.addActionListener(this)}}function EditWindow(e,t){EditWindow.baseConstructor.call(this,"Edit Map",5,{fill:"lightGreen",stroke:"green",rx:4},{width:71,height:246,storePrefix:"MW_EditWindow",contentsSpacing:3}),this.controller=e,this.editRoot=t,this.actionsBar=new FlowLayout(0,0,{minSpacing:5}),this.contents.appendChild(this.actionsBar);var n=new SVGElement;n.cloneElement(this.controller.artwork.getElementById("iconHammer")),this.actionsButton=new RectButton("actionsWindow",0,0,n,{fill:"white",stroke:"black",rx:2,width:30,height:30},{fill:"yellow"},{fill:"orange"},4,!1),this.actionsButton.addActionListener(this),this.actionsBar.appendChild(this.actionsButton);var r=new SVGElement;r.cloneElement(this.controller.artwork.getElementById("iconInformation")),this.infoButton=new RectButton("infoWindow",0,0,r,{fill:"white",stroke:"black",rx:2,width:30,height:30},{fill:"yellow"},{fill:"orange"},4,!1),this.infoButton.addActionListener(this),this.actionsBar.appendChild(this.infoButton),this.actionViewWindow=new ActionViewWindow(this.controller),this.actionViewWindow.x==0&&this.actionViewWindow.y==0&&this.actionViewWindow.setPosition(920,35),this.actionViewWindow.hide(),this.actionViewWindow.addActionListener(this),this.editRoot.appendChild(this.actionViewWindow),this.itemSelectorWindow=new ItemSelectorWindow(this.controller),this.itemSelectorWindow.x==0&&this.itemSelectorWindow.y==0&&this.itemSelectorWindow.setPosition(170,100),this.itemSelectorWindow.hide(),this.editRoot.appendChild(this.itemSelectorWindow),this.infoWindow=new SVGWindow("info",3,{fill:"white",stroke:"black",rx:4},{storePrefix:"MW_InfoWindow"}),this.infoWindow.hide(),this.infoWindow.x==0&&this.infoWindow.y==0&&this.infoWindow.setPosition(50,350),this.infoWindowContents=new TextLabel(null,{"font-size":10,fill:"black",space:"preserve"},{minSpacing:0,maxWidth:200}),this.infoWindow.contents.appendChild(this.infoWindowContents),this.infoWindow.addActionListener(this),this.editRoot.appendChild(this.infoWindow),this.radioButtonGroup=new RadioButtonGroup;var i=new SVGElement;i.cloneElement(this.controller.artwork.getElementById("iconDelete")),this.deleteButton=new RectButton("deleteButton",0,0,i,{fill:"white",stroke:"black",rx:2,width:30,height:30},{fill:"yellow"},{fill:"orange"},4,!1),this.deleteButton.addActionListener(this),this.deleteButton.setToggle(!0),this.radioButtonGroup.addButton(this.deleteButton);var s=new SVGElement;s.cloneElement(this.controller.artwork.getElementById("iconUpArrow")),this.upArrowButton=new RectButton("upArrowButton",0,0,s,{fill:"white",stroke:"black",rx:2,width:30,height:30},{fill:"yellow"},{fill:"orange"},4,!1),this.upArrowButton.addActionListener(this),this.upArrowButton.setToggle(!0),this.radioButtonGroup.addButton(this.upArrowButton);var o=new SVGElement;o.cloneElement(this.controller.artwork.getElementById("iconDownArrow")),this.downArrowButton=new RectButton("downArrowButton",0,0,o,{fill:"white",stroke:"black",rx:2,width:30,height:30},{fill:"yellow"},{fill:"orange"},4,!1),this.downArrowButton.addActionListener(this),this.downArrowButton.setToggle(!0),this.radioButtonGroup.addButton(this.downArrowButton);var u=new SVGElement;u.cloneElement(this.controller.artwork.getElementById("iconRotateRight")),this.rotateRightArrowButton=new RectButton("rotateRightArrowButton",0,0,u,{fill:"white",stroke:"black",rx:2,width:30,height:30},{fill:"yellow"},{fill:"orange"},4,!1),this.rotateRightArrowButton.addActionListener(this),this.rotateRightArrowButton.setToggle(!0),this.radioButtonGroup.addButton(this.rotateRightArrowButton);var a=new SVGElement;a.cloneElement(this.controller.artwork.getElementById("iconRotateLeft")),this.rotateLeftArrowButton=new RectButton("rotateLeftArrowButton",0,0,a,{fill:"white",stroke:"black",rx:2,width:30,height:30},{fill:"yellow"},{fill:"orange"},4,!1),this.rotateLeftArrowButton.addActionListener(this),this.rotateLeftArrowButton.setToggle(!0),this.radioButtonGroup.addButton(this.rotateLeftArrowButton),this.lightLevelWindow=new LightLevelWindow(this.controller),this.lightLevelWindow.hide(),this.lightLevelWindow.x==0&&this.lightLevelWindow.y==0&&this.lightLevelWindow.setPosition(0,260),this.editRoot.appendChild(this.lightLevelWindow),this.lightLevelWindow.addActionListener(this),this.lightLevelWindow.lightAppearanceButton.addActionListener(this),this.lightLevelWindow.lightAppearanceButton.setToggle(!0),this.radioButtonGroup.addButton(this.lightLevelWindow.lightAppearanceButton),this.blockItemWindow=new BlockItemWindow(this.controller),this.blockItemWindow.hide(),this.blockItemWindow.x==0&&this.blockItemWindow.y==0&&this.blockItemWindow.setPosition(175,330),this.editRoot.appendChild(this.blockItemWindow),this.blockItemWindow.addActionListener(this),this.blockItemWindow.itemAppearanceButton.addActionListener(this),this.blockItemWindow.itemAppearanceButton.setToggle(!0),this.radioButtonGroup.addButton(this.blockItemWindow.itemAppearanceButton),this.itemWindow=new ItemWindow(this.controller),this.itemWindow.hide(),this.itemWindow.x==0&&this.itemWindow.y==0&&this.itemWindow.setPosition(0,330),this.editRoot.appendChild(this.itemWindow),this.itemWindow.addActionListener(this),this.editRoot.appendChild(this.itemWindow.teleportWindow),this.itemWindow.itemAppearanceButton.addActionListener(this),this.itemWindow.itemAppearanceButton.setToggle(!0),this.radioButtonGroup.addButton(this.itemWindow.itemAppearanceButton),this.editBar=[];for(var f=0;f<4;f++){var l=new FlowLayout(0,0,{minSpacing:5});this.editBar.push(l),this.contents.appendChild(l)}this.editBar[0].appendChild(this.deleteButton),this.editBar[0].appendChild(this.upArrowButton),this.editBar[1].appendChild(this.lightLevelWindow.lightAppearanceButton),this.editBar[1].appendChild(this.downArrowButton),this.editBar[2].appendChild(this.blockItemWindow.itemAppearanceButton),this.editBar[2].appendChild(this.itemWindow.itemAppearanceButton),this.editBar[3].appendChild(this.rotateLeftArrowButton),this.editBar[3].appendChild(this.rotateRightArrowButton),this.finalButtonsBar=new FlowLayout(0,0,{minSpacing:3}),this.contents.appendChild(this.finalButtonsBar),this.saveMapButton=new SimpleButton("savemap","rect",{width:40,height:20,rx:3,fill:"lightgreen",stroke:"black","stroke-width":2},0,0,{normal:{stroke:"black",fill:"lightgreen"},over:{stroke:"red"},focus:{stroke:"red"},select:{fill:"green"},disable:{fill:"gray"}}),this.saveMapButton.addSVG("text",{"font-size":15,fill:"black",x:5,y:15},"Save"),this.saveMapButton.addActionListener(this),this.finalButtonsBar.appendChild(this.saveMapButton),this.playButton=new RectButton("play",0,0,new SVGElement("text",{"font-size":12},"Play"),{fill:"lightblue",stroke:"black",rx:2},{fill:"orange"},{fill:"red"},2,!1),this.playButton.addActionListener(this),this.finalButtonsBar.appendChild(this.playButton),this.zoomSlider=new Slider({orientation:"h",sliderLength:65,startPosition:.5}),this.zoomSlider.addActionListener(this),this.contents.appendChild(this.zoomSlider)}function TextEditWindow(e,t,n){TextEditWindow.baseConstructor.call(this,t,5,{fill:"white",stroke:"green",rx:4},{width:205,height:86,storePrefix:"MW_TextEditWindow",contentsSpacing:3}),this.controller=e,this.textbox=new TextArea("myText",this.controller.background,{width:200,height:30,fill:"white","stroke-width":3},{"font-size":20,fill:"black",x:5,y:20},0,0,{normal:{stroke:"black"},focus:{stroke:"red"}}),this.contents.appendChild(this.textbox),this.textbox.setValue(n);var r=new FlowLayout(0,0,{minSpacing:20});this.okButton=new RectButton("OK",0,0,new SVGElement("text",{y:12,"font-size":12},"OK"),{fill:"lightblue",stroke:"black",rx:2},{fill:"orange"},{fill:"red"},2,!1),this.okButton.addActionListener(this),r.appendChild(this.okButton),this.cancelButton=new RectButton("Cancel",0,0,new SVGElement("text",{y:12,"font-size":12},"Cancel"),{fill:"lightblue",stroke:"black",rx:2},{fill:"orange"},{fill:"red"},2,!1),this.cancelButton.addActionListener(this),r.appendChild(this.cancelButton),this.contents.appendChild(r)}function AdminWindow(e,t){AdminWindow.baseConstructor.call(this,"Mezzacotta World v"+g_mwVersion,5,{fill:"lightGreen",stroke:"green",rx:4},{width:183,height:104,storePrefix:"MW_AdminWindow",contentsSpacing:3}),this.controller=e,this.controller.addActionListener(this),this.contents.appendChild(t),this.worldLabelGroup=new FlowLayout(0,0,{minSpacing:5}),this.worldLabelGroup.appendChild(new SVGElement("text",{y:12,"font-size":12,fill:"black"},"Current world:")),this.worldLabel=new TextLabel("foobarworld",{"font-size":12,fill:"black"}),this.worldLabelGroup.appendChild(this.worldLabel),this.contents.appendChild(this.worldLabelGroup),this.editMapButtonEditText=new SVGElement("text",{y:12,"font-size":12},"Edit"),this.editMapButtonPlayText=new SVGElement("text",{y:12,"font-size":12},"Play"),this.editMapButton=new RectButton("editmap",0,0,this.editMapButtonEditText,{fill:"lightblue",stroke:"black",rx:2},{fill:"orange"},{fill:"red"},2,!1),this.editMapButton.addActionListener(this),this.worldLabelGroup.appendChild(this.editMapButton),this.renameWorldButton=new RectButton("renameworld",0,0,new SVGElement("text",{y:12,"font-size":12},"Rename World"),{fill:"lightblue",stroke:"black",rx:2},{fill:"orange"},{fill:"red"},2,!1),this.renameWorldButton.addActionListener(this),this.contents.appendChild(this.renameWorldButton),this.newWorldButton=new RectButton("newworld",0,0,new SVGElement("text",{y:12,"font-size":12},"Change World"),{fill:"lightblue",stroke:"black",rx:2},{fill:"orange"},{fill:"red"},2,!1),this.newWorldButton.addActionListener(this),this.contents.appendChild(this.newWorldButton),this.isDebugging=!1,this.debugText=new SVGElement("text",{y:12,"font-size":12},"Debug"),this.debugButton=new RectButton("debug",0,0,this.debugText,{fill:"lightblue",stroke:"black",rx:2},{fill:"orange"},{fill:"red"},2,!1),this.debugButton.addActionListener(this),this.contents.appendChild(this.debugButton)}function WorldChooserWindow(e,t){this.params=t,this.params==null&&(this.params=[]),this.params.windowName||(this.params.windowName="Window Chooser"),WorldChooserWindow.baseConstructor.call(this,this.params.windowName,5,{fill:"lightGreen",stroke:"green",rx:4},{width:150,storePrefix:"MW_WorldChooserWindow",contentsSpacing:3}),this.controller=e,this.controller.addActionListener(this);for(var n in this.controller.visitedWorlds)this.addWorld(this.controller.visitedWorlds[n])}function AvatarController(e,t,n){AvatarController.baseConstructor.call(this),this.controller=e,this.avatarIndex=t,this.avatarItem=this.controller.itemFactory.makeItem(n),this.avatarItem.params.isTemporary=!0,this.avatarItem.params.itemTags.push("avatar"),this.avatarItem.id="avatar_"+this.avatarIndex,this.avatarItem.povHeight=25,this.registerAvatar(),this.heldItems=[],this.weildedItem=null}function AvatarGroupController(e){AvatarGroupController.baseConstructor.call(this),this.controller=e,this.avatarList=[],this.currentAvatar=null,this.visibleCells=[],this.xmlInventory=null}function InventoryViewItem(e,t){this.gridItem=t,this.gridItem.addActionListener(this),this.inventoryWindow=e,this.inventorySlot=null,this.itemCopy=this.inventoryWindow.controller.itemFactory.makeItem(this.gridItem.params.itemCode);var n=this.inventoryWindow.controller.itemFactory.makeViewItem(this.itemCopy);this.itemCopy.addActionListener(n),InventoryViewItem.baseConstructor.call(this,"dragItem",0,0,n,{fill:"none",stroke:"none",rx:2,width:40,height:40}),this.addActionListener(this.inventoryWindow)}function InventorySlot(e,t,n,r){InventorySlot.baseConstructor.call(this),this.inventoryWindow=e,this.x=t,this.y=n,this.viewItem=null,this.slotIndex=r}function InventoryWindow(e){InventoryWindow.baseConstructor.call(this,"Inventory",5,{fill:"none",stroke:"green",rx:4},{width:382,height:225,storePrefix:"MW_InventoryWindow",contentsSpacing:3}),this.controller=e,this.avatar=null,this.snapDistance=20,this.inventorySlots=[],this.inventorySlots.push(new InventorySlot(this,14,85,this.inventorySlots.length)),this.inventorySlots.push(new InventorySlot(this,74,83,this.inventorySlots.length)),this.inventorySlots.push(new InventorySlot(this,147,23,this.inventorySlots.length)),this.inventorySlots.push(new InventorySlot(this,147,85,this.inventorySlots.length)),this.inventorySlots.push(new InventorySlot(this,147,142,this.inventorySlots.length)),this.inventorySlots.push(new InventorySlot(this,207,23,this.inventorySlots.length)),this.inventorySlots.push(new InventorySlot(this,207,85,this.inventorySlots.length)),this.inventorySlots.push(new InventorySlot(this,207,142,this.inventorySlots.length)),this.inventorySlots.push(new InventorySlot(this,267,23,this.inventorySlots.length)),this.inventorySlots.push(new InventorySlot(this,267,85,this.inventorySlots.length)),this.inventorySlots.push(new InventorySlot(this,267,142,this.inventorySlots.length)),this.inventorySlots.push(new InventorySlot(this,327,23,this.inventorySlots.length)),this.inventorySlots.push(new InventorySlot(this,327,85,this.inventorySlots.length)),this.inventorySlots.push(new InventorySlot(this,327,142,this.inventorySlots.length)),this.itemArea=new SVGComponent(0,0),this.contents.appendChild(this.itemArea),this.itemArea.childConstraints={x:0,y:0,width:382,height:195}}function GameServerInterface(e){this.controller=e}function TurnClock(){this.currentTime=0}function GameController(e,t,n,r){GameController.baseConstructor.call(this),this.current_map_id=-1,this.background=e,this.background.addActionListener(this),this.overLayer=wrapElementById("overLayer"),this.overLayer.childConstraints={x:0,y:0,width:1e3,height:1e3},this.overLayer.show();var i=document.getElementById("loginArea");this.loginController=new LoginController(e,this.overLayer),this.loginController.loginTextbox.setFocus(!0),this.loginController.addActionListener(this),this.gameServerInterface=new GameServerInterface(this),this.adminWindow=new AdminWindow(this,this.loginController.logoutGroup),this.overLayer.appendChild(this.adminWindow),this.adminWindow.hide(),this.adminWindow.addActionListener(this),this.visitedWorldNotifier=new ActionObject,this.worldChooserWindow=new WorldChooserWindow(this,{windowName:"World Chooser"}),this.overLayer.appendChild(this.worldChooserWindow),this.worldChooserWindow.hide(),this.worldChooserWindow.addActionListener(this),this.visitedWorldNotifier.addActionListener(this.worldChooserWindow),this.inventoryWindow=new InventoryWindow(this,{windowName:"inventory"}),this.overLayer.appendChild(this.inventoryWindow),this.inventoryWindow.hide(),this.inventoryWindow.addActionListener(this),this.editLayer=wrapElementById("editLayer"),this.editLayer.childConstraints={x:0,y:0,width:1e3,height:1e3},this.editLayer.hide(),this.itemFactory=t,this.model=n,this.view=r,this.view.addActionListener(this),this.avatarGroupController=new AvatarGroupController(this),this.isActive=!1,this.canEdit=!1,this.editMode=!1,this.turnClock=new TurnClock,this.actionController=new ActionController(this.model,this,this.turnClock);var s=this.avatarGroupController.addAvatar("b");this.inventoryWindow.setAvatar(s),this.clearPlayerData()}function parseKeycodesAndCharcodes(e,t){var n=null;switch(t){case 0:break;case 119:n="up";break;case 97:n="left";break;case 115:n="down";break;case 100:n="right";break;case 105:n="inventory";break;case 32:n="wait";break;case 43:n="zoom_out";break;case 45:n="zoom_in"}switch(e){case 0:break;case 37:n="left";break;case 38:n="up";break;case 39:n="right";break;case 40:n="down"}return n}function init(){var e=new Background,t={s:["Sand","#d1df5d","#c1cf4d","#b1bf3d",!0,50],m:["Mud","#808000","#707000","#606000",!0,50],e:["Earth","#79621c","#695218","#594210",!0,50],f:["Field","#00ff00","#00ee00","#00dd00",!0,50],g:["Grass","#33c52e","#28b520","#20a518",!0,40],h:["Hedge","#108010","#0c700c","#096009",!0,40],a:["Aqua","#00eeee","#00dddd","#00cccc",!1,30],w:["Water","#4b60e5","#3b50d5","#3240c5",!1,30],o:["Ocean","#0000dd","#0000cc","#0000aa",!1,30],c:["Clay","#a0522d","#954623","#80391b",!0,60],r:["Rock","#696969","#595959","#494949",!0,100],d:["Stone","#506070","#405060","#304050",!0,100]},n={x:{itemName:"boulder01",fullname:"Large Boulder",itemCode:"x",ht:20,wt:1e3,isPushable:!0,blockView:!0},X:{itemName:"tree01",fullname:"Palm Tree",itemCode:"X",ht:30,wt:400},".":{itemName:"pebbles01",fullname:"Pebbles",itemCode:".",canStandOn:!0},z:{itemName:"brazier01",fullname:"Brazier",itemCode:"z",ht:10,wt:20,itemTags:["burning"],tagParams:{burning:{lightStrength:.7,lightRadius:4}},useActions:[{otherTag:"burning",addTag:"burning"}]},i:{itemName:"coin01",fullname:"Coin",itemCode:"i",wt:.1,canStandOn:!0,isTakeable:!0,isSaveable:!0},k:{itemName:"key01",fullname:"Key",itemCode:"k",wt:.1,canStandOn:!0,isTakeable:!0,isSaveable:!0},I:{itemName:"stick01",fullname:"Stick",itemCode:"I",wt:.1,canStandOn:!0,isTakeable:!0,isSaveable:!0,canWeild:!0,tagParams:{burning:{lightStrength:.7,lightRadius:4}},useActions:[{otherTag:"burning",addTag:"burning"}]},j:{itemName:"ghost01",fullname:"Ghost",itemCode:"j",ht:10,povRange:4},G:{itemName:"golem01",fullname:"Golem",itemCode:"G",ht:20,wt:500,povRange:4,climbHeight:0},L:{itemName:"goblin01",fullname:"Goblin",itemCode:"L",ht:10,wt:30,povRange:4,climbHeight:5,moveTowards:["b"],scaredOf:["b"]},Z:{itemName:"zombie01",fullname:"Zombie",itemCode:"Z",ht:20,wt:100,povRange:4,climbHeight:0,moveTowards:["b"]},Y:{itemName:"zombie02",fullname:"Ghoul",itemCode:"Y",ht:20,wt:100,povRange:4,climbHeight:0,moveTowards:["b"]},T:{itemName:"teleport01",fullname:"Teleport",itemCode:"T",canStandOn:!0,doesTeleport:!0},S:{itemName:"start01",fullname:"Start Square",itemCode:"S",canStandOn:!0,isInvisible:!0},b:{itemName:"avatar02",fullname:"Avatar",itemCode:"b",ht:20,wt:100,povRange:9,climbHeight:10,dropHeight:20,noEdit:!0},t:{itemName:"tag01",fullname:"Item Tag",itemCode:"t",noEdit:!0},B:{itemName:"barrel01",fullname:"Barrel",itemCode:"B",ht:20,wt:1e3,isPushable:!0,blockView:!0,canStandOn:!0}},r=new PerspectiveItemFactory(0,25,15,n,t),i=document.getElementById("persCoverLayer"),s=new PerspectiveGridModel(r),o=wrapElementById("persPlayArea"),u=new PerspectiveGridView(s,r,16,26,0,0,25,15);o.appendChild(u),gController=new GameController(e,r,s,u),updateLayout(),gWindow.onresize=updateLayout,gController.start()}function updateLayout(){var e=document.getElementById("baseBG").getBBox();gController.editLayer.childConstraints=e;var t=375,n=330,r=e.width,i=e.height,s=r/t,o=i/n,u=s<o?s:o,a=(r-t*u)/2,f=(i-n*u)/2;gController.view.setBounds(e),gController.loginController.loginGroup.setPosition((e.width-300)/2,(e.height-150)/2);var l=document.getElementById("loadingNotification");l.children[0].setAttribute("x",e.width/2-40),l.children[0].setAttribute("y",e.height/2-20),l.children[1].setAttribute("x",e.width/2-30),l.children[1].setAttribute("y",e.height/2)}g_mwVersion="0.4";var g_config=new MW_Config,svgns="http://www.w3.org/2000/svg",xmlns="http://www.w3.org/XML/1998/namespace",xlinkns="http://www.w3.org/1999/xlink";KevLinDev={},KevLinDev.extend=function(e,t){function n(){}n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e,e.baseConstructor=t,e.superClass=t.prototype},ActionObject.prototype.addActionListener=function(e){this.actionListeners.push(e)},ActionObject.prototype.removeActionListener=function(e){for(var t=0;t<this.actionListeners.length;++t)if(this.actionListeners[t]==e){this.actionListeners.splice(t,1);break}},ActionObject.prototype.clearActionListeners=function(){this.actionListeners=[]},ActionObject.prototype.handleEvent=function(e){this.tellActionListeners(this,e)},ActionObject.prototype.tellActionListeners=function(e,t){for(var n=0;n<this.actionListeners.length;++n)this.actionListeners[n].doAction(e,t)},ActionObject.prototype.addResizeListener=function(e){this.resizeListeners.push(e)},ActionObject.prototype.removeResizeListener=function(e){for(var t=0;t<this.resizeListeners.length;++t)if(this.resizeListeners[t]==e){this.resizeListeners.splice(t,1);break}},ActionObject.prototype.clearResizeListeners=function(){this.resizeListeners=[]},ActionObject.prototype.tellResizeListeners=function(e){for(var t=0;t<this.resizeListeners.length;++t)this.resizeListeners[t].notifyResize(e)},KevLinDev.extend(SVGElement,ActionObject),SVGElement.prototype.wrapElement=function(e){if(e==null)return;this.src=e.nodeName,this.svg=e,this.showing=!0,e.hasAttribute("display")&&e.getAttribute("display")=="none"&&(this.showing=!1);for(var t=0;t<e.children.length;t++){var n=new SVGElement;n.wrapElement(e.children[t]),this.childNodes.push(n),this.childNodes.length==1&&(this.firstChild=n),this.lastChild=n}},SVGElement.prototype.cloneElement=function(e){this.wrapElement(e.cloneNode(!0))},SVGElement.prototype.addAttributes=function(e){if(!e)return;for(var t in e){var n=null;t.match(/^xlink:/)&&(n="http://www.w3.org/1999/xlink"),this.svg.setAttributeNS(n,t,e[t])}},SVGElement.prototype.show=function(){this.svg.setAttribute("display","inline"),this.showing=!0},SVGElement.prototype.hide=function(){this.svg.setAttribute("display","none"),this.showing=!1},SVGElement.prototype.isShowing=function(){return this.showing},SVGElement.prototype.hasParent=function(){return this.parentNode!=null},SVGElement.prototype.detach=function(){this.parentNode!=null&&this.parentNode.removeChild(this)},SVGElement.prototype.doAction=function(e,t){},SVGElement.prototype.notifyResize=function(e){},SVGElement.prototype.hasAttribute=function(e){return this.svg.hasAttribute(e)},SVGElement.prototype.getAttribute=function(e){return this.svg.getAttribute(e)},SVGElement.prototype.setAttribute=function(e,t){this.svg.setAttribute(e,t)},SVGElement.prototype.setAttributeNS=function(e,t,n){this.svg.setAttributeNS(e,t,n)},SVGElement.prototype.removeAttribute=function(e){this.svg.removeAttribute(e)},SVGElement.prototype.setValue=function(e){this.tnode==null?(this.tnode=document.createTextNode(e),this.svg.appendChild(this.tnode)):this.tnode.nodeValue=e},SVGElement.prototype.prependChild=function(e){this.svg.firstChild!=null?this.svg.insertBefore(e.svg,this.svg.firstChild):this.svg.appendChild(e.svg),this.childNodes.unshift(e),this.firstChild=this.childNodes[0],e&&(e.parentNode=this)},SVGElement.prototype.appendChild=function(e){this.svg.appendChild(e.svg),this.childNodes.push(e),this.childNodes.length==1&&(this.firstChild=e),this.lastChild=e,e&&(e.parentNode=this)},SVGElement.prototype.insertBefore=function(e,t){this.svg.insertBefore(e.svg,t.svg);var n=0;for(var r=0;r<this.childNodes.length;++r)if(this.childNodes[r]==t){this.childNodes.splice(r,0,e);break}this.firstChild=this.childNodes[0],e&&(e.parentNode=this)},SVGElement.prototype.insertAfter=function(e,t){t!=null&&t.svg.nextSibling!=null?this.svg.insertBefore(e.svg,t.svg.nextSibling):this.svg.appendChild(e.svg),this.lastChild=this.childNodes[this.childNodes.length-1]},SVGElement.prototype.removeChild=function(e){if(e==null)return;this.svg.removeChild(e.svg);for(var t=0;t<this.childNodes.length;++t)if(this.childNodes[t]==e){this.childNodes.splice(t,1),this.firstChild=this.childNodes[0],this.lastChild=this.childNodes[this.childNodes.length-1],e.parentNode=null;break}},SVGElement.prototype.removeChildByIndex=function(e){if(e<0||e>=this.childNodes.length)return;this.childNodes[e].parentNode=null,this.svg.removeChild(this.childNodes[e].svg),this.childNodes.splice(e,1),this.firstChild=this.childNodes[0],this.lastChild=this.childNodes[this.childNodes.length-1]},SVGElement.prototype.removeChildren=function(){while(this.svg.firstChild)this.svg.removeChild(this.svg.firstChild);this.childNodes=[],this.firstChild=null,this.lastChild=null},SVGElement.prototype.addEventListener=function(e,t,n){this.svg.addEventListener(e,t,n)},SVGElement.prototype.getVisualBBox=function(){var e=this.svg.cloneNode(!0);e=replaceClipPaths(e),e.setAttribute("visibility","hidden"),document.documentElement.appendChild(e);var t=e.getBBox();return document.documentElement.removeChild(e),t},SVGElement.prototype.getBBox=function(){var e=this.svg;while(e.parentNode!=null)e=e.parentNode;if(e==document.documentElement)try{bbox=this.svg.getBBox()}catch(t){bbox=null}else{var n=this.svg.nextSibling,r=this.svg.parentNode;document.documentElement.appendChild(this.svg);try{bbox=this.svg.getBBox()}catch(t){bbox=null}r?n?r.insertBefore(this.svg,n):r.appendChild(this.svg):document.documentElement.removeChild(this.svg)}return bbox},KevLinDev.extend(SVGRoot,SVGElement),SVGRoot.prototype.setPosition=function(e,t){e!=null&&(this.clipBox.x=e,this.setAttribute("x",e)),t!=null&&(this.clipBox.y=t,this.setAttribute("y",t))},SVGRoot.prototype.setClipRect=function(e){this.clipBox=e,this.setAttribute("x",this.clipBox.x),this.setAttribute("y",this.clipBox.y),this.setAttribute("width",this.clipBox.width),this.setAttribute("height",this.clipBox.height)},KevLinDev.extend(SVGComponent,SVGElement),SVGComponent.prototype.addAuxiliaryComponent=function(e){this.auxiliaryComponents.push(e)},SVGComponent.prototype.setPosition=function(e,t){e==null&&(e=0),t==null&&(t=0);if(this.parentNode!=null&&this.parentNode.childConstraints){var n=this.getBBox();n&&(e<this.parentNode.childConstraints.x?e=this.parentNode.childConstraints.x:e>this.parentNode.childConstraints.x+this.parentNode.childConstraints.width-n.width&&(e=this.parentNode.childConstraints.x+this.parentNode.childConstraints.width-n.width),t<this.parentNode.childConstraints.y?t=this.parentNode.childConstraints.y:t>this.parentNode.childConstraints.y+this.parentNode.childConstraints.height-n.height&&(t=this.parentNode.childConstraints.y+this.parentNode.childConstraints.height-n.height))}this.x=e,this.y=t;var r="";this.scale!=1&&(r="scale("+this.scale+") "),this.svg.setAttribute("transform",r+"translate("+this.x+","+this.y+") ");for(var i=0;i<this.auxiliaryComponents.length;++i)this.auxiliaryComponents[i].setPosition(e,t)},SVGComponent.prototype.setScale=function(e){e==null?this.scale=1:this.scale=e;var t="";this.scale!=1&&(t="scale("+this.scale+") "),this.svg.setAttribute("transform",t+"translate("+this.x+","+this.y+") ");for(var n=0;n<this.auxiliaryComponents.length;++n)this.auxiliaryComponents[n].setScale(e)},SVGComponent.prototype.setBackground=function(e){this.background=e},SVGComponent.prototype.setFocusManager=function(e){this.focusManager=e},SVGComponent.prototype.doAction=function(e,t){SVGComponent.superClass.doAction.call(this,e,t);if(t.type=="keypress"){var n=t.keyCode;t.charCode&&(n=t.charCode),n==9&&t.shiftKey?(this.previousFocus(),t.preventDefault()):n==9&&(this.nextFocus(),t.preventDefault())}},SVGComponent.prototype.setFocus=function(){this.hasFocus||(this.focusManager&&this.focusManager.setFocus(),this.background&&(this.background.addActionListener(this),this.background.setFocus(this)),this.hasFocus=!0,this.tellFocusListeners(this))},SVGComponent.prototype.loseFocus=function(){this.hasFocus&&(this.focusManager&&this.focusManager.loseFocus(),this.background&&(this.background.removeActionListener(this),this.background.focus==this&&this.background.setFocus(null)),this.hasFocus=!1)},SVGComponent.prototype.setNextFocus=function(e){this.nextFocusComponent=e},SVGComponent.prototype.setPreviousFocus=function(e){this.previousFocusComponent=e},SVGComponent.prototype.nextFocus=function(){this.loseFocus(),this.nextFocusComponent&&this.nextFocusComponent.setFocus()},SVGComponent.prototype.previousFocus=function(){this.loseFocus(),this.previousFocusComponent&&this.previousFocusComponent.setFocus()},SVGComponent.prototype.addFocusListener=function(e){this.focusListeners.push(e)},SVGComponent.prototype.removeFocusListener=function(e){for(var t=0;t<this.focusListeners.length;++t)if(this.focusListeners[t]==e){this.focusListeners.splice(t,1);break}},SVGComponent.prototype.clearFocusListeners=function(){this.focusListeners=new Array},SVGComponent.prototype.tellFocusListeners=function(e){for(var t=0;t<this.focusListeners.length;++t)this.focusListeners[t].focusChangeRequest(e)},SVGComponent.prototype.focusChangeRequest=function(e){e!=this&&this.loseFocus()},SVGComponent.prototype.toXML=function(){var e="<base src='"+this.src+"'>";for(var t=0;t<this.actionListeners.length;++t)e+="<listener src='"+this.actionListeners[t].src+"'/>";return e+="</base>",e};var gNamedColorList={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],grey:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255
],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]};KevLinDev.extend(SimpleButton,SVGComponent),SimpleButton.prototype.addSVG=function(e,t,n){var r=new SVGElement(e,t,n);return this.appendChild(r),this.liftButtonCover(),r},SimpleButton.prototype.liftButtonCover=function(){this.appendChild(this.svg_buttonCover)},SimpleButton.prototype.doAction=function(e,t){SimpleButton.superClass.doAction.call(this,this,t);if(this.isAble)if(!this.hasFocus)t.type=="mouseover"?this.svg_border.addAttributes(this.states.over):t.type=="mouseout"?this.doToggle&&this.toggleState==1?this.svg_border.addAttributes(this.states.select):this.svg_border.addAttributes(this.states.normal):t.type=="mousedown"?this.doToggle?(this.toggleState=!this.toggleState,this.toggleState==1?this.svg_border.addAttributes(this.states.select):this.svg_border.addAttributes(this.states.normal)):this.svg_border.addAttributes(this.states.select):t.type=="mouseup"&&!this.doToggle&&this.svg_border.addAttributes(this.states.normal);else if(t.type=="keypress"){var n=t.keyCode;t.charCode&&(n=t.charCode);if(n==10||n==13)this.loseFocus(),this.tellActionListeners(this,t)}},SimpleButton.prototype.setAble=function(e){e?(this.isAble=!0,this.svg_border.addAttributes(this.states.normal),this.svg_buttonCover.show()):(this.isAble=!1,this.svg_buttonCover.hide(),this.svg_border.addAttributes(this.states.disable))},SimpleButton.prototype.setFocus=function(){this.hasFocus||this.svg_border.addAttributes(this.states.focus),SimpleButton.superClass.setFocus.call(this)},SimpleButton.prototype.loseFocus=function(){this.hasFocus&&this.svg_border.addAttributes(this.states.normal),SimpleButton.superClass.loseFocus.call(this)},SimpleButton.prototype.setToggle=function(e){this.doToggle=e},SimpleButton.prototype.setSelected=function(e){e?(this.svg_border.addAttributes(this.states.select),this.doToggle&&(this.toggleState=!0)):(this.svg_border.addAttributes(this.states.normal),this.doToggle&&(this.toggleState=!1))},KevLinDev.extend(ParamButton,SVGComponent),ParamButton.prototype.doAction=function(e,t){ParamButton.superClass.doAction.call(this,this,t),this.isAble&&(t.type=="mouseover"?this.svg_mouseover.show():t.type=="mouseout"?(this.svg_mouseover.hide(),this.toggleState==0&&this.svg_select.hide()):t.type=="mousedown"?this.doToggle?(this.toggleState=!this.toggleState,this.toggleState==1?this.svg_select.show():this.svg_select.hide()):this.svg_select.show():t.type=="mouseup"&&!this.doToggle&&this.svg_select.hide())},ParamButton.prototype.setAble=function(e){e?(this.isAble=!0,this.svg_cover.show()):(this.isAble=!1,this.svg_cover.hide())},ParamButton.prototype.setSelected=function(e){e?(this.svg_select.show(),this.doToggle&&(this.toggleState=!0)):(this.svg_select.hide(),this.doToggle&&(this.toggleState=!1))},ParamButton.prototype.setToggle=function(e){this.doToggle=e},ParamButton.prototype.setContents=function(e){this.svg_contents!=null&&this.removeChild(this.svg_contents),e!=null&&this.insertBefore(e,this.svg_mouseover),this.svg_contents=e},KevLinDev.extend(ParamButton2,SVGComponent),ParamButton2.prototype.updateCover=function(){var e=this.isSelected?this.params.selectedElements.cover:this.params.normalElements.cover;if(e==this.cover)return;this.cover&&this.cover.detach();if(!e)return;this.doSeparateCoverLayer?(this.cover=new SVGComponent(x,y),this.cover.appendChild(e),this.addAuxiliaryComponent(this.cover)):(this.cover=e,this.appendChild(this.cover))},ParamButton2.prototype.updateAppearance=function(){var e=this.isSelected?this.params.selectedElements:this.params.normalElements;if(!e)return;var t=this.isDisabled?"disabled":this.isMouseover?"mouseover":"normal",n=null;e[t]&&(n=e[t]),!n&&e.normal&&(n=e.normal);if(n==this.appearance)return;n!=null&&(this.appearance!=null&&this.appearance.detach(),this.appearance=n,this.prependChild(this.appearance))},ParamButton2.prototype.doAction=function(e,t){ParamButton2.superClass.doAction.call(this,this,t),this.isDisabled||(t.type=="mouseover"?this.isMouseover=!0:t.type=="mouseout"?this.isMouseover=!1:t.type=="mousedown"?this.doToggle?this.isSelected=!this.isSelected:this.isSelected=!0:t.type!="mouseup",this.updateAppearance())},ParamButton2.prototype.setAble=function(e){this.isDisabled=!e,this.updateAppearance()},ParamButton2.prototype.setSelected=function(e){this.isSelected=e,this.updateAppearance()},ParamButton2.prototype.setToggle=function(e){this.doToggle=e},RadioButtonGroup.prototype.addButton=function(e){this.buttons.push(e),e.addActionListener(this)},RadioButtonGroup.prototype.doAction=function(e,t){t.type=="mousedown"&&this.setSelected(e)},RadioButtonGroup.prototype.setSelected=function(e){this.currentSelection=e,e.setSelected(!0);for(var t in this.buttons)this.buttons[t]!=e&&this.buttons[t].setSelected(!1)},KevLinDev.extend(ScaledComponent,SVGComponent),ScaledComponent.prototype.setContents=function(e){this.contents=e,this.contentElement.removeChildren(),this.contents!=null&&this.contentElement.appendChild(e),this.refreshLayout()},ScaledComponent.prototype.notifyResize=function(e){ScaledComponent.superClass.notifyResize.call(this,e),this.refreshLayout()},ScaledComponent.prototype.refreshLayout=function(){if(this.contents==null)return;var e=this.contents.getBBox();this.contentElement.setPosition(-e.x,-e.y);if(this.width!=null||this.height!=null)if(this.width==null){var t=1;e.height>0&&(t=this.height/e.height),this.contentElement.setScale(t)}else if(this.height==null){var t=1;e.width>0&&(t=this.width/e.width),this.contentElement.setScale(t)}else{var t=1;e.width>0&&e.height>0&&(t=Math.min(this.width/e.width,this.height/e.height)),this.contentElement.setScale(t)}this.tellResizeListeners(this)},KevLinDev.extend(RectLabel,SVGComponent),RectLabel.prototype.setContents=function(e){this.contents=e,this.contentElement.removeChildren(),this.contents!=null&&this.contentElement.appendChild(e),this.refreshLayout()},RectLabel.prototype.notifyResize=function(e){RectLabel.superClass.notifyResize.call(this,e),this.refreshLayout()},RectLabel.prototype.refreshLayout=function(){var e=null;if(this.bgRect==null)return;if(this.contents==null){this.bgRect.setAttribute("width",this.rectAttributes.width),this.bgRect.setAttribute("height",this.rectAttributes.height);return}e=this.contents.getBBox(),this.contentElement.setPosition(-e.x,-e.y);if(!this.isWidthSpecified&&!this.isHeightSpecified)this.rectAttributes.width=e.width+this.borderWidth*2,this.rectAttributes.height=e.height+this.borderWidth*2,this.bgRect.setAttribute("width",this.rectAttributes.width),this.bgRect.setAttribute("height",this.rectAttributes.height);else if(!this.isWidthSpecified){var t=this.rectAttributes.height-this.borderWidth*2;t<=this.borderWidth&&(t=this.borderWidth);var n=1;e.height>0&&(n=t/e.height),this.contentElement.setScale(n),this.rectAttributes.width=e.width*n+this.borderWidth*2,this.bgRect.setAttribute("width",this.rectAttributes.width),this.bgRect.setAttribute("height",this.rectAttributes.height)}else if(!this.isHeightSpecified){var r=this.rectAttributes.width-this.borderWidth*2;r<=this.borderWidth&&(r=this.borderWidth);var n=1;e.width>0&&(n=r/e.width),this.contentElement.setScale(n),this.rectAttributes.height=e.height*n+this.borderWidth*2,this.bgRect.setAttribute("height",this.rectAttributes.height),this.bgRect.setAttribute("width",this.rectAttributes.width)}else{var t=this.rectAttributes.height-this.borderWidth*2;t<=this.borderWidth&&(t=this.borderWidth);var r=this.rectAttributes.width-this.borderWidth*2;r<=this.borderWidth&&(r=this.borderWidth);var n=1;e.height>0&&e.width>0&&(n=Math.min(t/e.height,r/e.width));var i=(r-n*e.width)/2,s=(t-n*e.height)/2;this.contentElement.setScale(n),this.contentHolder.setPosition(this.borderWidth+i,this.borderWidth+s),this.bgRect.setAttribute("width",this.rectAttributes.width),this.bgRect.setAttribute("height",this.rectAttributes.height)}this.tellResizeListeners(this)},KevLinDev.extend(RectButton,ParamButton),RectButton.prototype.setContents=function(e){this.bgElement.setContents(e),this.refreshLayout()},RectButton.prototype.refreshLayout=function(){this.bgElement.refreshLayout(),this.mouseoverElement.setAttribute("width",this.bgElement.rectAttributes.width),this.mouseoverElement.setAttribute("height",this.bgElement.rectAttributes.height),this.mouseoverElement.setAttribute("opacity",.3);for(var e in this.mouseoverAttributes)this.mouseoverElement.setAttribute(e,this.mouseoverAttributes[e]);this.selectElement.setAttribute("width",this.bgElement.rectAttributes.width),this.selectElement.setAttribute("height",this.bgElement.rectAttributes.height),this.selectElement.setAttribute("opacity",.3);for(var e in this.selectAttributes)this.selectElement.setAttribute(e,this.selectAttributes[e]);this.coverElement.setAttribute("width",this.bgElement.rectAttributes.width),this.coverElement.setAttribute("height",this.bgElement.rectAttributes.height),this.coverElement.setAttribute("opacity",0)},KevLinDev.extend(Background,ActionObject),Background.prototype.setFocus=function(e){this.focus=e},Background.prototype.addActionListener=function(e){this.actionListeners.length==0&&(document.documentElement.addEventListener("keypress",this,!1),document.documentElement.addEventListener("click",this,!1)),Background.superClass.addActionListener.call(this,e)},Background.prototype.removeActionListener=function(e){Background.superClass.removeActionListener.call(this,e),this.actionListeners.length==0&&(document.documentElement.removeEventListener("keypress",this,!1),document.documentElement.removeEventListener("click",this,!1))},Background.prototype.clearActionListeners=function(){Background.superClass.clearActionListeners.call(this),document.documentElement.removeEventListener("keypress",this,!1),document.documentElement.removeEventListener("click",this,!1)},Background.prototype.doAction=function(e,t){t.focus=this.focus,this.tellActionListeners(e,t)},KevLinDev.extend(TextArea,SimpleButton),TextArea.prototype.doAction=function(e,t){TextArea.superClass.doAction.call(this,e,t);if(t.type=="keypress"){var n=t.keyCode;t.charCode&&(n=t.charCode),n>31&&n!=127&&n<65535?this.isSecret?(this.textVal+="*",this.secretVal+=String.fromCharCode(n)):this.textVal+=String.fromCharCode(n):n==8?this.isSecret?(this.textVal=this.textVal.substring(0,this.textVal.length-1),this.secretVal=this.secretVal.substring(0,this.secretVal.length-1)):this.textVal=this.textVal.substring(0,this.textVal.length-1):(n==10||n==13)&&this.nextFocus(),this.textNode.tnode.nodeValue=this.textVal,this.updateWidth()}else if(t.type=="click")if(e.src=="Background")this.loseFocus();else if(e.src=this.src)this.setFocus(),t.stopPropagation()},TextArea.prototype.setSecret=function(){this.isSecret=!0},TextArea.prototype.setValue=function(e){if(this.isSecret){this.secretVal=e.toString(),this.textVal="";for(var t=0;t<this.secretVal.length;t++)this.textVal+="*"}else this.textVal=e.toString();this.textNode.tnode.nodeValue=this.textVal,this.updateWidth()},TextArea.prototype.updateWidth=function(){var e=this.textNode.getBBox();this.cursor.setAttribute("x",e.width+5),e.width>this.textBoxWidth-10?this.textNodeHolder.setAttribute("transform","translate("+(this.textBoxWidth-e.width-10)+",0)"):this.textNodeHolder.setAttribute("transform","translate(0,0)")},TextArea.prototype.setFocus=function(){this.cursor.show(),TextArea.superClass.setFocus.call(this)},TextArea.prototype.loseFocus=function(){this.cursor.hide(),TextArea.superClass.loseFocus.call(this)},KevLinDev.extend(MultilineText,SVGComponent),KevLinDev.extend(FlowLayout,SVGComponent),FlowLayout.prototype.appendChild=function(e){var t=new SVGComponent(this.currentX,this.currentY);t.appendChild(e),this.placeAppendedChild(t),FlowLayout.superClass.appendChild.call(this,t),this.layoutParams.minWidth<=0&&this.layoutParams.orthogonalAlignment=="top"?this.tellResizeListeners(this):this.refreshLayout(),e.addResizeListener(this)},FlowLayout.prototype.prependChild=function(e){var t=new SVGComponent(0,0);t.appendChild(e),FlowLayout.superClass.prependChild.call(this,t),this.refreshLayout(),e.addResizeListener(this)},FlowLayout.prototype.removeChild=function(e){for(var t in this.childNodes)if(this.childNodes[t].firstChild==e){FlowLayout.superClass.removeChild.call(this,this.childNodes[t]),e.removeResizeListener(this),this.refreshLayout();break}},FlowLayout.prototype.removeChildren=function(){FlowLayout.superClass.removeChildren.call(this),this.refreshLayout()},FlowLayout.prototype.placeAppendedChild=function(e){var t=e.getBBox(),n=0;switch(this.layoutParams.direction){case"left":case"right":n=t.height;break;case"up":case"down":n=t.width}var r=0;switch(this.layoutParams.orthogonalAlignment){case"bottom":r=this.maxOrthogonal-n;break;case"centre":r=(this.maxOrthogonal-n)/2;break;case"top":default:orthgonalPos=0}switch(this.layoutParams.direction){case"left":this.currentX-=t.width+this.layoutParams.spacing;case"right":this.currentY=r;break;case"up":this.currentY-=t.height+this.layoutParams.spacing;case"down":this.currentX=r}e.setPosition(this.currentX,this.currentY);switch(this.layoutParams.direction){case"right":this.currentX+=t.width+this.layoutParams.spacing;break;default:case"down":this.currentY+=t.height+this.layoutParams.spacing}},FlowLayout.prototype.refreshLayout=function(){this.currentX=0,this.currentY=0;if(this.layoutParams.orthogonalAlignment!="top"){this.maxOrthogonal=0;for(var e in this.childNodes){var t=this.childNodes[e].getBBox();switch(this.layoutParams.direction){case"left":case"right":this.maxOrthogonal=Math.max(this.maxOrthogonal,t.height);break;case"up":case"down":this.maxOrthogonal=Math.max(this.maxOrthogonal,t.width)}}}if(this.layoutParams.minWidth>0){var n=0,r=0;for(var e in this.childNodes){var t=this.childNodes[e].getBBox();switch(this.layoutParams.direction){case"left":case"right":n+=t.width;break;case"up":case"down":n+=t.height}r++}var i=0;switch(this.layoutParams.flowAlignment){case"justify":this.layoutParams.spacing=(this.layoutParams.minWidth-n)/(r-1),this.layoutParams.spacing<this.layoutParams.minSpacing&&(this.layoutParams.spacing=this.layoutParams.minSpacing);break;case"right":i=this.layoutParams.minWidth-n-(r-1)*this.layoutParams.minSpacing,i<0&&(i=0);break;case"centre":i=(this.layoutParams.minWidth-n-(r-1)*this.layoutParams.minSpacing)/2,i<0&&(i=0);break;case"left":default:i=0}switch(this.layoutParams.direction){case"left":case"right":this.currentX=i;break;case"up":case"down":this.currentY=i}}for(var e in this.childNodes)this.placeAppendedChild(this.childNodes[e]);this.tellResizeListeners(this)},FlowLayout.prototype.notifyResize=function(e){FlowLayout.superClass.notifyResize.call(this,e),this.refreshLayout()},KevLinDev.extend(TextLabel,FlowLayout),TextLabel.prototype.setValue=function(e){this.textValue=e,this.removeChildren();if(e==null)return;var t=e.split("\n");for(var n in t)this.setParagraph(t[n])},TextLabel.prototype.setParagraph=function(e){if(this.layoutParams.maxWidth==null){var t=new SVGElement("text",this.textAttributes,e);this.appendChild(t);return}var n=e.split(" "),r=0;while(r<n.length){var i=n[r],s=i,t=new SVGElement("text",this.textAttributes,s);while(t.getBBox().width<=this.layoutParams.maxWidth){i=s,r++;if(r>=n.length)break;s=i+" "+n[r],t.setValue(s)}r<n.length&&(t.setValue(i),i==s&&r++),this.appendChild(t)}};var g_dragndrop=new DragNDropHandler;DragNDropHandler.prototype.dragstart=function(e,t,n,r){this.dragObject=e;var i=t.target.ownerDocument.documentElement.currentScale,s=t.target.ownerDocument.documentElement.currentTranslate;this.offsetX=(t.clientX-s.x)/i-n,this.offsetY=(t.clientY-s.y)/i-r},DragNDropHandler.prototype.dragmove=function(e){if(this.dragObject!=null){var t=e.target.ownerDocument.documentElement.currentScale,n=e.target.ownerDocument.documentElement.currentTranslate,r=(e.clientX-n.x)/t,i=(e.clientY-n.y)/t;this.dragObject.setDragPosition(r-this.offsetX,i-this.offsetY)}},DragNDropHandler.prototype.dragend=function(e){this.dragObject!=null&&this.dragObject.setDragEnd(),this.dragObject=null},KevLinDev.extend(Slider,SVGComponent),Slider.prototype.setDragPosition=function(e,t){var n=(this.params.orientation=="h"?e:t)/(this.params.sliderLength-this.params.draggerWidth);this.setSliderPosition(n)},Slider.prototype.setDragEnd=function(){},Slider.prototype.setSliderPosition=function(e){this.sliderPosition=e<0?0:e>1?1:e;var t=this.sliderPosition*(this.params.sliderLength-this.params.draggerWidth);this.params.orientation=="h"?this.scrollTop.setPosition(t,0):this.scrollTop.setPosition(0,t),this.tellActionListeners(this,{type:"dragSlider",position:this.sliderPosition})},Slider.prototype.doAction=function(e,t){if(e.src=="scrollDragger"&&t.type=="mousedown")dragndrop_Start(this,t,this.scrollTop.x,this.scrollTop.y);else if(e.src=="scrollBG"&&t.type=="click"){var n=0;this.params.orientation=="h"?n=t.clientX-this.svg.getCTM().e-.5*this.params.draggerWidth:n=t.clientY-this.svg.getCTM().f-.5*this.params.draggerWidth,this.setSliderPosition(n/(this.params.sliderLength-this.params.draggerWidth))}},KevLinDev.extend(Scrollbar,FlowLayout),Scrollbar.prototype.updateScrollbar=function(e,t,n){this.scrollbarLength=t-2*this.params.width,this.dragbarLength=t/e*this.scrollbarLength,this.dragbarLength>this.scrollbarLength&&(this.dragbarLength=this.scrollbarLength),this.params.orientation=="h"?(this.scrollBg.setAttribute("width",this.scrollbarLength),this.scrollTop.bgElement.rectAttributes.width=this.dragbarLength):(this.scrollBg.setAttribute("height",this.scrollbarLength),this.scrollTop.bgElement.rectAttributes.height=this.dragbarLength);var r=0;e-t>0&&(r=n*(this.scrollbarLength-this.dragbarLength)/(e-t));var i=this.setScrollbarPosition(r);return this.scrollTop.refreshLayout(),this.refreshLayout(),i},Scrollbar.prototype.setDragPosition=function(e,t){this.setScrollbarPosition(this.params.orientation=="h"?e:t),this.tellActionListeners(this,{type:"dragScrollbar",position:this.position/(this.scrollbarLength-this.dragbarLength)})},Scrollbar.prototype.setDragEnd=function(){},Scrollbar.prototype.setScrollbarPosition=function(e){return this.position=e<0?0:e>this.scrollbarLength-this.dragbarLength?this.scrollbarLength-this.dragbarLength:e,this.params.orientation=="h"?this.scrollTop.setPosition(this.position,0):this.scrollTop.setPosition(0,this.position),this.position},Scrollbar.prototype.doAction=function(e,t){e.src=="scrollDragger"&&t.type=="mousedown"?dragndrop_Start(this,t,this.scrollTop.x,this.scrollTop.y):t.type=="click"&&(e.src=="backButton"?(this.setScrollbarPosition(this.position-this.dragbarLength/2),this.tellActionListeners(this,{type:"dragScrollbar",position:this.position/(this.scrollbarLength-this.dragbarLength)})):e.src=="fwdButton"&&(this.setScrollbarPosition(this.position+this.dragbarLength/2),this.tellActionListeners(this,{type:"dragScrollbar",position:this.position/(this.scrollbarLength-this.dragbarLength)})),t.stopPropagation())},KevLinDev.extend(ScrollbarRegion,SVGComponent),ScrollbarRegion.prototype.refreshLayout=function(){this.rectBorder!=null&&(this.rectBorder.setAttribute("width",this.params.width),this.rectBorder.setAttribute("height",this.params.height));var e=this.contents.getVisualBBox();this.xExtent=e.width,this.yExtent=e.height;var t=this.xExtent>this.params.width,n=this.params.scrollbarWidth+this.params.scrollbarGap,r=this.yExtent>(t?this.params.height-n:this.params.height);t=this.xExtent>(r?this.params.width-n:this.params.width),this.effectiveWidth=r?this.params.width-n:this.params.width,this.effectiveHeight=t?this.params.height-n:this.params.height,this.updateContentPosition(),this.hBar.updateScrollbar(this.xExtent,this.effectiveWidth,this.scroll_x),this.hBar.setPosition(0,this.effectiveHeight+this.params.scrollbarGap),this.vBar.updateScrollbar(this.yExtent,this.effectiveHeight,this.scroll_y),this.vBar.setPosition(this.effectiveWidth+this.params.scrollbarGap,0),t?(this.mask.setAttribute("height",this.params.height-n),this.hBar.show()):(this.mask.setAttribute("height",this.params.height),this.hBar.hide()),r?(this.mask.setAttribute("width",this.params.width-n),this.vBar.show()):(this.mask.setAttribute("width",this.params.width),this.vBar.hide())},ScrollbarRegion.prototype.updateScrollbarPosition=function(e,t){this.scroll_x=-this.contents.x,this.scroll_y=-this.contents.y,e=="h"?this.scroll_x=(this.xExtent-this.effectiveWidth)*t:this.scroll_y=(this.yExtent-this.effectiveHeight)*t,this.updateContentPosition()},ScrollbarRegion.prototype.updateContentPosition=function(){this.scroll_x+this.effectiveWidth>this.xExtent&&(this.scroll_x=this.xExtent-this.effectiveWidth),this.scroll_x<0&&(this.scroll_x=0),this.scroll_y+this.effectiveHeight>this.yExtent&&(this.scroll_y=this.yExtent-this.effectiveHeight),this.scroll_y<0&&(this.scroll_y=0),this.contents.setPosition(-this.scroll_x,-this.scroll_y)},ScrollbarRegion.prototype.doAction=function(e,t){t.type=="dragScrollbar"&&this.updateScrollbarPosition(e.params.orientation,t.position)},ScrollbarRegion.prototype.notifyResize=function(e){ScrollbarRegion.superClass.notifyResize.call(this,e),this.refreshLayout()},KevLinDev.extend(SVGWindow,SVGComponent),SVGWindow.prototype.setDragPosition=function(e,t){this.setPosition(e,t)},SVGWindow.prototype.setDragEnd=function(){},SVGWindow.prototype.doAction=function(e,t){SVGWindow.superClass.doAction.call(this,e,t),e.src=="closeWindow"&&t.type=="click"?this.tellActionListeners(this,{type:"closeWindow"}):e.src=="dragWindow"&&t.type=="mousedown"?(this.tellActionListeners(this,{type:"windowSelected"}),dragndrop_Start(this,t,this.x,this.y)):e.src=="resizeWindow"?t.type=="mousedown"&&(this.resizeHandler.startX=this.x,this.resizeHandler.startY=this.y,this.resizeHandler.startWidth=this.windowParams.width,this.resizeHandler.startHeight=this.windowParams.height,dragndrop_Start(this.resizeHandler,t,this.x,this.y)):e==this.bgRect&&t.type=="mousedown"&&this.tellActionListeners(this,{type:"windowSelected"})},SVGWindow.prototype.setPosition=function(e,t){SVGWindow.superClass.setPosition.call(this,e,t),this.windowParams.storePrefix&&window.localStorage&&(localStorage.setItem(this.windowParams.storePrefix+"_x",this.x),localStorage.setItem(this.windowParams.storePrefix+"_y",this.y))},SVGWindow.prototype.setAble=function(e){e?this.fgRect.hide():this.fgRect.show()},SVGWindow.prototype.refreshLayout=function(){this.windowTitle.bgElement.rectAttributes.width=this.windowParams.width-this.windowParams.titleBarHeight,this.windowTitle.refreshLayout(),this.titleBar.refreshLayout(),this.scrollbarRegion.params.width=this.windowParams.width,this.scrollbarRegion.params.height=this.windowParams.height-this.windowParams.titleBarHeight-3-this.windowParams.statusBarHeight,this.scrollbarRegion.refreshLayout(),this.bgRect.setAttribute("x",-this.borderWidth),this.bgRect.setAttribute("y",-this.borderWidth),this.bgRect.setAttribute("width",this.windowParams.width+this.borderWidth*2),this.bgRect.setAttribute("height",this.windowParams.height+this.borderWidth*2),this.fgRect.setAttribute("x",-this.borderWidth),this.fgRect.setAttribute("y",-this.borderWidth),this.fgRect.setAttribute("width",this.windowParams.width+this.borderWidth*2),this.fgRect.setAttribute("height",this.windowParams.height+this.borderWidth*2),this.isDragging&&this.windowStatusText.setValue(this.windowParams.width+"x"+this.windowParams.height),this.windowStatus.rectAttributes.width=this.windowParams.width-10,this.windowStatus.refreshLayout(),this.statusBar.setPosition(0,this.windowParams.height-this.windowParams.statusBarHeight),this.statusBar.refreshLayout(),this.windowContents.refreshLayout()},KevLinDev.extend(SVGWindowManager,SVGComponent),SVGWindowManager.prototype.addWindow=function(e){this.appendChild(e),e.addActionListener(this)},SVGWindowManager.prototype.setPositionConstraints=function(e,t,n,r){this.childConstraints={x:e,y:t,width:n,height:r}},SVGWindowManager.prototype.doAction=function(e,t){SVGWindowManager.superClass.doAction.call(this,e,t),t.type=="windowSelected"&&this.appendChild(e)},KevLinDev.extend(ItemContainer,ActionObject),ItemContainer.prototype.moveItem=function(e){if(this.owner)for(var t=0;t<this.owner.myItems.length;++t)if(this.owner.myItems[t]==this){this.owner.myItems.splice(t,1),this.owner.tellActionListeners(this.owner,{type:"removeItem",itemIndex:t});break}e.appendItem(this)},ItemContainer.prototype.removeAllItems=function(){while(this.myItems.length>0)this.removeItemByIndex(0)},ItemContainer.prototype.removeItem=function(e){for(var t=0;t<this.myItems.length;++t)if(this.myItems[t]==e){this.removeItemByIndex(t);break}},ItemContainer.prototype.getFlattenedTree=function(){var e=[this];for(var t=0;t<this.myItems.length;++t)e=e.concat(this.myItems[t].getFlattenedTree());return e},ItemContainer.prototype.find=function(e,t){if(this.params!=null&&this.params[e]===t)return this;for(var n=0;n<this.myItems.length;++n){var r=this.myItems[n].find(e,t);if(r!=null)return r}},ItemContainer.prototype.removeItemByIndex=function(e){if(e<0||e>=this.myItems.length)return;this.myItems[e].cleanup(),this.myItems.splice(e,1),this.tellActionListeners(this,{type:"removeItem",itemIndex:e})},ItemContainer.prototype.cleanup=function(){this.owner=null;for(var e=0;e<this.myItems.length;++e)this.myItems[e].cleanup()},ItemContainer.prototype.setOwner=function(e){this.owner=e},ItemContainer.prototype.appendItem=function(e){this.myItems.push(e),e.setOwner(this),this.tellActionListeners(this,{type:"appendedItem",item:e})},ItemContainer.prototype.notifyAppendItemChildren=function(){if(this.myItems==null)return;for(var e=0;e<this.myItems.length;++e)this.tellActionListeners(this,{type:"appendedItem",item:this.myItems[e]}),this.myItems[e].notifyAppendItemChildren()},KevLinDev.extend(ViewItemContainer,SVGComponent),ViewItemContainer.prototype.doAction=function(e,t){ViewItemContainer.superClass.doAction.call(this,e,t);if(t.type=="appendedItem")this.appendViewItemAndChildren(t.item);else if(t.type=="removeItem"){var n=this.containedItems.childNodes[t.itemIndex];n.removeActionListeners(),this.containedItems.removeChildByIndex(t.itemIndex),this.auxGroup.removeChildByIndex(t.itemIndex)}},ViewItemContainer.prototype.updateChildrenFromModel=function(){for(var e=0;e<this.modelItem.myItems.length;++e)this.appendViewItemAndChildren(this.modelItem.myItems[e])},ViewItemContainer.prototype.appendViewItemAndChildren=function(e){var t=this.viewItemFactory.makeViewItem(e);t!=null&&(t.rootContainer=this.rootContainer,t.parentContainer=this,e.addActionListener(t),t.rootContainer.addActionListener(t),this.containedItems.appendChild(t),this.auxGroup.appendChild(t.auxGroup),t.onBeingAdded());if(e.myItems!=null)for(var n=0;n<e.myItems.length;++n)t.appendViewItemAndChildren(e.myItems[n]);return t},ViewItemContainer.prototype.onBeingAdded=function(){},ViewItemContainer.prototype.removeActionListeners=function(){for(var e=0;e<this.containedItems.childNodes.length;++e)this.containedItems.childNodes[e].removeActionListeners();this.modelItem.removeActionListener(this)},KevLinDev.extend(GridModel,ActionObject),GridModel.prototype.clear=function(){for(var e in this.gridData)for(var t in this.gridData[e])this.gridData[e][t].clear();this.moveableItems=[],this.itemIdIndex=0,this.itemIdList=[]},GridModel.prototype.registerItem=function(e){e.id==null&&(e.id="i_"+this.itemIdIndex++),this.itemIdList[e.id]=e},GridModel.prototype.importItem=function(e){if(e.id==null)return;var t=parseInt(e.id.slice(2));t>=this.itemIdIndex&&(this.itemIdIndex=t+1),this.itemIdList[e.id]=e},GridModel.prototype.getItemById=function(e){return this.itemIdList[e]},GridModel.prototype.addToMoveableItems=function(e){for(var t=0;t<this.moveableItems.length;++t)if(this.moveableItems[t]==e)return;this.moveableItems.push(e)},GridModel.prototype.removeFromMoveableItems=function(e){for(var t=0;t<this.moveableItems.length;++t)if(this.moveableItems[t]==e){this.moveableItems.splice(t,1);break}},GridModel.prototype.getContents=function(e,t){return this.gridData[e]==null&&(this.gridData[e]=[]),this.gridData[e][t]==null&&(this.gridData[e][t]=this.itemFactory.makeContents(this,e,t,0)),this.gridData[e][t]},GridModel.prototype.getWithinRadius=function(e,t,n){var r=[];for(var i=e-n;i<=e+n;i++)for(var s=t-n;s<=t+n;s++){var o=this.getDistance(e,t,i,s);o!=null&&o<n&&r.push(this.getContents(i,s))}return r},GridModel.prototype.getDistance=function(e,t,n,r){var i=Math.abs(n-e),s=Math.abs(r-t);return i>s?i+Math.floor(s/2):s+Math.floor(i/2)},GridModel.prototype.clearXML=function(){while(this.xmlModel.firstChild!=null)this.xmlModel.removeChild(this.xmlModel.firstChild)},GridModel.prototype.toXML=function(){this.clearXML();for(var e in this.gridData)for(var t in this.gridData[e]){var n=this.gridData[e][t].toXML(this.xmlDoc);n!=null&&this.xmlModel.appendChild(n)}return this.xmlModel},GridModel.prototype.fromXML=function(e){if(e==null)return;var t=e.getElementsByTagName("c");for(var n=0;n<t.length;n++){var r=t.item(n),i=parseInt(r.getAttribute("x")),s=parseInt(r.getAttribute("y")),o=this.getContents(i,s);o.fromXML(r)}},GridModel.prototype.fromString=function(e){var t=e.split("]");for(var n in t)if(t[n][0]=="["){var r=t[n].split(","),i=parseInt(r[0].substr(1)),s=parseInt(r[1]),o=this.getContents(i,s);o.fromString(r[2])}},GridModel.prototype.findItemsByCode=function(e){var t=[];for(var n in this.gridData)for(var r in this.gridData[n]){var i=this.gridData[n][r].findItemByCode(e);i!=null&&t.push(i)}return t.length==0?null:t},KevLinDev.extend(GridContents,ItemContainer),GridContents.prototype.clear=function(){this.tempParams={},this.removeAllItems()},GridContents.prototype.toString=function(){var e="",t=!0;for(var n=0;n<this.myItems.length;++n)this.myItems[n]!=null&&(t?t=!1:e+=";",e+=this.myItems[n].toString());return e.length==0?null:e},GridContents.prototype.getLocationString=function(){return this.x+","+this.y},GridContents.prototype.fromString=function(e){this.myItems=[];if(e!=null){var t=e.split(";");for(var n in t){var r=this.model.itemFactory.makeItem(t[n]);this.appendItem(r)}}},GridContents.prototype.toXML=function(e,t){if(this.myItems.length==0)return null;var n=e.createElement("c");n.setAttribute("x",this.x),n.setAttribute("y",this.y);for(var r=0;r<this.myItems.length;++r){var i=this.myItems[r].toXML(e,t);i!=null&&n.appendChild(i)}if(t)for(var r=0;r<this.seenBy.length;++r){var s=e.createElement("seen");s.setAttribute("item",this.seenBy[r].item),s.setAttribute("elev",this.seenBy[r].viewElev),s.setAttribute("dist",this.seenBy[r].distance),s.setAttribute("x",this.seenBy[r].x),s.setAttribute("y",this.seenBy[r].y),s.setAttribute("type",this.seenBy[r].viewType),n.appendChild(s)}return n},GridContents.prototype.fromXML=function(e){for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes.item(t),r=this.model.itemFactory.makeItemFromXML(n,this.model);this.appendItem(r)}},GridContents.prototype.addSeenBy=function(e,t,n,r,i,s){this.seenBy.push({item:e,viewElev:t,distance:n,x:r,y:i,viewType:s})},GridContents.prototype.removeSeenBy=function(e){for(var t=0;t<this.seenBy.length;++t)if(this.seenBy[t].item==e){this.seenBy.splice(t,1);return}},GridContents.prototype.getBlockingHeight=function(){var e=0;for(var t=0;t<this.myItems.length;++t){var n=this.myItems[t].getBlockingHeight();n>e&&(e=n)}return e},GridContents.prototype.getTopItem=function(){var e=this;while(e.myItems.length>0)e=e.myItems[0];return e},GridContents.prototype.findItemByCode=function(e){return this.find("itemCode",e)},KevLinDev.extend(GridItem,ItemContainer),GridItem.prototype.setOwner=function(e){GridItem.superClass.setOwner.call(this,e),this.updateElev(),this.updateOwnerContents()},GridItem.prototype.updateAffectedPOV=function(){if(this.cellContents!=null){var e=[];for(var t=0;t<this.cellContents.seenBy.length;++t)e.push(this.cellContents.seenBy[t].item);for(var n=0;n<e.length;++n)e[n].updatePOV()}},GridItem.prototype.updatePOV=function(){this.params.povRange>0&&this.updateVisibleWithinRadius(this.params.povRange,"pov")},GridItem.prototype.toString=function(){var e=this.params.itemCode+this.params.ht;this.myItems.length>0&&(e+="(");for(var t=0;t<this.myItems.length;++t)t!=0&&(e+=" "),e+=this.myItems[t].toString();return this.myItems.length>0&&(e+=")"),e},GridItem.prototype.toXML=function(e,t){if(this.params.isTemporary)return null;var n=null;e==null?(e=createXMLDoc("i"),n=e.firstChild):n=e.createElement("i"),n.setAttribute("c",this.params.itemCode),this.params.saveVals.ht!=null?n.setAttribute("h",this.params.saveVals.ht):n.setAttribute("h",this.params.ht),this.params.saveVals.direction!=null&&n.setAttribute("d",this.params.saveVals.direction),this.id!=null&&n.setAttribute("id",this.id),t&&n.setAttribute("e",this.params.elev);for(var r=0;r<this.myItems.length;++r){var i=this.myItems[r].toXML(e);i!=null&&n.appendChild(i)}return n},GridItem.prototype.cleanup=function(){GridItem.superClass.cleanup.call(this),this.updateCellContents(
null),this.tellActionListeners(this,{type:"ItemBeingDeleted",item:this})},GridItem.prototype.updateOwnerContents=function(){this.owner!=null&&(this.owner.src=="GridContents"?this.updateCellContents(this.owner):this.updateCellContents(this.owner.cellContents));for(var e=0;e<this.myItems.length;++e)this.myItems[e].updateOwnerContents()},GridItem.prototype.updateCellContents=function(e){this.cellContents!=e&&(this.cellContents=e,this.cellContents!=null?(this.updatePOV(),this.updateAffectedPOV()):this.clearSeenBy())},GridItem.prototype.updateVisibleWithinRadius=function(e,t){this.clearSeenBy(t);if(this.cellContents==null)return;var n=this.cellContents.model,r=this.cellContents.x,i=this.cellContents.y,s=n.quadList,o=this.params.elev+this.params.ht;this.setVisibility(this.cellContents,this.params.elev,0,r,i,t);for(var u=1;u<=e;u++){var a=n.getContents(r+u,i),f=this.getViewElevation(n,r+u-1,i,o,u,t);this.setVisibility(a,f,u,r,i,t),a=n.getContents(r-u,i),f=this.getViewElevation(n,r-u+1,i,o,u,t),this.setVisibility(a,f,u,r,i,t),a=n.getContents(r,i+u),f=this.getViewElevation(n,r,i+u-1,o,u,t),this.setVisibility(a,f,u,r,i,t),a=n.getContents(r,i-u),f=this.getViewElevation(n,r,i-u+1,o,u,t),this.setVisibility(a,f,u,r,i,t)}for(var l=1;l<e;l++)for(var u=0;u<=e-l;u++)if(u==0){var c=l*1.4142;for(var h=0;h<s.length;++h){var p=r+s[h].x*l,d=i+s[h].y*l,a=n.getContents(p,d),f=this.getViewElevation(n,p-s[h].x,d-s[h].y,o,c,t);this.setVisibility(a,f,c,r,i,t)}}else if(u<l){var c=Math.sqrt(l*l+(l+u)*(l+u));for(var h=0;h<s.length;++h){var p=r+s[h].x*(l+u),d=i+s[h].y*l,a=n.getContents(p,d),f=this.getViewElevation(n,p-s[h].x,d-s[h].y,o,c,t);this.setVisibility(a,f,c,r,i,t);var p=r+s[h].x*l,d=i+s[h].y*(l+u);a=n.getContents(p,d),f=this.getViewElevation(n,p-s[h].x,d-s[h].y,o,c,t),this.setVisibility(a,f,c,r,i,t)}}else if(u==l){var c=Math.sqrt(l*l+(l+u)*(l+u));for(var h=0;h<s.length;++h){var p=r+s[h].x*(l+u),d=i+s[h].y*l,a=n.getContents(p,d),v=this.getViewElevation(n,p-s[h].x,d,o,c,t),m=this.getViewElevation(n,p-s[h].x,d-s[h].y,o,c,t),g=this.getViewElevation(n,p,d-s[h].y,o,c,t),f=m<g?m:g;f=v>f?v:f,this.setVisibility(a,f,c,r,i,t),p=r+s[h].x*l,d=i+s[h].y*(l+u),a=n.getContents(p,d),v=this.getViewElevation(n,p,d-s[h].y,o,c,t),m=this.getViewElevation(n,p-s[h].x,d-s[h].y,o,c,t),g=this.getViewElevation(n,p-s[h].x,d,o,c,t),f=m<g?m:g,f=v>f?v:f,this.setVisibility(a,f,c,r,i,t)}}else{var c=Math.sqrt(l*l+(l+u)*(l+u));for(var h=0;h<s.length;++h){var p=r+s[h].x*(l+u),d=i+s[h].y*l,a=n.getContents(p,d),f=this.getViewElevation(n,p-s[h].x,d,o,c,t);this.setVisibility(a,f,c,r,i,t);var p=r+s[h].x*l,d=i+s[h].y*(l+u);a=n.getContents(p,d),f=this.getViewElevation(n,p,d-s[h].y,o,c,t),this.setVisibility(a,f,c,r,i,t)}}},GridItem.prototype.getViewElevation=function(e,t,n,r,i,s){var o=this.canSee[s][t][n].viewElev,u=e.getContents(t,n).getBlockingHeight(),a=o>u?o:u;return a-(r-a)/i*2},GridItem.prototype.setVisibility=function(e,t,n,r,i,s){e.addSeenBy(this,t,n,r,i,s),this.canSee[s]==null&&(this.canSee[s]={}),this.canSee[s][e.x]==null&&(this.canSee[s][e.x]={}),this.canSee[s][e.x][e.y]={cellContents:e,viewElev:t,distance:n}},GridItem.prototype.clearSeenBy=function(e){if(e==null){for(var t in this.canSee)for(var n in this.canSee[t])for(var r in this.canSee[t][n])this.canSee[t][n][r].cellContents.removeSeenBy(this);this.canSee={}}else{for(var n in this.canSee[e])for(var r in this.canSee[e][n])this.canSee[e][n][r].cellContents.removeSeenBy(this);this.canSee[e]={}}},GridItem.prototype.getBlockingHeight=function(){var e=0;this.params.blockView&&(e=this.params.elev+this.params.ht);for(var t=0;t<this.myItems.length;++t){var n=this.myItems[t].getBlockingHeight();n>e&&(e=n)}return e},GridItem.prototype.setItemParam=function(e,t,n){n&&(this.params.saveVals[e]=t);if(this.params[e]==t)return;this.params[e]=t,this.tellActionListeners(this,{type:"paramChanged",name:e,value:t})},GridItem.prototype.setItemTag=function(e){for(var t=0;t<this.params.itemTags.length;++t)if(this.params.itemTags[t]==e)return;this.params.itemTags.push(e),this.tellActionListeners(this,{type:"tagAdded",value:e}),this.setItemTagParam(e)},GridItem.prototype.setItemTagParam=function(e){if(this.params.tagParams[e]!=null)for(var t in this.params.tagParams[e])this.params.tagParamOriginals==null&&(this.params.tagParamOriginals={},this.params.tagParamOriginals[e]={}),this.params.tagParamOriginals[e][t]=this.params[t]==null?null:this.params[t],this.setItemParam(t,this.params.tagParams[e][t])},GridItem.prototype.updateElev=function(){this.owner==null?this.setItemParam("elev",0):this.owner.params!=null&&this.owner.params.elev!=null&&(this.owner.params.ht!=null&&!this.params.isCarried?this.setItemParam("elev",this.owner.params.elev+this.owner.params.ht):this.setItemParam("elev",this.owner.params.elev));for(var e=0;e<this.myItems.length;++e)this.myItems[e].updateElev()},GridItem.prototype.setDirection=function(e,t){var n=this.getDirectionDelta(this.params.direction,e);this.setItemParam("direction",e,t);for(var r=0;r<this.myItems.length;++r)this.myItems[r].rotateItem(n,!1)},GridItem.prototype.getDirectionDelta=function(e,t){var n=0;for(var r=0;r<this.dirns.length;++r)if(this.dirns[r]==e){n=r;break}for(var r=0;r<this.dirns.length;r++)if(this.dirns[r]==t)return(r-n+this.dirns.length)%this.dirns.length;return 0},GridItem.prototype.rotateItem=function(e,t){this.params.direction==null&&(this.params.direction="f");for(var n=0;n<this.dirns.length;++n)if(this.dirns[n]==this.params.direction){n+=e,n%=this.dirns.length;while(n<0)n+=this.dirns.length;this.setDirection(this.dirns[n],t);break}},GridItem.prototype.setHeight=function(e,t){this.setItemParam("ht",e,t),this.params.wtPerHt!=null&&(this.params.wt=this.params.wtPerHt*e);var n=this.getFlattenedTree();for(var r=0;r<n.length;++r)n[r].updateElev(),n[r].updatePOV();this.updateAffectedPOV()},GridItem.prototype.useItemWith=function(e){var t=!1;if(this.params.useActions!=null)for(var n=0;n<this.params.useActions.length;++n){var r=this.params.useActions[n];for(var i=0;i<e.params.itemTags.length;++i)r.otherTag==e.params.itemTags[i]&&(this.setItemTag(r.addTag),t=!0)}return t},GridItem.prototype.canMoveTo=function(e,t,n){if(e.src=="GridContents")return!1;if(!e.params.canStandOn)return!1;var r=e.params.ht+e.params.elev-this.params.elev;return r>=0&&r<=t?!0:r<0&&(n==null||-r<=n)?!0:!1},GridItem.prototype.searchFor=function(e){var t=[];for(var n in this.canSee.pov)for(var r in this.canSee.pov[n]){var i=this.canSee.pov[n][r],s=i.cellContents.find("itemCode",e);s!=null&&s.params.elev+s.params.ht>=i.viewElev&&t.push({item:s,distance:i.distance})}return t},GridItem.prototype.requestChange=function(){var e=null;if(this.params.moveTowards==null)return null;for(var t in this.params.scaredOf){var n=this.searchFor(this.params.scaredOf[t]);!(n.length>0)}for(var t in this.params.moveTowards){var n=this.searchFor(this.params.moveTowards[t]);if(n.length>0){var r=n[0].distance,i=[n[0]];for(var s=1;s<n.length;s++)n[s].distance<r?(r=n[s].distance,i.push(n[s])):n[s].distance==r&&(i=[n[s]]);if(i.length==1)e=this.followSimplePathTo(i[0].item);else{var o=0,u=0;for(var s=0;s<i.length;++s)e=this.followSimplePathTo(i[s].item),o+=e.x-this.cellContents.x,u+=e.y-this.cellContents.y;Math.abs(o)>Math.abs(u)?e=this.cellContents.model.getContents(this.cellContents.x+(o>0?1:-1),this.cellContents.y):Math.abs(o)<Math.abs(u)?e=this.cellContents.model.getContents(this.cellContents.x,this.cellContents.y+(u>0?1:-1)):o!=0?e=this.cellContents.model.getContents(this.cellContents.x+(o>0?1:-1),this.cellContents.y):e=null}break}}if(e!=null){var a=e.x!=this.cellContents.x?e.x<this.cellContents.x?"r":"l":e.y<this.cellContents.y?"b":"f";return{cellContents:e,params:{direction:a}}}return null},GridItem.prototype.getSimplePathPreferred=function(e,t){var n=this.cellContents.x-e.cellContents.x,r=this.cellContents.y-e.cellContents.y,i=this.cellContents.x,s=this.cellContents.y;return t==Math.abs(n)>=Math.abs(r)?i+=n==0?0:n>0?-1:1:s+=r==0?0:r>0?-1:1,this.cellContents.model.getContents(i,s)},GridItem.prototype.followSimplePathTo=function(e){var t=this.getSimplePathPreferred(e,!0);if(t==null)return null;if(t==e.cellContents)return this.canMoveTo(e.owner,this.params.climbHeight)?t:null;if(this.canMoveTo(t.getTopItem(),this.params.climbHeight))return t;var t=this.getSimplePathPreferred(e,!1);return t==this.cellContents?null:this.canMoveTo(t.getTopItem(),this.params.climbHeight)?t:null},KevLinDev.extend(GridViewItem,ViewItemContainer),GridViewItem.prototype.appendItemContents=function(e){this.itemGraphics.appendChild(e)},GridViewItem.prototype.doAction=function(e,t){GridViewItem.superClass.doAction.call(this,e,t),t.type=="paramChanged"&&(t.name=="speech"?this.doSpeech(t.value):t.name=="isInvisible"&&this.setVisibilityTop(!t.value))},GridViewItem.prototype.doSpeech=function(e){this.speechBubble!=null&&(this.auxGroup.removeChild(this.speechBubble),this.speechBubble=null);if(e!=null){this.speechBubble=this.viewItemFactory.createSpeechBubble(e);var t=-this.modelItem.params.elev;this.auxGroup.setAttribute("transform","translate(0, "+t+")"),this.auxGroup.appendChild(this.speechBubble)}},GridViewItem.prototype.updatePOV=function(e){var t=this.modelItem.cellContents;if(t==null)return;if(e==null)this.setVisibilityTop(!0);else if(this.itemGraphics!=null){var n=!1;for(var r=0;r<t.seenBy.length;++r)if(t.seenBy[r].viewType=="pov")for(var i=0;i<e.length;++i)if(e[i]==t.seenBy[r].item){t.seenBy[r].viewElev<=this.modelItem.params.elev+this.modelItem.params.ht&&(n=!0);break}this.setVisibilityTop(n)}for(var s=0;s<this.containedItems.childNodes.length;++s)this.containedItems.childNodes[s].updatePOV(e)},GridViewItem.prototype.setVisibilityTop=function(e){this.modelItem.params.isInvisible&&(!this.modelItem.cellContents||!this.modelItem.cellContents.model.showInvisible)&&(e=!1),this.itemGraphics.firstChild.setVisible(e)},KevLinDev.extend(GridViewContents,ParamButton),GridViewContents.prototype.setMouseoverPosition=function(e,t){this.svg_mouseover.setPosition(e,t)},GridViewContents.prototype.setAble=function(e){GridViewContents.superClass.setAble.call(this,e),e?this.svg_bg.show():this.svg_bg.hide()},GridViewContents.prototype.remove=function(){this.modelContents.removeActionListener(this),this.viewItems.removeActionListeners(),this.detach()},GridViewContents.prototype.updatePOV=function(e){for(var t in this.viewItems.containedItems.childNodes)this.viewItems.containedItems.childNodes[t].updatePOV(e)},GridViewContents.prototype.clear=function(){this.setMouseoverPosition(0,0)},KevLinDev.extend(GridView,SVGRoot),GridView.prototype.setViewSize=function(e,t){this.viewWidth=e,this.viewHeight=t},GridView.prototype.setViewCentre=function(e,t){this.viewCentreX=e,this.viewCentreY=t},GridView.prototype.setCellCentre=function(e,t){this.cellCentreX=e,this.cellCentreY=t},GridView.prototype.setFixedCellCount=function(e){this.fixedCellCountX=e},GridView.prototype.updateView=function(){},GridView.prototype.getLayoutX=function(e,t){return e},GridView.prototype.getLayoutY=function(e,t){return t},GridView.prototype.inView=function(e,t){},GridView.prototype.setBounds=function(e){var t=this.cellWidth*e.height/this.cellHeight;if(e.width>t)e.x+=(e.width-t)/2,e.width=t;else{var n=this.cellHeight*e.width/this.cellWidth;e.y+=(e.height-n)/2,e.height=n}this.setClipRect(e),this.setViewSize(e.width,e.height),this.setViewCentre(e.width/2,e.height/2),this.updateView()},GridView.prototype.drawCell=function(e,t){if(!this.inView(e,t))return;var n=this.gridModel.getContents(e,t);this.view[e]==null&&(this.view[e]=[]);if(this.view[e][t]==null){var r=this.getLayoutX(e,t)*this.cellWidth,i=this.getLayoutY(e,t)*this.cellHeight,s=this.itemFactory.makeViewContents(this,r,i,e,t,n,!0);this.view[e][t]=s,s.addActionListener(this);var o=this.getLayoutY(e,t),u=this.z_list[o];if(u==null){u=new SVGElement("g");var a=o;for(var f in this.z_list){var l=parseInt(f);l>o&&(a==o||l<a)&&(a=l)}a==o?this.objectLayer.appendChild(u):this.objectLayer.insertBefore(u,this.z_list[a]),this.z_list[o]=u}u.appendChild(s),this.coverLayer.appendChild(s.auxiliaryComponents[0]),this.coverLayer.appendChild(s.auxiliaryComponents[1])}},GridView.prototype.removeOutsideView=function(){for(var e in this.view)for(var t in this.view[e])this.inView(parseInt(e),parseInt(t))||(this.view[e][t].remove(),delete this.view[e][t])},GridView.prototype.updatePOV=function(e){for(var t in this.view)for(var n in this.view[t])e==null?this.view[t][n].setAble(!0):this.view[t][n].setAble(!1),this.view[t][n].updatePOV(e)},GridView.prototype.clear=function(){for(var e in this.view)for(var t in this.view[e])this.view[e][t].clear()},GridView.prototype.doAction=function(e,t){t.type=="cellContentsUpdate"&&this.drawCell(e.x,e.y),this.tellActionListeners(e,t)},ContentFactory.prototype.makeContents=function(e,t,n,r){return new GridContents(e,t,n,r)},ContentFactory.prototype.makeItem=function(e){return null},ContentFactory.prototype.makeItemFromXML=function(e,t){return null},ContentFactory.prototype.makeViewContents=function(e,t,n,r,i,s){return new GridViewContents(e,t,n,r,i,s)},ContentFactory.prototype.makeSimpleViewItem=function(e){return null},ContentFactory.prototype.makeViewItem=function(e){return null},KevLinDev.extend(LitGridModel,GridModel),LitGridModel.prototype.calcLightLevel=function(e,t){return e>=4?0:e<=0?t:(1-e/4)*t},KevLinDev.extend(LitGridContents,GridContents),LitGridContents.prototype.setAmbientLight=function(e){this.ambientLight=e,this.tellActionListeners(null,{type:"lightChanged"})},LitGridContents.prototype.removeSeenBy=function(e){LitGridContents.superClass.removeSeenBy.call(this,e),this.tellActionListeners(null,{type:"lightChanged"})},LitGridContents.prototype.fromString=function(e){var t=e.split(":");this.ambientLight=parseInt(t[0]),LitGridContents.superClass.fromString.call(this,t[1])},LitGridContents.prototype.toString=function(){var e=LitGridContents.superClass.toString.call(this);return e!=null&&(e=String(this.ambientLight)+":"+e),e},LitGridContents.prototype.toXML=function(e,t){var n=LitGridContents.superClass.toXML.call(this,e,t);return n!=null&&n.setAttribute("l",this.ambientLight),n},LitGridContents.prototype.fromXML=function(e){this.ambientLight=parseFloat(e.getAttribute("l")),LitGridContents.superClass.fromXML.call(this,e)},KevLinDev.extend(LitGridItem,GridItem),LitGridItem.prototype.updatePOV=function(){LitGridItem.superClass.updatePOV.call(this);if(this.params.lightStrength>0){this.updateVisibleWithinRadius(this.params.lightRadius,"light");for(var e in this.canSee.light)for(var t in this.canSee.light[e]){var n=new Object;n.type="lightChanged",this.canSee.light[e][t].cellContents.tellActionListeners(this,n)}}},KevLinDev.extend(LitGridViewItem,GridViewItem),LitGridViewItem.prototype.setLightLevel=function(e){this.itemGraphics.childNodes[0].setLightLevel(e)},LitGridViewItem.prototype.setLighting=function(){var e=this.modelItem.cellContents;if(e==null)return;if(this.itemGraphics!=null){var t=e.ambientLight;for(var n in e.seenBy){if(e.seenBy[n].item.params.lightStrength==null||e.seenBy[n].item.params.lightStrength==0)continue;if(e.seenBy[n].viewType!="light")continue;var r=e.seenBy[n].viewElev;if(e.seenBy[n].viewElev>this.modelItem.params.elev+this.modelItem.params.ht)continue;var i=e.model.calcLightLevel(e.seenBy[n].distance,e.seenBy[n].item.params.lightStrength);i>t&&(t=i)}this.setLightLevel(t)}for(var s in this.containedItems.childNodes)this.containedItems.childNodes[s].setLighting()},LitGridViewItem.prototype.doAction=function(e,t){LitGridViewItem.superClass.doAction.call(this,e,t),t.type=="paramChanged"&&t.name=="ht"&&this.setLighting()},KevLinDev.extend(LitGridViewContents,GridViewContents),LitGridViewContents.prototype.doAction=function(e,t){LitGridViewContents.superClass.doAction.call(this,e,t),t.type=="lightChanged"&&this.setLighting()},LitGridViewContents.prototype.setLighting=function(){for(var e in this.viewItems.containedItems.childNodes)this.viewItems.containedItems.childNodes[e].setLighting()},KevLinDev.extend(LitGridView,GridView),LitGridView.prototype.setLighting=function(){for(var e in this.view)for(var t in this.view[e])this.view[e][t].setLighting()},KevLinDev.extend(LitContentFactory,ContentFactory),LitContentFactory.prototype.makeContents=function(e,t,n,r){return new LitGridContents(e,t,n,r,this.ambientLight)},LitContentFactory.prototype.makeItem=function(e){return null},LitContentFactory.prototype.makeViewContents=function(e,t,n,r,i,s){return new LitGridViewContents(e,t,n,r,i,s)},LitContentFactory.prototype.makeViewItem=function(e){return null};var gLightLevelScaleFactor=1,gShadowElementIdIndex=0;KevLinDev.extend(ShadowElement,SVGElement),ShadowElement.prototype.setBaseElement=function(e){this.base!=null&&this.removeChild(this.base),this.base=e,this.base!=null&&this.appendChild(this.base)},ShadowElement.prototype.setVisible=function(e){this.isVisible=e,this.isVisible?(this.show(),this.setLightLevel2(this.lightLevel)):this.showInvisible&&this.showInvisibleHidden?(this.show(),this.setLightLevel2(0)):this.hide()},ShadowElement.prototype.setLightLevel=function(e){if(e==this.lightLevel)return;this.lightLevel=e,this.isVisible&&this.setLightLevel2(this.lightLevel)},ShadowElement.prototype.setLightLevel2=function(e){this.base!=null&&(e+=(1-e)*(1-gLightLevelScaleFactor),setLightLevel(this.base.svg,{r:e,g:e,b:e},"shadow"+this.shadowID))},KevLinDev.extend(HexGridModel,GridModel),KevLinDev.extend(HexGridView,GridView),HexGridView.prototype.getLayoutX=function(e,t){return e},HexGridView.prototype.getLayoutY=function(e,t){return e%2==0?t:t+.5},KevLinDev.extend(RectGridModel,GridModel),KevLinDev.extend(RectGridView,GridView),KevLinDev.extend(PerspectiveGridModel,LitGridModel),PerspectiveGridModel.prototype.clearInTheWay=function(){for(var e in this.itemsInTheWay)this.itemsInTheWay[e].tellActionListeners(this.itemsInTheWay[e],{type:"InTheWay",opacity:1});this.itemsInTheWay=[]},KevLinDev.extend(PerspectiveGridContents,LitGridContents),PerspectiveGridContents.prototype.setVisibleToUser=function(e){for(var t=1;t<3;t++){var n=this.model.getContents(this.x-t,this.y+t);if(n.tempParams.neverInWay)continue;var r=n;while(r.myItems.length>0){r=r.myItems[0];if(r.params.elev+r.params.ht>30*(t-1)+e){var i=0;this.model.getContents(this.x-t-1,this.y+t+1).tempParams.avatarSees&&(i=.8),r.setInTheWay(i)}}}},KevLinDev.extend(PerspectiveGridItem,LitGridItem),PerspectiveGridItem.prototype.setInTheWay=function(e){this.cellContents!=null&&(this.cellContents.model.itemsInTheWay.push(this),this.tellActionListeners(this,{type:"InTheWay",opacity:e}))},KevLinDev.extend(PerspectiveGridView,LitGridView),PerspectiveGridView.prototype.setFixedCellCount=function(e){PerspectiveGridView.superClass.setFixedCellCount.call(this,e),this.adjustCellBounds()},PerspectiveGridView.prototype.setViewSize=function(e,t){PerspectiveGridView.superClass.setViewSize.call(this,e,t),this.adjustCellBounds()},PerspectiveGridView.prototype.adjustCellBounds=function(){this.fixedCellCountX==null?(this.scaleFactor=1,this.maxX=Math.ceil(this.viewWidth/this.cellWidth),this.maxY=Math.ceil(this.viewHeight/this.cellHeight/2)):(this.maxX=this.fixedCellCountX,this.scaleFactor=this.viewWidth/this.cellWidth/this.fixedCellCountX,this.maxY=Math.ceil(this.viewHeight/this.cellHeight/this.scaleFactor))},PerspectiveGridView.prototype.updateView=function(){if(this.cellCentreX==null)return;for(var e=-this.maxY;e<=this.maxY+this.extraBottomRows;e++){var t=e%2==0?0:1;for(var n=t;n<=this.maxX;n+=2){var r=(n-e)/2,i=(n+e)/2;this.drawCell(r+this.cellCentreX,i+this.cellCentreY),n!=0&&(r=(-n-e)/2,i=(-n+e)/2,this.drawCell(r+this.cellCentreX,i+this.cellCentreY))}}var s=-(this.cellCentreX+this.cellCentreY)*this.cellWidth,o=-(this.cellCentreY-this.cellCentreX)*this.cellHeight;this.transformLayer.setAttribute("transform","translate("+this.viewCentreX+","+this.viewCentreY+") scale("+this.scaleFactor/2+") translate("+s+","+o+")")},PerspectiveGridView.prototype.getLayoutX=function(e,t){return e+t},PerspectiveGridView.prototype.getLayoutY=function(e,t){return t-e},PerspectiveGridView.prototype.inView=function(e,t){var n=e-this.cellCentreX+(t-this.cellCentreY),r=t-this.cellCentreY-(e-this.cellCentreX);return Math.abs(n)<=this.maxX&&r>=-this.maxY&&r<=this.maxY+this.extraBottomRows},KevLinDev.extend(PerspectiveGridViewContents,LitGridViewContents),KevLinDev.extend(PerspectiveGridViewItem,LitGridViewItem),PerspectiveGridViewItem.prototype.setLighting=function(){PerspectiveGridViewItem.superClass.setLighting.call(this);var e=this.modelItem.cellContents;if(e==null)return;for(var t in this.elements){if(this.elements[t]==null||t=="bottom"||t=="highlight")continue;var n=e.ambientLight;for(var r in e.seenBy){var i=e.seenBy[r].item.params;if(i.lightStrength==null||i.lightStrength==0)continue;if(e.seenBy[r].viewElev>this.modelItem.params.elev+this.modelItem.params.ht)continue;if(t=="top"){if(i.elev+i.ht<this.modelItem.params.elev+this.modelItem.params.ht)continue;var s=e.model.calcLightLevel(e.seenBy[r].distance,i.lightStrength);s>n&&(n=s)}else{if(e.seenBy[r].distance==0)continue;var o=0;if(t=="left"){if(e.seenBy[r].x>=e.x)continue;o=e.model.getDistance(e.seenBy[r].x,e.seenBy[r].y,e.x-1,e.y)}else if(t=="front"){if(e.seenBy[r].y<=e.y)continue;o=e.model.getDistance(e.seenBy[r].x,e.seenBy[r].y,e.x,e.y+1)}var s=e.model.calcLightLevel(o,e.seenBy[r].item.params.lightStrength);s>n&&(n=s)}}this.elements[t].setLightLevel(n)}},KevLinDev.extend(BlockGridViewItem,PerspectiveGridViewItem),BlockGridViewItem.prototype.onBeingAdded=function(){this.updateNearbyHeights()},BlockGridViewItem.prototype.updateNearbyHeights=function(){this.updateHeight();if(this.rootContainer.view!=null){var e=this.rootContainer.x_index,t=this.rootContainer.y_index;this.updateItemHeightsAtContents(this.rootContainer.view,e+1,t),this.updateItemHeightsAtContents(this.rootContainer.view,e,t-1)}},BlockGridViewItem.prototype.updateHeight=function(){var e=-this.modelItem.params.elev-this.modelItem.params.ht;this.rootContainer.setMouseoverPosition(0,e),this.itemGraphics.setAttribute("transform","translate(0, "+e+")");var t=this.modelItem.cellContents;if(t==null)return;var n=t.model.getContents(t.x-1,t.y),r=getTopBlockItem(n),i=this.modelItem.params.ht;r!=null&&(i=this.modelItem.params.ht+this.modelItem.params.elev-r.params.elev-r.params.ht,i>this.modelItem.params.ht&&(i=this.modelItem.params.ht));if(i>0){var s=this.viewItemFactory.getVerticalPath(i,0);this.elements.left.base.setAttribute("d",s),this.elements.left.show()}else this.elements.left.base.removeAttribute("d"),this.elements.left.hide();var o=t.model.getContents(t.x,t.y+1),u=getTopBlockItem(o),a=this.modelItem.params.ht;u!=null&&(a=this.modelItem.params.ht+this.modelItem.params.elev-u.params.elev-u.params.ht,a>this.modelItem.params.ht&&(a=this.modelItem.params.ht));if(a>0){var s=this.viewItemFactory.getVerticalPath(a,1);this.elements.front.base.setAttribute("d",s),this.elements.front.show()}else this.elements.front.base.removeAttribute("d"),this.elements.front.hide()},BlockGridViewItem.prototype.updateItemHeightsAtContents=function(e,t,n){if(e.view[t]!=null){var r=this.rootContainer.view.view[t][n];r!=null&&r.tellActionListeners(r,{type:"otherItemHeight"})}},BlockGridViewItem.prototype.doAction=function(e,t){BlockGridViewItem.superClass.doAction.call(this,e,t),t.type=="paramChanged"?t.name=="ht"?this.updateNearbyHeights():t.name=="isHighlighted"?this.setHighlight(t.value):t.name=="elev"&&this.updateHeight():t.type=="otherItemHeight"?this.updateHeight():t.type=="InTheWay"?this.setAttribute("opacity",t.opacity):t.type!="paramChanged"},BlockGridViewItem.prototype.setHighlight=function(e){if(this.elements["highlight"]==null)return;e?this.elements.highlight.show():this.elements.highlight.hide()},BlockGridViewItem.prototype.updatePOV=function(e){var t=this.modelItem.cellContents;if(t==null)return;if(e==null)this.elements.top.setVisible(!0),this.elements.left.setVisible(!0),this.elements.front.setVisible(!0);else if(this.itemGraphics!=null){var n=this.modelItem.params.elev+this.modelItem.params.ht,r=!1,i=!1,s=!1,o=!1,u=!1,a=!1;for(var f in t.seenBy)if(t.seenBy[f].viewType=="pov")for(var l in e)if(e[l]==t.seenBy[f].item){t.seenBy[f].viewElev<=this.modelItem.params.elev&&(i=!0);var c=t.seenBy[f].item.params.elev+t.seenBy[f].item.params.ht;t.seenBy[f].viewElev<=n&&(c>=n&&(r=!0),t.seenBy[f].x<t.x&&(s=!0),t.seenBy[f].y>t.y&&(u=!0));break}if(!s){var h=t.model.getContents(t.x-1,t.y);for(var f in h.seenBy)if(h.seenBy[f].viewType=="pov")for(var l in e)e[l]==h.seenBy[f].item&&h.seenBy[f].viewElev<=n&&h.seenBy[f].x<t.x&&(s=!0)}if(!u){var p=t.model.getContents(t.x,t.y+1);for(var f in p.seenBy)if(p.seenBy[f].viewType=="pov")for(var l in e)e[l]==p.seenBy[f].item&&p.seenBy[f].viewElev<=n&&p.seenBy[f].y>t.y&&(u=!0)}this.elements.top.setVisible(r),this.elements.left.setVisible(s),this.elements.front.setVisible(u)}for(var d in this.containedItems.childNodes)this.containedItems.childNodes[d].updatePOV(e)},KevLinDev.extend(SimpleBlockGridViewItem,SVGComponent),SimpleBlockGridViewItem.prototype.doAction=function(e,t){SimpleBlockGridViewItem.superClass.doAction.call(this,e,t),t.type=="paramChanged"&&t.name=="ht"&&this.setHeight(t.value)},SimpleBlockGridViewItem.prototype.setHeight=function(e){var t=this.itemViewFactory.getVerticalPath(e,0);this.leftRect.setAttribute("d",t);var n=this.itemViewFactory.getVerticalPath(e,1);this.frontRect.setAttribute("d",n)},KevLinDev.extend(StateDirectionShadowElement,ShadowElement),StateDirectionShadowElement.prototype.setState=function(e,t,n){e==null&&(this.directionName==null?e="f":e=this.directionName);var r=!1,i=!1,s=null;for(var o=0;o<this.itemStates.length;++o)this.itemStates[o].parentTag==null&&this.itemStates[o].myTag==null&&s==null?s=this.itemStates[o]:this.itemStates[o].parentTag!=null&&this.itemStates[o].myTag==null&&!i&&t!=null&&t.indexOf(this.itemStates[o].parentTag)>=0?(i=!0,r=!1,s=this.itemStates[o]):this.itemStates[o].parentTag==null&&this.itemStates[o].myTag!=null&&!i&&!r&&n!=null&&n.indexOf(this.itemStates[o].myTag)>=0?(r=!0,s=this.itemStates[o]):this.itemStates[o].parentTag!=null&&this.itemStates[o].myTag!=null&&(!i||!r)&&t!=null&&n!=null&&t.indexOf(this.itemStates[o].parentTag)>=0&&n.indexOf(this.itemStates[o].myTag)>=0&&(r=!0,i=!0,s=this.itemStates[o]);this.itemState!=s&&(this.itemState!=null&&(this.itemState.state.hide(),this.itemDirection!=null&&this.itemDirection.hide()),this.itemState=s,this.itemState!=null&&this.itemState.state.show(),this.setDirection(null)),this.setDirection(e)},StateDirectionShadowElement.prototype.stateMatchesTags=function(e,t){if(e!=null&&t!=null)for(var n=0;n<t.length;++n)if(t[n]==e)return!0;return!1},StateDirectionShadowElement.prototype.setDirection=function(e){if(this.directionName==e&&this.directionName!=null)return;this.directionName!=null&&this.itemStateDirection.hide(),this.directionName=e,this.itemStateDirection=null,this.itemState!=null&&this.itemState.directions[this.directionName]!=null&&(this.itemStateDirection=this.itemState.directions[this.directionName],this.itemStateDirection.show())},KevLinDev.extend(StateGridViewItem,LitGridViewItem),StateGridViewItem.prototype.updateElevation=function(){var e=-this.modelItem.params.elev;this.itemGraphics.setAttribute("transform","translate(0, "+e+")")},StateGridViewItem.prototype.updateState=function(){var e=this.modelItem.owner!=null&&this.modelItem.owner.params!=null?this.modelItem.owner.params.itemTags:null;this.stateItem.setState(this.modelItem.params.direction,e,this.modelItem.params.itemTags)},StateGridViewItem.prototype.doAction=function(e,t){StateGridViewItem.superClass.doAction.call(this,e,t),t.type=="paramChanged"?t.name=="direction"?this.stateItem.setDirection(t.value):t.name=="elev"&&this.updateElevation():t.type=="tagAdded"&&this.updateState()},KevLinDev.extend(SelectableViewItem,ParamButton),KevLinDev.extend(PerspectiveItemFactory,LitContentFactory),PerspectiveItemFactory.prototype.makeContents=function(e,t,n,r){return new PerspectiveGridContents(e,t,n,r,this.ambientLight)},PerspectiveItemFactory.prototype.makeItemFromXML=function(e,t){var n=e.getAttribute("c"),r=this.makeItem(n);e.hasAttribute("id")&&(r.id=e.getAttribute("id"),t.importItem(r)),r.setHeight(parseInt(e.getAttribute("h")),!0),e.hasAttribute("d")&&r.setDirection(e.getAttribute("d"),!0);for(var i=0;i<e.childNodes.length;i++){var s=e.childNodes.item(i),o=this.makeItemFromXML(s,t);r.appendItem(o),o.params.moveTowards!=null&&t.addToMoveableItems(o)}return r},PerspectiveItemFactory.prototype.makeItem=function(e){if(e==null)return null;var t=this.baseSummary[e];if(t!=null)return new PerspectiveGridItem({itemName:t[0],itemCode:e,canStandOn:t[4],blockView:!0,isBlock:!0,wtPerHt:t[5]});var n=this.itemTemplates[e];if(n!=null){var r={};for(var i in n)r[i]=n[i];return new PerspectiveGridItem(r)}return null},PerspectiveItemFactory.prototype.makeViewContents=function(e,t,n,r,i,s,o){return new PerspectiveGridViewContents(e,t,n,r,i,s,o)},PerspectiveItemFactory.prototype.makeSimpleViewItem=function(e){return this.baseSummary[e.params.itemCode]!=null?new SimpleBlockGridViewItem(this,e.params.itemCode,e.params.ht):this.makeSimpleViewItemFromCode(e.params.itemCode)},PerspectiveItemFactory.prototype.makeSimpleViewItemFromCode=function(e){var t=this.itemTemplates[e];if(t!=null){var n=new SVGElement,r=this.artwork.getElementById(t.itemName+"_def_def");return n.cloneElement(r),n.removeAttribute("display"),n.removeAttribute("style"),n}return null},PerspectiveItemFactory.prototype.makeViewItem=function(e){if(e==null)return null;var t=this.baseSummary[e.params.itemCode];if(t!=null){var n=new ShadowElement(new SVGElement("path",{d:this.baseRect,fill:this.baseSummary[e.params.itemCode][1],stroke:"none"}),!0,!0),r=new ShadowElement(new SVGElement("path",{fill:this.baseSummary[e.params.itemCode][2],stroke:"none"}),!0,!0),i=new ShadowElement(new SVGElement("path",{fill:this.baseSummary[e.params.itemCode][3],stroke:"none"}),!0,!0);r.hide(),i.hide();var s=new ShadowElement(null,!0,!0),o=new SVGElement("path",{d:this.baseRect,fill:"red",stroke:"black",opacity:.5}),u={bottom:s,front:i,left:r,top:n,highlight:o};return new BlockGridViewItem(e,this,u)}var a=this.itemTemplates[e.params.itemCode];if(a!=null){var f="def";e.params.state!=null&&(f=e.params.state);var l="f";e.params.direction!=null&&(l=e.params.direction);var c=new SVGElement;c.cloneElement(this.artwork.getElementById(a.itemName));var h=!0;e.params.isInvisible&&(h=!1);var p=new StateDirectionShadowElement(c,h,!1);return new StateGridViewItem(e,this,p)}return null},PerspectiveItemFactory.prototype.getVerticalPath=function(e,t){return this.verticalTemplate[t].replace(/x/gi,this.x).replace(/y/gi,this.y).replace(/d/gi,e).replace(/f/gi,this.y+e).replace(/g/gi,this.delta).replace(/h/gi,this.y-this.slope*this.delta).replace(/j/gi,this.y+e-this.slope*this.delta).replace(/p/gi,-this.delta).replace(/q/gi,this.y+e-this.slope*this.delta).replace(/r/gi,this.y-this.slope*this.delta)},PerspectiveItemFactory.prototype.createSpeechBubble=function(e){if(this.artwork==null)return null;var t=this.artwork.getElementById("speechBubble");if(t==null)return null;var n=parseInt(t.getAttribute("bubbleX")),r=parseInt(t.getAttribute("bubbleY")),i=new SVGElement("g"),s=t.cloneNode(!0);i.svg.appendChild(s);var o=new MultilineText(n,r+3,e,{"font-size":14,fill:"white"},{maxWidth:120,lineSpacing:.3});return i.appendChild(o),i},KevLinDev.extend(ACItemHandler,ActionObject),ACItemHandler.prototype.setItem=function(e){if(e==this.item)return;this.item!=null&&this.item.removeActionListener(this),this.item=e,this.item!=null&&(this.item.addActionListener(this),this.item.id==null&&this.model.registerItem(e)),this.tellActionListeners(this,{type:"itemUpdated",item:this.item})},ACItemHandler.prototype.setItemMatchCriterion=function(e,t){if(e==this.matchCriterion&&(t==null||this.item.params.itemTags[0]==t))return;t!=null&&this.item.params.itemTags.push(t),this.matchCriterion=e,this.tellActionListeners(this,{type:"itemUpdated",item:this.item})},ACItemHandler.prototype.matchesItem=function(e){if(e==null||this.item==null)return e==this.item;if(this.matchCriterion=="code"){if(e.params.itemCode!=null&&e.params.itemCode==this.item.params.itemCode)return!0}else if(this.matchCriterion=="id"){if(e.id==this.item.id)return!0}else if(this.matchCriterion=="tag")for(var t=0;t<e.params.itemTags.length;++t)for(var n=0;n<this.item.params.itemTags.length;++n)if(e.params.itemTags[t]==this.item.params.itemTags[n])return!0;return!1},ACItemHandler.prototype.addToXML=function(e){this.item!=null&&(this.matchCriterion=="code"?e.setAttribute(this.itemName+"ItemCode",this.item.params.itemCode):this.matchCriterion=="id"?e.setAttribute(this.itemName+"ItemId",this.item.id):this.matchCriterion=="tag"&&e.setAttribute(this.itemName+"ItemTag",this.item.
params.itemTags[0]))},ACItemHandler.prototype.fromXML=function(e){var t=null,n=e.getAttribute(this.itemName+"ItemId");if(n!=null)this.matchCriterion="id",t=this.model.getItemById(n);else{var r=e.getAttribute(this.itemName+"ItemCode");if(r!=null)this.matchCriterion="code",t=this.model.itemFactory.makeItem(r);else{var i=e.getAttribute(this.itemName+"ItemTag");i!=null&&(this.matchCriterion="tag",t=this.model.itemFactory.makeItem("t"),t.params.itemTags.push(i))}}this.setItem(t)},ACItemHandler.prototype.doAction=function(e,t){t.type=="ItemBeingDeleted"&&this.item.markedForDeath&&this.setItem(null)},ACItemHandler.prototype.onDelete=function(){this.item!=null&&this.item.removeActionListener(this)},MyActionFactory.prototype.fromXML=function(e){var t=null;switch(e.getAttribute("type")){case"Speech":t=new SpeechAction(this.model,this.controller,null,null);break;case"Height":t=new HeightAction(this.model,this.controller,null,0);break;case"Teleport":t=new TeleportAction(this.model,this.controller,0);break;default:}return t==null?null:(t.fromXML(e),t)},KevLinDev.extend(GameAction,ActionObject),GameAction.prototype.addCondition=function(e){this.conditions.push(e),this.tellActionListeners(this,{type:"actionUpdated"})},GameAction.prototype.attemptAction=function(){var e=!0;for(var t=0;t<this.conditions.length;++t)if(!this.conditions[t].isMet()){e=!1;break}return e&&this.occuranceCount++,this.performAction(e)},GameAction.prototype.performAction=function(e){return!0},GameAction.prototype.onDelete=function(){},GameAction.prototype.toXML=function(){var e=this.model.xmlDoc.createElement("action");e.setAttribute("type",this.type);for(var t=0;t<this.conditions.length;++t){var n=this.model.xmlDoc.createElement("condRef");n.setAttribute("condId",this.conditions[t].id),e.appendChild(n)}return e},GameAction.prototype.fromXML=function(e){this.controller==null&&alert("Oops! Trying to get item action from XML, but item action doesn't have a controller.");for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes.item(t),r=this.controller.getConditionById(n.getAttribute("condId"));r!=null&&this.conditions.push(r)}},GameAction.prototype.doAction=function(e,t){t.type=="itemUpdated"&&this.tellActionListeners(this,{type:"actionUpdated"})},KevLinDev.extend(SpeechAction,GameAction),SpeechAction.prototype.setSpeechArray=function(e){this.speechArray=e,this.speechArray==null&&(this.speechArray=[]),this.tellActionListeners(this,{type:"actionUpdated"})},SpeechAction.prototype.performAction=function(e){if(this.speechItem.item==null)return;var t=null;return e&&this.currentIndex<this.speechArray.length&&(t=this.speechArray[this.currentIndex],this.currentIndex++,this.controller.setItemSpeech(this.speechItem.item,t)),!0},SpeechAction.prototype.toXML=function(){var e=SpeechAction.superClass.toXML.call(this);return e.setAttribute("speech",htmlspecialchars(this.speechArray.join("|"))),this.speechItem.addToXML(e),e},SpeechAction.prototype.fromXML=function(e){SpeechAction.superClass.fromXML.call(this,e),this.speechItem.fromXML(e);var t=htmlspecialchars_decode(e.getAttribute("speech"));this.setSpeechArray(t.split("|"))},SpeechAction.prototype.onDelete=function(){this.speechItem.onDelete(),this.speechItem.removeActionListener(this)},KevLinDev.extend(HeightAction,GameAction),HeightAction.prototype.doAction=function(e,t){t.type=="itemUpdated"&&e.item!=null&&(this.oldHeight=e.item.params.ht),HeightAction.superClass.doAction.call(this,e,t)},HeightAction.prototype.setHeight=function(e){this.newHeight=e,this.tellActionListeners(this,{type:"actionUpdated"})},HeightAction.prototype.performAction=function(e){if(this.heightItem.item==null)return;return e?this.heightItem.item.params.ht!=this.newHeight&&(this.oldHeight=this.heightItem.item.params.ht,this.heightItem.item.setHeight(this.newHeight,!1)):this.heightItem.item.params.ht!=this.oldHeight&&this.heightItem.item.setHeight(this.oldHeight,!1),!0},HeightAction.prototype.toXML=function(){var e=HeightAction.superClass.toXML.call(this);return e.setAttribute("ht",this.newHeight),this.heightItem.addToXML(e),e},HeightAction.prototype.fromXML=function(e){HeightAction.superClass.fromXML.call(this,e),this.heightItem.fromXML(e);var t=parseInt(e.getAttribute("ht"));this.setHeight(t)},HeightAction.prototype.onDelete=function(){this.heightItem.onDelete(),this.heightItem.removeActionListener(this)},KevLinDev.extend(TeleportAction,GameAction),TeleportAction.prototype.setDestination=function(e){this.destination=e,this.tellActionListeners(this,{type:"actionUpdated"})},TeleportAction.prototype.performAction=function(e){return e&&this.controller.turnClock.currentTime!=0?(this.controller.parentController.gameServerInterface.submitSaveItemsAndTeleport(this.destination),!1):!0},TeleportAction.prototype.toXML=function(){var e=TeleportAction.superClass.toXML.call(this);return e.setAttribute("dest",this.destination),e},TeleportAction.prototype.fromXML=function(e){TeleportAction.superClass.fromXML.call(this,e);var t=parseInt(e.getAttribute("dest"));this.setDestination(t)},KevLinDev.extend(MoveAction,GameAction),MoveAction.prototype.performAction=function(e){return e&&this.targetItem.item!=null&&this.destItem.item!=null&&this.targetItem.item.moveItem(this.destItem.item),!0},MoveAction.prototype.toXML=function(){var e=MoveAction.superClass.toXML.call(this);return this.targetItem.addToXML(e),this.destItem.addToXML(e),e},MoveAction.prototype.fromXML=function(e){MoveAction.superClass.fromXML.call(this,e),this.targetItem.fromXML(e),this.destItem.fromXML(e)},MoveAction.prototype.onDelete=function(){this.targetItem.onDelete(),this.destItem.onDelete(),this.targetItem.removeActionListener(this),this.destItem.removeActionListener(this)},KevLinDev.extend(ActionController,ActionObject),ActionController.prototype.clear=function(){for(var e=0;e<this.itemActionList.length;++e)this.itemActionList[e].onDelete();this.itemActionList=[];for(var e in this.condIdList)this.condIdList[e].onDelete();this.conditionIdIndex=0,this.condIdList={},this.clearSpeakingItems(),this.tellActionListeners(this,{type:"allActionsAndConditionsDeleted"})},ActionController.prototype.clearSpeakingItems=function(){for(var e=0;e<this.speakingItems.length;++e)this.speakingItems[e].setItemParam("speech",null,!1);this.speakingItems=[]},ActionController.prototype.setItemSpeech=function(e,t){e.setItemParam("speech",t,!1),this.speakingItems.push(e)},ActionController.prototype.teleportTo=function(e){this.parentController.gameServerInterface.submitLoadMap(e)},ActionController.prototype.toXML=function(e){for(var t in this.condIdList){var n=!1;for(var r=0;r<this.itemActionList.length;++r){for(var i=0;i<this.itemActionList[r].conditions.length;++i)if(this.itemActionList[r].conditions[i]==this.condIdList[t]){n=!0;break}if(n)break}if(n){var s=this.condIdList[t].toXML();e.appendChild(s)}}for(var t=0;t<this.itemActionList.length;++t){var o=this.itemActionList[t].toXML();e.appendChild(o)}},ActionController.prototype.fromXML=function(e){if(e==null)return;var t=e.getElementsByTagName("cond");for(var n=0;n<t.length;n++){var r=this.conditionFactory.fromXML(t.item(n));this.importCondition(r)}var i=e.getElementsByTagName("action");for(var n=0;n<i.length;n++){var s=this.actionFactory.fromXML(i.item(n));this.appendAction(s)}},ActionController.prototype.registerCondition=function(e){e.id==null&&(e.id="c_"+this.conditionIdIndex++),this.condIdList[e.id]=e},ActionController.prototype.importCondition=function(e){if(e.id==null)return;var t=parseInt(e.id.slice(2));t>=this.conditionIdIndex&&(this.conditionIdIndex=t+1),this.condIdList[e.id]=e},ActionController.prototype.getConditionById=function(e){return this.condIdList[e]},ActionController.prototype.appendAction=function(e){e.controller=this,this.itemActionList.push(e),this.tellActionListeners(e,{type:"ActionAdded"})},ActionController.prototype.removeAction=function(e){for(var t=0;t<this.itemActionList.length;++t)if(this.itemActionList[t]==e){e.onDelete(),e.tellActionListeners(this,{type:"actionDeleted"}),e.controller=null,this.itemActionList.splice(t,1);break}for(var t=0;t<e.conditions.length;++t){var n=!1;for(var r=0;r<this.itemActionList.length;++r)for(var i=0;i<this.itemActionList[r].conditions.length;++i)if(this.itemActionList[r].conditions[i]==e.conditions[t]){n=!0;break}n||this.removeCondition(e.conditions[t])}},ActionController.prototype.removeCondition=function(e){for(var t=0;t<this.itemActionList.length;++t)for(var n=0;n<this.itemActionList[t].conditions.length;++n){var r=this.itemActionList[t].conditions[n];if(r==e){e.tellActionListeners(this,{type:"conditionDeleted"}),this.itemActionList[t].conditions.splice(n,1);break}}},ActionController.prototype.attemptActions=function(){for(var e=0;e<this.itemActionList.length;++e){var t=this.itemActionList[e].attemptAction();if(!t)return}},KevLinDev.extend(ActionSummary,RectLabel),ActionSummary.prototype.updateConditionSummaries=function(e){this.clearConditionSummaries();for(var t in e){var n=makeConditionSummary(this.controller,e[t]);this.conditionSummaries.appendChild(n),n.addActionListener(this)}},ActionSummary.prototype.clearConditionSummaries=function(){this.conditionSummaries.removeChildren()},ActionSummary.prototype.doAction=function(e,t){ActionSummary.superClass.doAction.call(this,e,t),t.type=="click"&&e.src=="editAction"?this.tellActionListeners(this.myAction,{type:"actionEditRequested"}):t.type=="actionUpdated"?this.initFromAction():t.type=="actionDeleted"&&this.tellActionListeners(this,{type:"actionSummaryDeleted"})},ActionSummary.prototype.initFromAction=function(){this.refreshLayout()},KevLinDev.extend(HeightActionSummary,ActionSummary),HeightActionSummary.prototype.initFromAction=function(){this.setSelectedItem(this.myAction.heightItem.item),this.setNewHeight(this.myAction.newHeight),HeightActionSummary.superClass.initFromAction.call(this)},HeightActionSummary.prototype.setNewHeight=function(e){this.newHeight=e,this.finalItemAppearancePresEl!=null&&(this.finalItemAppearancePresEl.setHeight(e),this.finalItemAppearancePres.refreshLayout())},HeightActionSummary.prototype.setSelectedItem=function(e){if(this.selectedItem==e)return;this.itemPresentationLabel.setSelectedItem(e),e!=null?(this.newHeight=e.params.ht,this.rightArrowLabelPres.show(),this.finalItemAppearancePres.show(),this.finalItemAppearancePresEl=this.controller.model.itemFactory.makeSimpleViewItem(e),this.finalItemAppearancePres.setContents(this.finalItemAppearancePresEl)):(this.rightArrowLabelPres.hide(),this.finalItemAppearancePres.setContents(null),this.finalItemAppearancePres.hide())},KevLinDev.extend(SpeechActionSummary,ActionSummary),SpeechActionSummary.prototype.initFromAction=function(){this.itemPresentationLabel.setSelectedItem(this.myAction.speechItem.item),this.setSpeechArray(this.myAction.speechArray),SpeechActionSummary.superClass.initFromAction.call(this)},SpeechActionSummary.prototype.setSpeechArray=function(e){var t=e.join("|");t.length>20&&(t=t.substr(0,17)+"..."),this.speechPresentationElement.setValue(t),this.presentationLayout.refreshLayout()},KevLinDev.extend(TeleportActionSummary,ActionSummary),TeleportActionSummary.prototype.initFromAction=function(){this.setDestination(this.myAction.destination),TeleportActionSummary.superClass.initFromAction.call(this)},TeleportActionSummary.prototype.setDestination=function(e){var t="";e!=null&&this.controller.visitedWorlds[e]!=null&&(t=this.controller.visitedWorlds[e].map_name),this.destinationPresentationElement.setValue(t),this.presentationLayout.refreshLayout()},KevLinDev.extend(MoveActionSummary,ActionSummary),MoveActionSummary.prototype.initFromAction=function(){this.targetLabel.setSelectedItem(this.myAction.targetItem.item),this.destinationLabel.setSelectedItem(this.myAction.destItem.item),MoveActionSummary.superClass.initFromAction.call(this)},KevLinDev.extend(ItemViewSelector,RectButton),ItemViewSelector.prototype.doAction=function(e,t){t.type=="click"&&e==this?(this.controller.editWindow.itemSelectorWindow.setClient(this,this.selectedItem,this.itemChoiceSet,this.tag),this.controller.editWindow.itemSelectorWindow.show()):t.type=="itemUpdated"&&this.setSelectedItem(t.item),ItemViewSelector.superClass.doAction.call(this,e,t)},ItemViewSelector.prototype.userHasSelectedItem=function(e,t){t==this.tag&&this.setSelectedItem(e)},ItemViewSelector.prototype.setSelectedItem=function(e){if(this.selectedItem==e)return;this.selectedItem=e;if(e!=null){var t=this.controller.model.itemFactory.makeSimpleViewItem(e);this.setContents(t)}else{var t=new SVGElement;t.cloneElement(this.controller.artwork.getElementById("clickToChooseItem")),this.setContents(t)}this.tellActionListeners(this,{type:"itemViewUpdated"})},KevLinDev.extend(ActionEditor,SVGWindow),ActionEditor.prototype.updateConditionSummaries=function(e){this.clearConditionSummaries();for(var t in e)this.addConditionSummary(e[t])},ActionEditor.prototype.clearConditionSummaries=function(){this.conditionSummaries.removeChildren()},ActionEditor.prototype.addConditionSummary=function(e){var t=makeConditionSummary(this.controller,e,!1);this.conditionSummaries.appendChild(t),t.addActionListener(this)},ActionEditor.prototype.deleteConditionSummary=function(e){this.conditionSummaries.removeChild(e)},ActionEditor.prototype.doAction=function(e,t){ActionEditor.superClass.doAction.call(this,e,t);if(t.type=="click"){var n=null;switch(e.src){case"cancelAction":this.initFromAction(),this.tellActionListeners(this,{type:"cancelAction"});break;case"updateAction":this.tellActionListeners(this,{type:"updateAction"}),this.controller.setMapSavedStatus(!1);break;case"deleteAction":this.tellActionListeners(this,{type:"deleteAction"}),this.controller.setMapSavedStatus(!1);break;case"iconConditionTime":n=new TimestampCondition(this.controller.model,this.controller,this.controller.turnClock,0);break;case"iconConditionWeight":n=new WeightCondition(this.controller.model,this.controller,null,1);break;case"iconConditionHasItem":n=new HasItemCondition(this.controller.model,this.controller,null,!1,null)}n!=null&&(n.id==null&&this.controller.actionController.registerCondition(n),this.myAction.addCondition(n),this.appendConditionEditor(n),this.addConditionSummary(n),this.controller.setMapSavedStatus(!1))}else t.type=="deleteCondition"?(this.controller.actionController.removeCondition(e.myCondition),this.controller.setMapSavedStatus(!1),this.setAble(!0),this.removeChild(e)):t.type=="cancelCondition"?(this.setAble(!0),this.removeChild(e)):t.type=="updateCondition"?(this.setAble(!0),this.removeChild(e)):t.type=="conditionSummaryDeleted"?this.deleteConditionSummary(e):t.type=="conditionEditRequested"&&this.appendConditionEditor(e)},ActionEditor.prototype.appendConditionEditor=function(e){var t=makeConditionEditor(this.controller,e);t!=null&&(t.addActionListener(this),this.setAble(!1),this.appendChild(t))},ActionEditor.prototype.initFromAction=function(){},KevLinDev.extend(SpeechActionEditor,ActionEditor),SpeechActionEditor.prototype.initFromAction=function(){this.speechItemButton.setSelectedItem(this.myAction.speechItem.item),this.setSpeechArray(this.myAction.speechArray),this.refreshLayout()},SpeechActionEditor.prototype.doAction=function(e,t){if(t.type=="click")switch(e.src){case"updateAction":var n=this.speechEditTextbox.textVal.split("|");this.myAction.speechItem.setItem(this.speechItemButton.selectedItem),this.myAction.setSpeechArray(n),this.setSpeechArray(n)}SpeechActionEditor.superClass.doAction.call(this,e,t)},SpeechActionEditor.prototype.setSpeechArray=function(e){var t=e.join("|");this.speechEditTextbox.setValue(t)},KevLinDev.extend(MoveActionEditor,ActionEditor),MoveActionEditor.prototype.initFromAction=function(){this.targetItemButton.setSelectedItem(this.myAction.targetItem.item),this.destinationItemButton.setSelectedItem(this.myAction.destItem.item),this.refreshLayout()},MoveActionEditor.prototype.doAction=function(e,t){if(t.type=="click")switch(e.src){case"updateAction":this.myAction.targetItem.setItem(this.targetItemButton.selectedItem),this.myAction.destItem.setItem(this.destinationItemButton.selectedItem)}MoveActionEditor.superClass.doAction.call(this,e,t)},KevLinDev.extend(HeightActionEditor,ActionEditor),HeightActionEditor.prototype.initFromAction=function(){this.heightItemButton.setSelectedItem(this.myAction.heightItem.item),this.updateHeightEditAppearance(this.heightItemButton.selectedItem),this.setNewHeight(this.myAction.newHeight),this.refreshLayout()},HeightActionEditor.prototype.doAction=function(e,t){if(t.type=="click")switch(e.src){case"upArrowButton":this.setNewHeight(this.newHeight+5);break;case"downArrowButton":this.setNewHeight(this.newHeight-5);break;case"updateAction":this.myAction.heightItem.setItem(this.heightItemButton.selectedItem),this.myAction.setHeight(this.newHeight),this.setNewHeight(this.newHeight)}else t.type=="itemViewUpdated"&&this.updateHeightEditAppearance(this.heightItemButton.selectedItem);HeightActionEditor.superClass.doAction.call(this,e,t)},HeightActionEditor.prototype.setNewHeight=function(e){this.newHeight=e,this.finalItemAppearanceEditEl!=null&&(this.finalItemAppearanceEditEl.setHeight(e),this.finalItemAppearanceEdit.refreshLayout())},HeightActionEditor.prototype.updateHeightEditAppearance=function(e){e!=null?(this.newHeight=e.params.ht,this.rightArrowLabelEdit.show(),this.heightButtons.show(),this.finalItemAppearanceEdit.show(),this.finalItemAppearanceEditEl=this.controller.model.itemFactory.makeSimpleViewItem(e),this.finalItemAppearanceEdit.setContents(this.finalItemAppearanceEditEl)):(this.rightArrowLabelEdit.hide(),this.heightButtons.hide(),this.finalItemAppearanceEdit.setContents(null),this.finalItemAppearanceEdit.hide())},KevLinDev.extend(TeleportActionEditor,ActionEditor),TeleportActionEditor.prototype.initFromAction=function(){this.setDestination(this.myAction.destination),this.refreshLayout()},TeleportActionEditor.prototype.doAction=function(e,t){if(t.type=="click")switch(e.src){case"updateAction":this.myAction.setDestination(this.destinationId);break;case"selectTeleportButton":this.teleportWindow.show()}else t.type=="worldSelected"&&this.setDestination(t.value);TeleportActionEditor.superClass.doAction.call(this,e,t)},TeleportActionEditor.prototype.setDestination=function(e){this.destinationId=e;var t="";e!=null&&this.controller.visitedWorlds[e]!=null&&(this.teleportToText.setValue(this.controller.visitedWorlds[e].map_name),this.selectTeleportButton.refreshLayout())},KevLinDev.extend(ActionViewWindow,SVGWindow),ActionViewWindow.prototype.addActionSummary=function(e){var t=makeActionSummary(this.controller,e);this.actionSummaries.appendChild(t),t.addActionListener(this)},ActionViewWindow.prototype.deleteActionSummary=function(e){this.actionSummaries.removeChild(e)},ActionViewWindow.prototype.doAction=function(e,t){ActionViewWindow.superClass.doAction.call(this,e,t);if(t.type=="click"){var n=null;switch(e.src){case"iconActionSpeech":n=new SpeechAction(this.controller.model,this.controller,null,null);break;case"iconActionRaiseLower":n=new HeightAction(this.controller.model,this.controller,null,0);break;case"iconActionTeleport":n=new TeleportAction(this.controller.model,this.controller,null);break;case"iconActionMove":n=new MoveAction(this.controller.model,this.controller,null,null)}n!=null&&(this.controller.actionController.appendAction(n),this.appendActionEditor(n),this.controller.setMapSavedStatus(!1))}else t.type=="deleteAction"?(this.controller.actionController.removeAction(e.myAction),this.controller.setMapSavedStatus(!1),this.setAble(!0),this.removeChild(e)):t.type=="cancelAction"?(this.setAble(!0),this.removeChild(e)):t.type=="updateAction"?(this.setAble(!0),this.removeChild(e)):t.type=="actionSummaryDeleted"?this.deleteActionSummary(e):t.type=="actionEditRequested"?this.appendActionEditor(e):t.type=="allActionsAndConditionsDeleted"?this.actionSummaries.removeChildren():t.type=="ActionAdded"&&this.addActionSummary(e)},ActionViewWindow.prototype.appendActionEditor=function(e){var t=makeActionEditor(this.controller,e);t.addActionListener(this),this.setAble(!1),this.appendChild(t)},MyConditionFactory.prototype.fromXML=function(e){var t=null;switch(e.getAttribute("type")){case"Timestamp":t=new TimestampCondition(this.model,this.controller,this.turnClock,0);break;case"Weight":t=new WeightCondition(this.model,this.controller,null,0);break;case"HasItem":t=new HasItemCondition(this.model,this.controller,null,!1,null);break;default:}return t==null?null:(t.fromXML(e),t)},KevLinDev.extend(GameCondition,ActionObject),GameCondition.prototype.isMet=function(){return!1},GameCondition.prototype.onDelete=function(){},GameCondition.prototype.toXML=function(){var e=this.model.xmlDoc.createElement("cond");return e.setAttribute("id",this.id),e.setAttribute("type",this.type),e},GameCondition.prototype.fromXML=function(e){this.id=e.getAttribute("id")},GameCondition.prototype.doAction=function(e,t){t.type=="itemUpdated"&&this.tellActionListeners(this,{type:"conditionUpdated"})},KevLinDev.extend(TimestampCondition,GameCondition),TimestampCondition.prototype.isMet=function(){return this.turnClock.currentTime==this.timestamp},TimestampCondition.prototype.setTimestamp=function(e){this.timestamp=e,this.tellActionListeners(this,{type:"conditionUpdated"})},TimestampCondition.prototype.toXML=function(){var e=TimestampCondition.superClass.toXML.call(this);return e.setAttribute("timestamp",this.timestamp),e},TimestampCondition.prototype.fromXML=function(e){TimestampCondition.superClass.fromXML.call(this,e),this.setTimestamp(parseInt(e.getAttribute("timestamp")))},KevLinDev.extend(WeightCondition,GameCondition),WeightCondition.prototype.isMet=function(){if(this.weightItem.item==null)return!1;var e=this.weightItem.item.getFlattenedTree(),t=0;for(var n in e)e[n]!=this.weightItem.item&&e[n].params.wt!=null&&(t+=e[n].params.wt);return t>=this.minWeight},WeightCondition.prototype.setMinWeight=function(e){this.minWeight=e,this.tellActionListeners(this,{type:"conditionUpdated"})},WeightCondition.prototype.toXML=function(){var e=WeightCondition.superClass.toXML.call(this);return e.setAttribute("minWt",this.minWeight),this.weightItem.addToXML(e),e},WeightCondition.prototype.fromXML=function(e){WeightCondition.superClass.fromXML.call(this,e),this.weightItem.fromXML(e),this.setMinWeight(parseInt(e.getAttribute("minWt")))},WeightCondition.prototype.onDelete=function(){this.weightItem.onDelete()},KevLinDev.extend(HasItemCondition,GameCondition),HasItemCondition.prototype.isMet=function(){if(this.containerItem.item==null)return!1;var e=this.containerItem.item.getFlattenedTree();for(var t in e)if(this.heldItem.matchesItem(e[t]))return!0;return!1},HasItemCondition.prototype.toXML=function(){var e=HasItemCondition.superClass.toXML.call(this);return this.heldItem.addToXML(e),this.heldItem.addActionListener(this),this.containerItem.addToXML(e),this.containerItem.addActionListener(this),e},HasItemCondition.prototype.fromXML=function(e){HasItemCondition.superClass.fromXML.call(this,e),this.heldItem.fromXML(e),this.containerItem.fromXML(e)},HasItemCondition.prototype.onDelete=function(){this.heldItem.onDelete(),this.containerItem.onDelete()},KevLinDev.extend(ConditionSummary,RectLabel),ConditionSummary.prototype.doAction=function(e,t){ConditionSummary.superClass.doAction.call(this,e,t);if(t.type=="click")switch(e.src){case"editCondition":this.tellActionListeners(this.myCondition,{type:"conditionEditRequested"})}else t.type=="conditionUpdated"?this.initFromCondition():t.type=="conditionDeleted"&&this.tellActionListeners(this,{type:"conditionSummaryDeleted"})},ConditionSummary.prototype.initFromCondition=function(){this.refreshLayout()},KevLinDev.extend(TimestampConditionSummary,ConditionSummary),TimestampConditionSummary.prototype.initFromCondition=function(){this.setTimestamp(this.myCondition.timestamp),TimestampConditionSummary.superClass.initFromCondition.call(this)},TimestampConditionSummary.prototype.setTimestamp=function(e){this.timestampPresentationElement.setValue("time: "+e),this.presentationLayout.refreshLayout()},KevLinDev.extend(WeightConditionSummary,ConditionSummary),WeightConditionSummary.prototype.initFromCondition=function(){this.itemPresentationLabel.setSelectedItem(this.myCondition.weightItem.item),this.setWeight(this.myCondition.minWeight),WeightConditionSummary.superClass.initFromCondition.call(this)},WeightConditionSummary.prototype.setWeight=function(e){this.weightPresentationElement.setValue("weight: "+e)},KevLinDev.extend(HasItemConditionSummary,ConditionSummary),HasItemConditionSummary.prototype.initFromCondition=function(){this.heldLabel.setSelectedItem(this.myCondition.heldItem.item),this.containerLabel.setSelectedItem(this.myCondition.containerItem.item),this.myCondition.heldItem.matchCriterion=="code"?this.thisOrAnyElement.setValue("any"):this.myCondition.heldItem.matchCriterion=="id"?this.thisOrAnyElement.setValue("this"):this.thisOrAnyElement.setValue("a"),HasItemConditionSummary.superClass.initFromCondition.call(this)},KevLinDev.extend(ConditionEditor,SVGWindow),ConditionEditor.prototype.doAction=function(e,t){ConditionEditor.superClass.doAction.call(this,e,t);if(t.type=="click")switch(e.src){case"cancelCondition":this.initFromCondition(),this.tellActionListeners(this,{type:"cancelCondition"});break;case"updateCondition":this.tellActionListeners(this,{type:"updateCondition"}),this.controller.setMapSavedStatus(!1);break;case"deleteCondition":this.tellActionListeners(this,{type:"deleteCondition"}),this.controller.setMapSavedStatus(!1)}},ConditionEditor.prototype.initFromCondition=function(){},KevLinDev.extend(TimestampConditionEditor,ConditionEditor),TimestampConditionEditor.prototype.initFromCondition=function(){this.setTimestamp(this.myCondition.timestamp),this.refreshLayout()},TimestampConditionEditor.prototype.doAction=function(e,t){if(t.type=="click")switch(e.src){case"updateCondition":var n=parseInt(this.timestampEditTextbox.textVal);this.myCondition.setTimestamp(n),this.setTimestamp(n)}TimestampConditionEditor.superClass.doAction.call(this,e,t)},TimestampConditionEditor.prototype.setTimestamp=function(e){this.timestampEditTextbox.setValue(e)},KevLinDev.extend(WeightConditionEditor,ConditionEditor),WeightConditionEditor.prototype.initFromCondition=function(){this.weightItemButton.setSelectedItem(this.myCondition.weightItem.item),this.setWeight(this.myCondition.minWeight),this.refreshLayout()},WeightConditionEditor.prototype.doAction=function(e,t){if(t.type=="click")switch(e.src){case"updateCondition":var n=parseInt(this.weightEditTextbox.textVal);this.myCondition.setMinWeight(n),this.setWeight(n),this.myCondition.weightItem.setItem(this.weightItemButton.selectedItem)}WeightConditionEditor.superClass.doAction.call(this,e,t)},WeightConditionEditor.prototype.setWeight=function(e){this.weightEditTextbox.setValue(e)},KevLinDev.extend(HasItemConditionEditor,ConditionEditor),HasItemConditionEditor.prototype.initFromCondition=function(){this.containerEditButton.setSelectedItem(this.myCondition.containerItem.item),this.itemEditButton.setSelectedItem(this.myCondition.heldItem.item),this.matchHeldByCodeCheckbox.setSelected(this.myCondition.heldItem.matchCriterion=="code"),this.matchHeldByIdCheckbox.setSelected(this.myCondition.heldItem.matchCriterion=="id"),this.matchHeldByTagCheckbox.setSelected(this.myCondition.heldItem.matchCriterion=="tag")},HasItemConditionEditor.prototype.doAction=function(e,t){if(t.type=="click")if(e.src=="updateCondition"){var n=this.matchHeldByCodeCheckbox.isSelected?"code":this.matchHeldByIdCheckbox.isSelected?"id":"tag",r=n=="tag"?"avatar":null;this.myCondition.heldItem.setItem(this.itemEditButton.selectedItem),this.myCondition.heldItem.setItemMatchCriterion(n,r),this.myCondition.containerItem.setItem(this.containerEditButton.selectedItem)}else e.src=="matchHeldByCodeCheckbox"||e.src=="matchHeldByIdCheckbox"?this.itemEditButton.selectedItem!=null&&this.itemEditButton.selectedItem.params.itemCode=="t"&&this.itemEditButton.setSelectedItem(null):e.src=="matchHeldByTagCheckbox"&&this.itemEditButton.setSelectedItem(this.controller.model.itemFactory.makeItem("t"));HasItemConditionEditor.superClass.doAction.call(this,e,t)},KevLinDev.extend(ContentLayoutView,SVGComponent),ContentLayoutView.prototype.setContents=function(e){var t=this.view.getLayoutX(e.x,e.y)*this.view.width,n=this.view.getLayoutY(e.x,e.y)*this.view.height;this.setPosition(t,n),this.show();if(this.cellContents==e)return;this.cellContents=e,this.tree.removeChildren();for(var r in this.cellContents.myItems){var i=makeItemLayout(this.view,this.cellContents.myItems[r]);this.tree.appendChild(i)}var s=this.tree.getBBox();this.bgRect.setAttribute("x",s.x-5),this.bgRect.setAttribute("y",s.y-5),this.bgRect.setAttribute("width",s.width+10),this.bgRect.setAttribute("height",s.height+10)},KevLinDev.extend(LoginController,ActionObject),LoginController.prototype.start=function(){this.login!=null&&this.password!=null?this.submitLogin(this.login,this.password):this.checkLogin()},LoginController.prototype.submitLogin=function(e,t){var n="update.php",r="login="+e+"&password="+t;this.listeningForResponse||(this.listeningForResponse=!0),this.statusLabel.setValue("logging in...");var i=this;ajax_post(n,function(e){i.receiveLoginFromServer(e)},r)},LoginController.prototype.checkLogin=function(){var e="update.php",t="loginStatus=1";this.statusLabel.setValue("checking login status...");var n=this;ajax_post(e,function(e){n.receiveLoginFromServer(e)},t)},LoginController.prototype.receiveLoginFromServer=function(e){e.nodeName=="result"&&e.getAttribute("status")=="1"?(this.user_id=e.getAttribute("user_id"),this.curr_map=e.getAttribute("curr_map"),this.usernameLabel.setValue(e.getAttribute("login")),this.logoutGroup.refreshLayout(),this.setLoginStatus(!0)):(this.statusLabel.setValue(e.textContent),this.setLoginStatus(!1)),this.listeningForResponse=!1},LoginController.prototype.doAction=function(e,t){e.src!="login"||t.type!="click"&&t.type!="keypress"?e.src!="guestLogin"||t.type!="click"&&t.type!="keypress"?e.src=="logout"&&t.type=="click"&&(this.statusLabel.setValue(""),this.setLoginStatus(!1),this.loginTextbox.setFocus(!0)):(this.login="guest",this.password="guest",this.submitLogin(this.login,this.password)):(this.login=this.loginTextbox.textVal,this.password=this.passwordTextbox.secretVal,window.localStorage&&(localStorage.setItem("MW_Login",this.login),localStorage.setItem("MW_Password",this.password)),this.submitLogin(this.login,this.password))},LoginController.prototype.setLoginStatus=function(e){e?(this.loginGroup.hide(),this.logoutGroup.show()):(this.user_id=null,this.tempLogin=null,this.login=null,this.tempPassword=null,this.password=null,localStorage.removeItem("MW_Login"),localStorage.removeItem("MW_Password"),this.loginTextbox.setValue(""),this.passwordTextbox.setValue(""),this.loginGroup.show(),this.logoutGroup.hide()),e!=this.loggedIn&&this.tellActionListeners(this,e?{type:"loggedIn"}:{type:"loggedOut"}),this.loggedIn=e},LoginController.prototype.getHTTPLoginString=function(){return"login="+escape(this.login)+"&password="+escape(this.password)},KevLinDev.extend(SummaryItemDisplay,RectLabel),SummaryItemDisplay.prototype.setSelectedItem=function(e){if(this.selectedItem==e)return;this.selectedItem=e;if(e!=null){var t=this.controller.model.itemFactory.makeSimpleViewItem(e);this.setContents(t)}else{var t=new SVGElement;t.cloneElement(this.controller.artwork.getElementById("noChosenItem")),this.setContents(t)}},KevLinDev.extend(ItemSelectorWindow,SVGWindow),ItemSelectorWindow.prototype.doAction=function(e,t){ItemSelectorWindow.superClass.doAction.call(this,e,t);if(!this.showing)return;t.type=="click"&&(e.src=="avatarButton"?this.setItem(this.controller.avatarGroupController.avatarList[0].avatarItem):e.src=="ItemSelectionCancel"?this.hide():e.src=="ItemSelectionOK"&&(this.hide(),this.client!=null&&this.client.userHasSelectedItem(this.selectedItem,this.itemTag)))},ItemSelectorWindow.prototype.setGridContents=function(e){var t=null;switch(this.itemType){case"topBlock":t=getTopBlockItem(e);break;case"topItem":case null:default:t=e.getTopItem()}this.setItem(t)},ItemSelectorWindow.prototype.setItem=function(e){this.controller.clearHighlightedItems(),this.selectedItem=e;if(e!=null){this.selectionArea.removeChildren();var t=this.controller.model.itemFactory.makeSimpleViewItem(e);this.itemButton=new RectButton("itemButton",0,0,t,{fill:"white",stroke:"green",rx:2,width:40,height:40},{fill:"yellow"},{fill:"orange"},5,!1),this.selectionArea.appendChild(this.itemButton),this.controller.highlightItem(e)}else this.selectionArea.removeChildren(),this.selectionArea.appendChild(this.defaultSelection);this.hide(),this.client!=null&&this.client.userHasSelectedItem(this.selectedItem,this.itemTag)},ItemSelectorWindow.prototype.setClient=
function(e,t,n,r){this.client=e,this.itemType=n,this.itemTag=r,this.setItem(t),this.itemType=="topBlock"?(this.avatarButton.hide(),this.explanationText.setValue("Select a point in the grid.")):(this.avatarButton.show(),this.explanationText.setValue("Select an item in the grid, or the avatar icon below."))},KevLinDev.extend(BlockItemWindow,SVGWindow),BlockItemWindow.prototype.setItem=function(e){var t=0;this.item!=null&&this.item.params!=null&&this.item.params.ht!=null&&(t=this.item.params.ht),this.item=this.controller.itemFactory.makeItem(e),this.item.setItemParam("ht",t),this.itemAppearance=this.controller.model.itemFactory.makeSimpleViewItem(this.item),this.itemAppearanceLabel.setContents(this.itemAppearance),this.item.addActionListener(this.itemAppearance),this.itemAppearance2=this.controller.model.itemFactory.makeSimpleViewItem(this.item),this.itemAppearanceButton.setContents(this.itemAppearance2),this.item.addActionListener(this.itemAppearance2)},BlockItemWindow.prototype.doAction=function(e,t){BlockItemWindow.superClass.doAction.call(this,e,t);if(t.type=="click"){if(e.src=="upArrowButton")this.item.setHeight(this.item.params.ht+5),this.itemAppearanceLabel.refreshLayout(),this.itemAppearanceButton.bgElement.refreshLayout();else if(e.src=="downArrowButton")this.item.params.ht>=5&&(this.item.setHeight(this.item.params.ht-5),this.itemAppearanceLabel.refreshLayout(),this.itemAppearanceButton.bgElement.refreshLayout());else{if(e.src.substring(0,2)!="i_")return;this.setItem(e.src.substring(2))}this.tellActionListeners(this.itemAppearanceButton,{type:"selected"})}},KevLinDev.extend(ItemWindow,SVGWindow),ItemWindow.prototype.setItem=function(e){if(this.item&&this.item.params&&this.item.params.itemCode==e)return;this.extrasArea.removeChildren(),this.item=this.controller.itemFactory.makeItem(e);var t=this.controller.itemFactory.makeViewItem(this.item);t.setLightLevel(1);var n=new SVGElement("g");n.appendChild(t),this.itemAppearanceLabel.setContents(n),this.item.addActionListener(t);var r=this.controller.itemFactory.makeViewItem(this.item);r.setLightLevel(1);var i=new SVGElement("g");i.appendChild(r),this.itemAppearanceButton.setContents(i),this.item.addActionListener(r),this.item.params.doesTeleport&&this.extrasArea.appendChild(this.selectTeleportButton),!this.item.params.lightStrength},ItemWindow.prototype.doAction=function(e,t){ItemWindow.superClass.doAction.call(this,e,t);if(t.type=="click")e.src.substring(0,2)=="i_"?(this.setItem(e.src.substring(2)),this.tellActionListeners(this.itemAppearanceButton,{type:"selected"})):e.src=="selectTeleportButton"&&this.teleportWindow.show();else if(t.type=="worldSelected"){this.item.params.doTeleport=t.value;var n=this.controller.visitedWorlds[t.value].map_name;this.teleportToText.setValue(n),this.selectTeleportButton.refreshLayout()}},KevLinDev.extend(LightLevelWindow,SVGWindow),LightLevelWindow.prototype.setLightLevel=function(e){this.lightLevel=e,this.labelIcon.firstChild.setAttribute("style","fill:'black';opacity:"+(1-e)),this.buttonIcon.firstChild.setAttribute("style","fill:'black';opacity:"+(1-e))},LightLevelWindow.prototype.doAction=function(e,t){LightLevelWindow.superClass.doAction.call(this,e,t),t.type=="click"&&e.src.substring(0,2)=="l_"&&(this.setLightLevel(1-parseInt(e.src.substring(2))*.2),this.tellActionListeners(this.lightAppearanceButton,{type:"selected"}))},KevLinDev.extend(EditWindow,SVGWindow),EditWindow.prototype.doAction=function(e,t){EditWindow.superClass.doAction.call(this,e,t),t.type=="closeWindow"?e.hide():t.type=="click"?e.src=="lightButton"?this.lightLevelWindow.show():e.src=="savemap"?this.controller.saveMap():e.src=="actionsWindow"?this.actionViewWindow.show():e.src=="infoWindow"?this.infoWindow.show():e.src=="blockItemButton"?this.blockItemWindow.show():e.src=="itemButton"?this.itemWindow.show():e.src=="play"&&this.controller.playLevel():t.type=="selected"?this.radioButtonGroup.setSelected(e):t.type=="dragSlider"&&e==this.zoomSlider&&this.controller.setZoom(t.position)},KevLinDev.extend(TextEditWindow,SVGWindow),TextEditWindow.prototype.doAction=function(e,t){TextEditWindow.superClass.doAction.call(this,e,t),t.type=="closeWindow"?this.tellActionListeners(this,{type:"cancelRenameWorld"}):t.type=="click"&&(e.src=="OK"?this.tellActionListeners(this,{type:"renameWorld",newWorldName:this.textbox.textVal}):e.src=="Cancel"&&this.tellActionListeners(this,{type:"cancelRenameWorld"}))},TextEditWindow.prototype.setFocus=function(){TextEditWindow.superClass.setFocus.call(this),this.textbox.setFocus()},KevLinDev.extend(AdminWindow,SVGWindow),AdminWindow.prototype.setMapName=function(e){this.worldLabel.setValue(e)},AdminWindow.prototype.doAction=function(e,t){AdminWindow.superClass.doAction.call(this,e,t);if(t.type=="closeWindow")e.hide();else if(t.type=="click"){if(e.src=="newworld")this.controller.worldChooserWindow.show();else if(e.src=="renameworld"){var n=new TextEditWindow(this.controller,"Rename World",this.worldLabel.textValue);n.addActionListener(this),this.setAble(!1),this.appendChild(n),n.setFocus()}else e.src=="editmap"?this.controller.editMode?this.controller.playLevel():this.controller.editLevel():e.src=="debug"&&(this.isDebugging=!this.isDebugging,this.controller.setDebugMode(this.isDebugging),this.isDebugging?this.debugText.setValue("Play"):this.debugText.setValue("Debug"));t.stopPropagation()}else t.type=="renameWorld"?(this.controller.gameServerInterface.renameWorld(t.newWorldName),this.setAble(!0),this.removeChild(e)):t.type=="cancelRenameWorld"?(this.setAble(!0),this.removeChild(e)):t.type=="serverWorldRenamed"&&this.setMapName(t.map_name)},KevLinDev.extend(WorldChooserWindow,SVGWindow),WorldChooserWindow.prototype.doAction=function(e,t){WorldChooserWindow.superClass.doAction.call(this,e,t);if(t.type=="click"){if(e.src.indexOf("world_")==0){var n=e.src.slice(6);this.tellActionListeners(this,{type:"worldSelected",value:n}),this.params.closeOnSelect&&this.hide()}}else if(t.type=="add")this.addWorld(t.value);else if(t.type=="clear")this.clear();else if(t.type=="serverWorldRenamed")for(var r in this.contents.childNodes){var i=this.contents.childNodes[r].firstChild;i.src=="world_"+t.map_id&&i.bgElement.setContents(new SVGElement("text",{y:12,"font-size":12},t.map_name))}},WorldChooserWindow.prototype.addWorld=function(e){if(this.params.showAccessOnly&&!e.access)return;var t=new RectButton("world_"+e.map_id,0,0,new SVGElement("text",{y:12,"font-size":12},e.map_name),{fill:"lightblue",stroke:"black",rx:2,width:80,height:16},{fill:"orange"},{fill:"red"},2,!1);t.addActionListener(this),this.contents.appendChild(t),this.scrollbarRegion.refreshLayout()},WorldChooserWindow.prototype.clear=function(){this.contents.removeChildren(),this.refreshLayout()},KevLinDev.extend(AvatarController,ActionObject),AvatarController.prototype.registerAvatar=function(){this.controller.model.registerItem(this.avatarItem)},AvatarController.prototype.attemptMoveAvatar=function(e){this.avatarItem.setDirection(e);if(this.avatarItem.cellContents==null)return;var t=0,n=0;switch(e){case"b":n=-1;break;case"r":t=-1;break;case"f":n=1;break;case"l":t=1}var r=this.controller.model.getContents(this.avatarItem.cellContents.x+t,this.avatarItem.cellContents.y+n),i=r.getTopItem();if(i.src=="GridContents")return;var s=0;this.avatarItem.params.climbHeight!=null&&(s=this.avatarItem.params.climbHeight);var o=null;this.avatarItem.params.dropHeight!=null&&(o=this.avatarItem.params.dropHeight);if(this.avatarItem.canMoveTo(i,s,o))this.moveAvatar(i);else if(i.params.isPushable){var u=i.params.elev-this.avatarItem.params.elev;if(u<20){var a=this.controller.model.getContents(this.avatarItem.cellContents.x+t*2,this.avatarItem.cellContents.y+n*2);while(a.myItems.length>0)a=a.myItems[0];var f=a.params.ht+a.params.elev-i.params.elev;f<=0&&(i.moveItem(a),i=r.getTopItem(),i.params.canStandOn&&this.moveAvatar(i))}}else(this.weildedItem==null||!this.weildedItem.useItemWith(i))&&this.avatarItem.useItemWith(i)},AvatarController.prototype.moveAvatar=function(e){if(this.avatarItem.cellContents==null)return;this.avatarItem.cellContents.tempParams.neverInWay=!1;while(e.params.isTakeable){var t=e.owner;t&&(t.removeItem(e),this.addItemToInventory(this.current_map_id,e)),e=t}e.cellContents.tempParams.neverInWay=!0,this.avatarItem.moveItem(e),this.controller.view.setCellCentre(this.avatarItem.cellContents.x,this.avatarItem.cellContents.y)},AvatarController.prototype.placeAvatar=function(){this.avatarItem.setDirection("f");var e=0,t=0,n=this.controller.model.findItemsByCode("S");n!=null&&(e=n[0].cellContents.x,t=n[0].cellContents.y);var r=this.controller.model.getContents(e,t),i=r.getTopItem();r.tempParams.neverInWay=!0,i.appendItem(this.avatarItem)},AvatarController.prototype.removeAvatar=function(){this.avatarItem.owner!=null&&(this.avatarItem.owner.removeItem(this.avatarItem),this.avatarItem.cellContents!=null&&(this.avatarItem.cellContents.tempParams.neverInWay=!1))},AvatarController.prototype.clear=function(){this.avatarItem.clearActionListeners(),this.clearInventory()},AvatarController.prototype.clearInventory=function(){this.heldItems=[],this.avatarItem.removeAllItems(),this.tellActionListeners(this,{type:"inventoryUpdated"})},AvatarController.prototype.addItemToInventory=function(e,t){t.params.isInvisible=!0,t.params.isCarried=!0,this.avatarItem.appendItem(t),t.setDirection(this.avatarItem.params.direction),this.heldItems.push({map_id:e,item:t}),this.tellActionListeners(this,{type:"inventoryUpdated"})},AvatarController.prototype.setItemSaved=function(e){for(var t=0;t<this.heldItems.length;++t)if(this.heldItems[t].item.id==e){this.heldItems[t].item.params.isSaved=!0;break}},AvatarController.prototype.removeUnsavedItems=function(){for(var e=0;e<this.heldItems.length;)this.heldItems[e].item.params.isSaved?++e:this.heldItems.splice(e,1);this.tellActionListeners(this,{type:"inventoryUpdated"})},AvatarController.prototype.resetInventoryFromXML=function(e){this.clearInventory();var t=e.getElementsByTagName("item");for(var n=0;n<t.length;n++){var r=t.item(n),i=parseInt(r.getAttribute("avatar_index"));if(i==this.avatarIndex){var s=r.getAttribute("map_id"),o=this.controller.itemFactory.makeItemFromXML(r.firstChild,this.controller.model);o.params.isSaved=!0,this.addItemToInventory(s,o)}}},AvatarController.prototype.updateFromXML=function(e){var t=e.getElementsByTagName("new");for(var n=0;n<t.length;n++){var r=t.item(n),i=r.getAttribute("item_id");this.setItemSaved(i)}},AvatarController.prototype.getSavedItemIDs=function(e){var t=[];for(var n=0;n<this.heldItems.length;++n)this.heldItems[n].map_id==e&&this.heldItems[n].item.params.isSaved&&t.push(this.heldItems[n].item.id);return t},AvatarController.prototype.getUnsavedItemHTTPString=function(){var e="";for(var t=0;t<this.heldItems.length;++t){var n=this.heldItems[t].item;if(!n.params.isSaved&&n.id!=null&&n.params.itemCode!=null&&n.params.isSaveable){var r=n.toXML(),i=(new XMLSerializer).serializeToString(r);e+="&itemId_"+t+"="+n.id+"&itemXML_"+t+"="+escape(i)+"&avatarIndex_"+t+"="+this.avatarIndex}}return e},AvatarController.prototype.copyItem=function(){return this.controller.itemFactory.makeSimpleViewItem(this.avatarItem)},AvatarController.prototype.setWeilding=function(e){if(e==this.weildedItem)return;this.weildedItem!=null&&this.weildedItem.setItemParam("isInvisible",!0),this.weildedItem=e,this.weildedItem!=null&&this.weildedItem.setItemParam("isInvisible",!1)},KevLinDev.extend(AvatarGroupController,ActionObject),AvatarGroupController.prototype.addAvatar=function(e){var t=this.avatarList.length,n=new AvatarController(this.controller,t,e);return this.avatarList.push(n),this.currentAvatar=n,n},AvatarGroupController.prototype.registerAvatars=function(){for(var e=0;e<this.avatarList.length;++e)this.avatarList[e].registerAvatar()},AvatarGroupController.prototype.attemptMoveCurrentAvatar=function(e){this.currentAvatar!=null&&this.currentAvatar.attemptMoveAvatar(e)},AvatarGroupController.prototype.placeAvatars=function(){for(var e=0;e<this.avatarList.length;++e)this.avatarList[e].placeAvatar()},AvatarGroupController.prototype.removeAvatars=function(){for(var e=0;e<this.avatarList.length;++e)this.avatarList[e].removeAvatar()},AvatarGroupController.prototype.getAvatarCentreCell=function(){return this.currentAvatar!=null&&this.currentAvatar.avatarItem!=null?this.currentAvatar.avatarItem.cellContents:null},AvatarGroupController.prototype.updateAvatarViewedCells=function(){for(var e=0;e<this.visibleCells.length;++e)this.visibleCells[e].tempParams.avatarSees=null;if(this.currentAvatar!=null&&this.currentAvatar.avatarItem!=null){this.visibleCells=[];var t=this.currentAvatar.avatarItem.params.elev+this.currentAvatar.avatarItem.params.ht;for(var e in this.currentAvatar.avatarItem.canSee.pov)for(var n in this.currentAvatar.avatarItem.canSee.pov[e]){var r=this.currentAvatar.avatarItem.canSee.pov[e][n];for(var i=0;i<r.cellContents.seenBy.length;++i){var s=r.cellContents.seenBy[i];if(s.item==this.currentAvatar.avatarItem&&s.viewType=="pov"&&s.viewElev<=t){this.visibleCells.push(r.cellContents),r.cellContents.tempParams.avatarSees=!0;break}}}return this.visibleCells}return null},AvatarGroupController.prototype.getAvatarPOV=function(){return[this.currentAvatar.avatarItem]},AvatarGroupController.prototype.clearTalkingAvatars=function(){for(var e=0;e<this.avatarList.length;++e)this.avatarList[e].avatarItem.setItemParam("speech",null,!1)},AvatarGroupController.prototype.getAvatarAt=function(e){for(var t=0;t<this.avatarList.length;++t){var n=this.avatarList[t].avatarItem;if(n!=null&&n.cellContents!=null&&n.cellContents.getLocationString()==e)return this.avatarList[t]}return null},AvatarGroupController.prototype.attackAvatar=function(e,t){e.avatarItem.setItemParam("speech","Death by "+t.params.fullname+"! Press space to restart.",!1),this.controller.endGame()},AvatarGroupController.prototype.clear=function(){for(var e=0;e<this.avatarList.length;++e)this.avatarList[e].clear()},AvatarGroupController.prototype.getUnsavedItemsHTTPString=function(){var e="";for(var t=0;t<this.avatarList.length;++t)e+=this.avatarList[t].getUnsavedItemHTTPString();return e},AvatarGroupController.prototype.updateFromXML=function(e){for(var t=0;t<this.avatarList.length;++t)this.avatarList[t].updateFromXML(e)},AvatarGroupController.prototype.getSavedItemIDs=function(e){var t=[];for(var n=0;n<this.avatarList.length;++n){var r=this.avatarList[n].getSavedItemIDs(e);t=t.concat(r)}return t},AvatarGroupController.prototype.setInventoryXML=function(e){this.xmlInventory=e,this.resetInventoryFromXML()},AvatarGroupController.prototype.resetInventoryFromXML=function(){if(this.xmlInventory!=null)for(var e=0;e<this.avatarList.length;++e)this.avatarList[e].resetInventoryFromXML(this.xmlInventory)},KevLinDev.extend(InventoryViewItem,RectButton),InventoryViewItem.prototype.setDragPosition=function(e,t){this.tellActionListeners(this,{type:"viewItemDragMove",x:e,y:t})},InventoryViewItem.prototype.setDragEnd=function(){this.tellActionListeners(this,{type:"viewItemDragEnd"})},InventoryViewItem.prototype.setSlot=function(e){this.inventorySlot!=null&&this.inventorySlot.setViewItem(null),this.inventorySlot=e,this.inventorySlot.setViewItem(this),this.resetSlotPosition()},InventoryViewItem.prototype.resetSlotPosition=function(){this.inventorySlot!=null&&this.setPosition(this.inventorySlot.x,this.inventorySlot.y)},InventoryViewItem.prototype.doAction=function(e,t){InventoryViewItem.superClass.doAction.call(this,e,t),t.type=="tagAdded"&&this.itemCopy.setItemTag(t.value)},KevLinDev.extend(InventorySlot,ActionObject),InventorySlot.prototype.isEmpty=function(){return this.viewItem==null},InventorySlot.prototype.canAcceptItem=function(e){return this.slotIndex==1&&!e.gridItem.params.canWeild?!1:this.isEmpty()},InventorySlot.prototype.setViewItem=function(e){this.viewItem=e,this.slotIndex==1&&this.inventoryWindow.setWeilding(this.viewItem==null?null:this.viewItem.gridItem)},InventorySlot.prototype.getDistance=function(e,t){return Math.sqrt((this.x-e)*(this.x-e)+(this.y-t)*(this.y-t))},KevLinDev.extend(InventoryWindow,SVGWindow),InventoryWindow.prototype.setBgImage=function(e){var t=new SVGElement;t.cloneElement(e),t.removeAttribute("display"),t.removeAttribute("style"),t.setAttribute("transform","matrix(5,0,0,5,66,188)"),this.prependChild(t)},InventoryWindow.prototype.clear=function(){this.clearAvatar(),this.clearInventory()},InventoryWindow.prototype.clearAvatar=function(){this.avatar!=null&&(this.avatar.removeActionListener(this),this.avatar=null)},InventoryWindow.prototype.clearInventory=function(){this.itemArea.removeChildren();for(var e=0;e<this.inventorySlots.length;++e)this.inventorySlots[e].setViewItem(null)},InventoryWindow.prototype.setAvatar=function(e){this.clearAvatar(),this.avatar=e,this.syncInventory(),this.avatar.addActionListener(this)},InventoryWindow.prototype.syncInventory=function(){this.clearInventory();if(this.avatar!=null)for(var e=0;e<this.avatar.heldItems.length;++e)this.tryToCarryItem(this.avatar.heldItems[e].item)},InventoryWindow.prototype.tryToCarryItem=function(e){for(var t=1;t<this.inventorySlots.length;++t)if(this.inventorySlots[slot].canAcceptItem(e)){var n=new InventoryViewItem(this,e);this.itemArea.appendChild(n),n.setSlot(this.inventorySlots[t]);break}return!1},InventoryWindow.prototype.doAction=function(e,t){InventoryWindow.superClass.doAction.call(this,e,t);if(t.type=="mousedown"&&e.src=="dragItem")dragndrop_Start(e,t,e.x,e.y);else if(t.type=="viewItemDragMove"){var n=null,r=null;for(var i=0;i<this.inventorySlots.length;++i){var s=this.inventorySlots[i].getDistance(t.x,t.y);if(n==null||s<n)n=s,r=i}var o=t.x,u=t.y;n!=null&&n<this.snapDistance&&(o=this.inventorySlots[r].x,u=this.inventorySlots[r].y),e.setPosition(o,u)}else if(t.type=="viewItemDragEnd"){var n=null,r=null;for(var i=0;i<this.inventorySlots.length;++i){var s=this.inventorySlots[i].getDistance(e.x,e.y);if(n==null||s<n)n=s,r=i}n!=null&&n<this.snapDistance?this.tryToPlaceItemInSlot(r,e)||e.resetSlotPosition():e.resetSlotPosition()}else t.type=="inventoryUpdated"&&this.syncInventory()},InventoryWindow.prototype.tryToPlaceItemInSlot=function(e,t){var n=!1;return this.inventorySlots[e].canAcceptItem(t.gridItem)&&(t.setSlot(this.inventorySlots[e]),n=!0),n},InventoryWindow.prototype.setWeilding=function(e){this.avatar!=null&&this.avatar.setWeilding(e)},GameServerInterface.prototype.renameWorld=function(e){var t="update.php",n="changemapname="+escape(e)+"&"+this.controller.loginController.getHTTPLoginString()+"&map_id="+this.controller.current_map_id;g_config.showServerTransactions&&this.controller.addInfo(n+"\n");var r=this;ajax_post(t,function(e){r.receiveRenameWorldResultFromServer(e)},n)},GameServerInterface.prototype.receiveRenameWorldResultFromServer=function(e){if(e.nodeName=="result"&&e.getAttribute("status")=="1"){var t=e.getAttribute("map_id"),n=e.getAttribute("map_name");this.controller.tellActionListeners(this.controller,{type:"serverWorldRenamed",map_id:t,map_name:n})}else alert(e.textContent)},GameServerInterface.prototype.submitLoadArtworkAndMap=function(e){var t=this;ajax_post(e,function(e,n){t.receiveArtworkFromServer(n)},null)},GameServerInterface.prototype.receiveArtworkFromServer=function(e){this.controller.artwork=e;var t=this.controller.artwork.getElementsByTagName("defs"),n=document.getElementById("defs_external");for(var r=0;r<t.length;r++)for(var i=0;i<t[r].children.length;i++)n.appendChild(t[r].children[i].cloneNode(!0));this.controller.itemFactory.artwork=e;var s=this.controller.artwork.getElementById("inventory_bg");this.controller.inventoryWindow.setBgImage(s),this.controller.setupEditArea(),this.submitLoadMap(this.controller.loginController.curr_map,!0)},GameServerInterface.prototype.submitSaveItemsAndTeleport=function(e){var t="update.php",n="saveitems=1&"+this.controller.loginController.getHTTPLoginString(),r=this.controller.avatarGroupController.getUnsavedItemsHTTPString();if(r.length==0){this.submitLoadMap(e);return}n+=r,g_config.showServerTransactions&&this.controller.addInfo(n+"\n");var i=this;ajax_post(t,function(t){i.receiveSaveItemsResultFromServer(t,e)},n)},GameServerInterface.prototype.receiveSaveItemsResultFromServer=function(e,t){e.nodeName=="result"&&e.getAttribute("status")=="1"?(console.log("save items successful: added "+e.getAttribute("added")+" deleted "+e.getAttribute("deleted")+" updated "+e.getAttribute("updated")),this.controller.avatarGroupController.updateFromXML(e),this.submitLoadMap(t,!1)):alert(e.textContent)},GameServerInterface.prototype.submitLoadMap=function(e,t){if(e==null)return;if(!this.controller.isMapSaved){alert("Can't teleport - there is unsaved data."),this.controller.editLevel();return}document.getElementById("loadingNotification").setAttribute("display","inline"),this.controller.setActive(!1);var n="update.php",r="load="+escape(e)+"&save_level=1&"+this.controller.loginController.getHTTPLoginString();this.controller.hasLoadedVisitedWorlds||(r+="&get_visit=1",this.controller.hasLoadedVisitedWorlds=!0),t&&(r+="&get_items=1"),g_config.showServerTransactions&&this.controller.addInfo(r+"\n");var i=this;ajax_post(n,function(e){i.receiveMapFromServer(e)},r)},GameServerInterface.prototype.receiveMapFromServer=function(e){document.getElementById("persMapArea").setAttribute("display","inline"),document.getElementById("loadingNotification").setAttribute("display","none");if(e.nodeName=="result"&&e.getAttribute("status")=="1"){this.controller.currentMap=null,this.controller.avatarGroupController.setInventoryXML(null);for(var t=0;t<e.children.length;++t)switch(e.children[t].nodeName){case"m":this.controller.currentMap=e.children[t];break;case"items":this.controller.avatarGroupController.setInventoryXML(e.children[t])}this.controller.setMapSavedStatus(!0),this.controller.getVisitedWorldsFromXML(e),e.hasAttribute("map_id")&&(this.controller.current_map_id=e.getAttribute("map_id")),e.hasAttribute("map_name")&&this.controller.setMapName(e.getAttribute("map_name")),this.controller.enableEditMode(e.hasAttribute("editable")&&e.getAttribute("editable")=="1"),this.controller.unsavedMap=null,this.controller.initialiseModelFromXML(),this.controller.playLevel()}else alert(e.textContent);this.controller.setActive(!0)},GameServerInterface.prototype.submitSaveMap=function(e){var t="update.php",n="save="+escape(this.controller.current_map_id)+"&map="+escape(e)+"&"+this.controller.loginController.getHTTPLoginString();g_config.showServerTransactions&&this.controller.addInfo(n+"\n");var r=this;ajax_post(t,function(e){r.sendMapToServer(e)},n)},GameServerInterface.prototype.sendMapToServer=function(e){e.nodeName=="result"&&e.getAttribute("status")=="1"?(this.controller.setMapSavedStatus(!0),this.controller.unsavedMap=null,alert("sent map OK"),e.hasAttribute("map_id")&&(this.controller.current_map_id=e.getAttribute("map_id"))):alert(e.textContent)},KevLinDev.extend(GameController,ActionObject),GameController.prototype.start=function(){this.loginController.start()},GameController.prototype.clearPlayerData=function(){this.currentMap=null,this.isMapSaved=!0,this.unsavedMap=null,this.mapSelect=null,this.highlightedItems=[],this.avatarGroupController.clear(),this.visitedWorlds=[],this.hasLoadedVisitedWorlds=!1,this.visitedWorldNotifier.tellActionListeners(this,{type:"clear"})},GameController.prototype.clearHighlightedItems=function(){for(var e=0;e<this.highlightedItems.length;++e)this.highlightedItems[e].setItemParam("isHighlighted",!1,!1);this.highlightedItems=[]},GameController.prototype.addVisitedWorld=function(e){this.visitedWorlds[e.map_id]||(this.visitedWorlds[e.map_id]=e,this.visitedWorldNotifier.tellActionListeners(this,{type:"add",value:e}))},GameController.prototype.setMapName=function(e){this.adminWindow.worldLabel.setValue(e)},GameController.prototype.highlightItem=function(e){this.highlightedItems.push(e),e.setItemParam("isHighlighted",!0,!1)},GameController.prototype.setupEditArea=function(){var e=cloneElementById(this.artwork,"iconCircleCover"),t=cloneElementById(this.artwork,"iconContract"),n=cloneElementById(this.artwork,"iconContractMouseover"),r=cloneElementById(this.artwork,"iconCircleCover"),i=cloneElementById(this.artwork,"iconExpand"),s=cloneElementById(this.artwork,"iconExpandMouseover");this.expandButton=new ParamButton2("adminExpand",{x:10,y:10,width:20,height:20,normalElements:{normal:i,mouseover:s,cover:e},selectedElements:{normal:t,mouseover:n,cover:r}}),this.expandButton.setToggle(!0),this.overLayer.appendChild(this.expandButton),this.expandButton.addActionListener(this),this.contentLayoutView=new ContentLayoutView(this.view),this.view.coverLayer2.appendChild(this.contentLayoutView),this.editWindow=new EditWindow(this,this.editLayer),this.editLayer.appendChild(this.editWindow)},GameController.prototype.saveMap=function(){if(this.loginController.loggedIn){var e=this.model.toXML();this.actionController.toXML(e);var t=(new XMLSerializer).serializeToString(e);this.gameServerInterface.submitSaveMap(t)}},GameController.prototype.setInfo=function(e){this.editWindow.infoWindowContents.setValue(e)},GameController.prototype.addInfo=function(e){this.editWindow.infoWindowContents.setValue(this.editWindow.infoWindowContents.getValue()+e)},GameController.prototype.removeSavedItemsFromMap=function(){var e=this.avatarGroupController.getSavedItemIDs(this.current_map_id);for(var t=0;t<e.length;++t){var n=this.model.getItemById(e[t]);n!=null&&n.owner!=null&&n.owner.removeItem(n)}},GameController.prototype.getVisitedWorldsFromXML=function(e){if(e==null)return;var t=e.getElementsByTagName("visit");for(var n=0;n<t.length;n++){var r=t.item(n);this.addVisitedWorld({map_id:r.getAttribute("map_id"),map_name:r.getAttribute("map_name"),owner_id:r.getAttribute("owner_id"),access:r.getAttribute("access")})}},GameController.prototype.initialiseModelFromXML=function(){var e=this.unsavedMap;e==null&&(e=this.currentMap),this.model.clear(),this.view.clear(),this.actionController.clear(),this.avatarGroupController.registerAvatars(),this.avatarGroupController.resetInventoryFromXML(),this.gameState="normal",this.turnClock.currentTime=0,this.model.fromXML(e),this.actionController.fromXML(e)},GameController.prototype.setMapSavedStatus=function(e){this.isMapSaved=e,this.editWindow.saveMapButton.setAble(!this.isMapSaved)},GameController.prototype.doAction=function(e,t){t.type=="keypress"&&t.preventDefault();if(t.type=="closeWindow")e.hide(),e.windowName=="Admin"&&(this.expandButton.isSelected=!1,this.expandButton.updateAppearance());else if(t.type=="loggedIn")this.gameServerInterface.submitLoadArtworkAndMap("images/gameGraphics.svg"),this.setActive(!0);else if(t.type=="loggedOut")this.setActive(!1),this.enableEditMode(!1),this.worldChooserWindow.hide(),this.worldChooserWindow.clear(),this.adminWindow.hide(),document.getElementById("persMapArea").setAttribute("display","none"),this.model.clear(),this.view.clear(),this.actionController.clear(),this.clearPlayerData();else if(t.type=="worldSelected")this.gameServerInterface.submitLoadMap(t.value,!1);else if(e.src=="adminExpand"&&t.type=="click")e.isSelected?this.adminWindow.show():this.adminWindow.hide();else{if(!this.isActive)return;this.editMode?this.parseEditAction(e,t):this.parseGameAction(e,t)}},GameController.prototype.parseGameAction=function(e,t){if(this.gameState=="dead"){t.type=="keypress"&&parseKeycodesAndCharcodes(t.keyCode,t.charCode)=="wait"&&(this.initialiseModelFromXML(),this.playLevel());return}if(t.type=="keypress"&&this.background.focus==null)switch(parseKeycodesAndCharcodes(t.keyCode,t.charCode)){case"up":this.avatarGroupController.attemptMoveCurrentAvatar("b"),this.stepTime();break;case"left":this.avatarGroupController.attemptMoveCurrentAvatar("r"),this.stepTime();break;case"down":this.avatarGroupController.attemptMoveCurrentAvatar("f"),this.stepTime();break;case"right":this.avatarGroupController.attemptMoveCurrentAvatar("l"),this.stepTime();break;case"wait":this.stepTime();break;case"inventory":this.inventoryWindow.showing?this.inventoryWindow.hide():this.inventoryWindow.show()}else t.type=="click"&&e.src=="editmap"&&(e.isSelected?this.editLevel():this.playLevel())},GameController.prototype.parseEditAction=function(e,t){if(e.src=="gridCell"&&t.type=="mouseover"){this.setVisibleToUser([e.modelContents],5);if(this.editWindow.infoWindow.showing){var n=e.modelContents.toXML(this.model.xmlDoc,!0);if(n!=null){var r=XML((new XMLSerializer).serializeToString(n)).toXMLString();this.setInfo(r)}else this.setInfo("null")}}else if(t.type=="click")e.src=="editmap"?e.isSelected?this.editLevel():this.playLevel():e.src=="gridCell"&&this.contentSelected(e,t);else if(t.type=="keypress"&&this.background.focus==null)switch(parseKeycodesAndCharcodes(t.keyCode,t.charCode)){case"left":this.view.setCellCentre(this.view.cellCentreX-1,this.view.cellCentreY),this.view.updateView(),this.view.removeOutsideView();break;case"up":this.view.setCellCentre(this.view.cellCentreX,this.view.cellCentreY-1),this.view.updateView(),this.view.removeOutsideView();break;case"right":this.view.setCellCentre(this.view.cellCentreX+1,this.view.cellCentreY),this.view.updateView(),this.view.removeOutsideView();break;case"down":this.view.setCellCentre(this.view.cellCentreX,this.view.cellCentreY+1),this.view.updateView(),this.view.removeOutsideView();break;case"zoom_out":break;case"zoom_in":}},GameController.prototype.setVisibleToUser=function(e,t){if(e==null)return;this.model.clearInTheWay();for(var n=0;n<e.length;++n){var r=e[n];if(r.myItems.length==0)continue;var i=t,s=getTopBlockItem(r);s!=null&&(i=s.params.elev+s.params.ht+t),r.setVisibleToUser(i),this.model.getContents(r.x,r.y-1).setVisibleToUser(i),this.model.getContents(r.x+1,r.y).setVisibleToUser(i)}},GameController.prototype.contentSelected=function(e,t){if(this.editMode&&t.shiftKey){var n=this.model.getContents(e.x_index,e.y_index);this.contentLayoutView.setContents(n)}else if(this.editMode){var n=this.model.getContents(e.x_index,e.y_index);if(this.editWindow.itemSelectorWindow.isShowing())this.editWindow.itemSelectorWindow.setGridContents(n);else if(this.editWindow.radioButtonGroup.currentSelection!=null&&this.editWindow.radioButtonGroup.currentSelection.isSelected!=0)if(this.editWindow.radioButtonGroup.currentSelection.src=="deleteButton"){var r=n.getTopItem();r.markedForDeath=!0,this.model.removeFromMoveableItems(r),r.owner!=null&&r.owner.removeItemByIndex(0),this.setMapSavedStatus(!1)}else if(this.editWindow.radioButtonGroup.currentSelection.src=="upArrowButton"){var i=getTopBlockItem(n);if(i!=null){var s=i.params.ht+5;s>60&&(s=60),i.setHeight(s,!0)}this.setMapSavedStatus(!1)}else if(this.editWindow.radioButtonGroup.currentSelection.src=="downArrowButton"){var i=getTopBlockItem(n);if(i!=null){var s=i.params.ht-5;s<0&&(s=0),i.setHeight(s,!0)}this.setMapSavedStatus(!1)}else if(this.editWindow.radioButtonGroup.currentSelection.src=="rotateLeftArrowButton"){var o=n.getTopItem();if(o!=null){var u=!0;o.rotateItem(-1,u)}this.setMapSavedStatus(!1)}else if(this.editWindow.radioButtonGroup.currentSelection.src=="rotateRightArrowButton"){var o=n.getTopItem();if(o!=null){var u=!0;o.rotateItem(1,u)}this.setMapSavedStatus(!1)}else if(this.editWindow.radioButtonGroup.currentSelection.src=="lightButton")n.setAmbientLight(this.editWindow.lightLevelWindow.lightLevel),this.setMapSavedStatus(!1);else if(this.editWindow.radioButtonGroup.currentSelection.src=="blockItemButton"){n.myItems.length==0&&n.setAmbientLight(this.editWindow.lightLevelWindow.lightLevel);var a=this.editWindow.blockItemWindow.item;this.appendItem(n.getTopItem(),a)}else if(this.editWindow.radioButtonGroup.currentSelection.src=="itemButton"){if(n.myItems.length==0)return;var a=this.editWindow.itemWindow.item;if(a.params.itemCode=="S"){var f=this.model.findItemsByCode("S");if(f!=null)for(var l=0;l<f.length;++l)f[l].owner.removeItem(f[l])}this.appendItem(n.getTopItem(),a);if(a.params.doTeleport){var c=new TeleportAction(this.model,this,a.params.doTeleport);this.actionController.appendAction(c);var h=new HasItemCondition(this.model,this,null,"tag",a,"avatar");this.actionController.registerCondition(h),c.addCondition(h)}}}},GameController.prototype.appendItem=function(e,t){var n={};for(var r in t.params)n[r]=t.params[r];var i=new PerspectiveGridItem(n);e.appendItem(i),i.params.isSaveable&&this.model.registerItem(i),i.params.moveTowards!=null&&this.model.addToMoveableItems(i),this.setMapSavedStatus(!1)},GameController.prototype.endGame=function(){this.gameState="dead"},GameController.prototype.stepTime=function(){this.actionController.clearSpeakingItems(),this.changeItems(),this.actionController.attemptActions(),this.turnClock.currentTime++,this.view.updateView(),this.view.removeOutsideView();var e=this.avatarGroupController.getAvatarPOV();this
.view.updatePOV(e);var t=this.avatarGroupController.updateAvatarViewedCells();this.setVisibleToUser(t,15)},GameController.prototype.changeItems=function(){var e={};for(var t=0;t<this.model.moveableItems.length;++t){var n=this.model.moveableItems[t].requestChange();if(n==null)continue;var r=n.cellContents.getLocationString();e[r]==null&&(e[r]=[]),e[r].push({item:this.model.moveableItems[t],dest:n})}for(var t in e){var i=this.avatarGroupController.getAvatarAt(t);if(i!=null)this.avatarGroupController.attackAvatar(i,e[t][0].item);else if(e[t].length==1){var s=e[t][0].dest.cellContents.getTopItem();e[t][0].item.moveItem(s),e[t][0].item.setDirection(e[t][0].dest.params.direction)}else e[t][0].item.setDirection(e[t][0].dest.params.direction)}},GameController.prototype.enableEditMode=function(e){this.canEdit=e,e?this.adminWindow.editMapButton.show():this.adminWindow.editMapButton.hide()},GameController.prototype.setActive=function(e){this.isActive=e},GameController.prototype.setZoom=function(e){e<.2?this.view.setFixedCellCount(4):e<.4?this.view.setFixedCellCount(8):e<.6?this.view.setFixedCellCount(12):e<.8?this.view.setFixedCellCount(20):this.view.setFixedCellCount(30),this.view.updateView()},GameController.prototype.setDebugMode=function(e){this.model.clearInTheWay(),this.editMode=e;if(e){this.model.showInvisible=!0;var t=document.getElementById("baseBG");t.setAttribute("fill","white"),gLightLevelScaleFactor=.6,this.view.updatePOV(null),this.view.setLighting(),this.editLayer.show(),this.setZoom(this.editWindow.zoomSlider.sliderPosition)}else this.playLevel()},GameController.prototype.editLevel=function(e){if(this.canEdit==0){this.playLevel();return}this.editMode=!0,this.model.clearInTheWay(),this.adminWindow.editMapButton.setContents(this.adminWindow.editMapButtonPlayText),this.model.showInvisible=!0;var t=document.getElementById("baseBG");t.setAttribute("fill","white"),gLightLevelScaleFactor=.6,e||(this.avatarGroupController.removeAvatars(),this.initialiseModelFromXML()),this.view.updateView(),this.view.updatePOV(null),this.view.setLighting(),this.editLayer.show(),this.setZoom(this.editWindow.zoomSlider.sliderPosition)},GameController.prototype.playLevel=function(){this.editMode=!1,this.model.clearInTheWay(),this.adminWindow.editMapButton.setContents(this.adminWindow.editMapButtonEditText),this.editLayer.hide(),this.isMapSaved||(this.unsavedMap=this.model.toXML()),this.clearHighlightedItems(),this.model.showInvisible=!1,gLightLevelScaleFactor=1,this.view.setLighting(),this.turnClock.currentTime=0,this.removeSavedItemsFromMap(),this.avatarGroupController.placeAvatars(),this.view.setFixedCellCount(8);var e=this.avatarGroupController.getAvatarCentreCell();e!=null&&this.view.setCellCentre(e.x,e.y),this.view.updateView();var t=this.avatarGroupController.getAvatarPOV();this.view.updatePOV(t),this.view.removeOutsideView();var n=document.getElementById("baseBG");n.setAttribute("fill","black"),this.avatarGroupController.clearTalkingAvatars(),this.stepTime()};var gController,gWindow=this;